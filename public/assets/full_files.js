var swfUpload,files={};
(function(){var a=$("#files_content"),i=$("#swfupload_holder"),k=$("#add_file_link"),j=$("#files_structure"),r=$("#files_structure_list");$.extend(files,{canManageAContext:false,init:function(){a=$("#files_content");i=$("#swfupload_holder");k=$("#add_file_link");j=$("#files_structure");r=$("#files_structure_list");a.prepend(i);files.clearDataCache.cacheIndex=0;for(var h in fileStructureData)if(fileStructureData[h]){var b=fileStructureData[h][0],d=null,e=null,c=null,f;for(f in b)if(b[f]&&f!="context_string"&&
f!="context_name"&&f!="context"){d=f;e=b[f].name;c=b[f]}fileStructureData[h][0].context_string=d+"_"+b[d].id;fileStructureData[h][0].context_name=e;if((fileStructureData[h][0].context=c)&&c.permissions&&c.permissions.manage_files)files.canManageAContext=true}a.append($("#drag_n_drop_panel"));a.append($("#content_templates .content_panel").hide());$.handlesHTML5Files&&a.bind("dragenter dragover",function(g){g.preventDefault();g.stopPropagation();g=files.currentItemData();if(!(!g||g.mime_class!="folder")){$(this).addClass("file_drag");
$("#drag_n_drop_panel").css("top",a.scrollTop())}},false).bind("dragleave dragout",function(){$(this).closest(".drag_panel").length||$(this).removeClass("file_drag")},false).bind("drop",function(g){var l=g.originalEvent.dataTransfer;if(l){var n=files.currentItemData();g.preventDefault();g.stopPropagation();$(this).removeClass("file_drag");if(!(!n||n.mime_class!="folder")){g=[];var o=l.files;for(l=0;l<o.length;l++)o[l]&&o[l].size>0&&g.push(o[l]);if(g.length===0)alert("No valid files were selected");
else{o=false;if(g.length==1&&g[0].type.match(/application\/(x-)?zip/))o=confirm("This file is a zip file.  Do you want to extract its contents into this folder?");if(o){l=g[0];var m=n.context_string+"_full_files_"+Math.round(Math.random()*999999);o=$("."+n.context_string+"_zip_import_url").attr("href");$.ajaxFileUpload({url:o,data:{zip_import_batch_id:m,folder_id:n.id,zip_file:g[0],format:"json"},method:"POST",success:function(){},error:function(){}});var p=$("<div/>");p.append("Extracting <b>"+l.name+
"</b><br/>to "+n.name+"...");p.append("<div class='progress'/>");var q=p.find(".progress");q.css("margin","10px");q.progressbar();p.dialog("close").dialog({autoOpen:false,title:"Extracting Files into Folder",close:function(){p.data("closed",true);setTimeout(function(){p.detach()},500)}}).dialog("open");var s=function(v){p.text("There were errors extracting the zip file.  Please try again.");var u=$("<ul/>"),w;for(w in v){var A=v[w],y=$("<li/>");y.text(A);u.append(y)}p.append(u)},t=function(){var v=
$("#file_context_links ."+n.context_string+"_zip_import_status_url").attr("href");v=v+"?batch_id="+m;$.ajaxJSON(v,"GET",{},function(u){if(!p.data("closed"))if(u&&u.errors)s(u.errors);else if(u&&u.complete){q.progressbar("value",100);p.append("Extraction complete!  Updating File Structure...");files.refreshContext(n.context_string,function(){p.dialog("close")})}else if(!u||u.length==0){t.blankCount=t.blankCount||0;t.blankCount++;t.blankCount>30?s(["The server stopped returning a valid status"]):setTimeout(t,
2E3)}else{t.errorCount=0;setTimeout(t,2E3);q.progressbar("value",(u.progress||0)*100)}},function(){t.errorCount=t.errorCount||0;t.errorCount++;t.errorCount>5?s(["The server stopped responding to status requests"]):setTimeout(t,2E3)})};setTimeout(t,3E3)}else for(l in g)fileUpload.queueAjaxUpload(g[l]);return false}}}},false)},context_page_view_ids:{},updatePageView:function(){},viewFile:function(h,b){var d=$("#file_context_links ."+h+"_inline_view_attachment_url").attr("href");d=$.replaceTags(d,"id",
b);$.ajaxJSON(d,"POST",{},function(){},function(){})},selectFolder:function(h){if(!(!files.selectFolder.forceRefresh&&(h.hasClass("active-node")||h.hasClass("active-leaf")))){files.selectFolder.forceRefresh=false;for(var b=h;b.parent("ul").parent("li").length>0;){b=b.parent("ul").parent("li");files.expandFolder(b)}h.children(".text:visible:first").click();j.find("li.node.active-node,li.leaf.active-leaf").length===0&&j.find("li.node:visible:first").children(".text:visible:first").click();if(files.currentItemData())!files.currentItemData().includes_files&&
files.currentItemData().full_name&&files.getFilesForFolder(files.currentItemData());else setTimeout(function(){files.selectFolder(h)},250)}},gettingFiles:{},getFilesForFolder:function(h,b){var d=h.context_string+"_"+h.id;if(!files.gettingFiles[d])if(!(j.find("li.folder_"+h.id).hasClass("folder_locked")&&(!h.context||!h.context.permissions||!h.context.permissions.manage_files)))if(h.false_folder)files.refreshContext(h.context_string,function(){files.getFilesForFolder(h,b)});else{files.gettingFiles[d]=
true;var e=$.replaceTags($("#file_context_links ."+h.context_string+"_folder_url").attr("href"),"id",h.id);$.ajaxJSON(e,"GET",{},function(c){files.gettingFiles[d]=false;var f=c.actual_folder.folder;f.includes_files=true;files.updateFolder(h.context_string,{folder:f,already_in_place:true},false);for(var g in c.files){var l=c.files[g].attachment;l&&files.updateFile(h.context_string,{attachment:l,definitely_new:true},false)}j.find(".folder_"+f.id).triggerHandler("files_load");f=a.find(".message.no_content:visible").length>
0;if(b!==false||f)b&&$.isFunction(b)?b(c):files.refreshView();k.triggerHandler("show")},function(){files.gettingFiles[d]=false})}},expandFolder:function(h){r[0]&&r[0].ExpandNode&&r[0].ExpandNode($("#files_structure_list"),h)},collapseFolder:function(h){r[0]&&r[0].CollapseNode&&r[0].CollapseNode($("#files_structure_list"),h)},fullPath:function(h){var b=[],d=files.itemData(h);for(b.unshift(d.name.replace(/\//g,"//"));h.parent("ul").parent("li").length>0;){h=h.parent("ul").parent("li");d=files.itemData(h);
b.unshift(d.name.replace(/\//g,"//"))}return b.join("/")},selectNodeFromPath:function(h){var b=files.nodeFromPath(h);files.selectFolder(b);var d=function(){b.unbind("files_load",d);b.hasClass("active-node")&&files.selectNodeFromPath(h)};b.bind("files_load",d);j.find(".node.active-node,.leaf.active-leaf").length===0&&files.selectFolder(j.find(".node:visible:first"))},nodeFromPath:function(h){try{if(j.find("#files_structure_list > li."+h).length>0)return j.find("#files_structure_list > li."+h)}catch(b){}h=
h.replace(/\/\//g,"\\").split("/");var d=j,e=true,c;for(c in h){var f=h[c].replace(/\\\\/g,"/"),g=false;e&&d.children("ul").children("li").each(function(){if($(this).children(".text.name").text()==f){d=$(this);g=true;return false}});e=g}return d},draggable_helper:function(h,b){if($(this).hasClass("folder_item"))b=$(this);else{var d=b.width();return b.clone().css("backgroundColor","#eeeeee").css("height",50).css("borderWidth",1).css("borderStyle","solid").css("borderColor","#ccc").css("width",d-50)}d=
b.clone().attr("id","file_drag");d.find(".header .sub_header").remove();d.find(".header").append("<div class='sub_header'/>");d.find(".header .sub_header").html("&nbsp;");d.addClass("file_drag");d.find(".links").remove();d.css("width",100);var e=$("<ul/>");e.addClass("files_content");e.append(d);e.addClass("true-draggable");e.css("width",200);e.css("height",50);$("#content").append(e);return e},updateQuota:function(){if($("#quota").length){var h=$(".quota_url").attr("href");$.ajaxJSON(h,"GET",{},
function(b){$("#quota").text(b.quota);$("#quota_used").text(b.quota_used)},function(){})}}});$.extend(files,{draggable_options:{handle:".draggable.item_icon",distance:5,helper:files.draggable_helper,start:function(){a.addClass("dragging")},stop:function(){setTimeout(function(){a.removeClass("dragging")},500)}},droppable_options:{accept:".file,.folder",hoverClass:"drop_target",tolerance:"pointer",drop:function(h,b){if($(b.helper).hasClass("true-draggable")){var d=$(b.draggable),e=files.itemData(d),
c=$(this),f=files.itemData($(this).parent(".folder"));f=f||files.itemData($(this));j.loadingImage();if(d.hasClass("file"))if($(b.helper).hasClass("copy_drag")){d=$("#file_context_links ."+f.context_string+"_attachments_url").attr("href");var g={"attachment[source_attachment_id]":e.id,"attachment[folder_id]":f.id};$.ajaxJSON(d,"POST",g,function(l){j.loadingImage("remove");files.updateFile(f.context_string,l,false);files.selectFolder(c);files.refreshView()},function(){j.loadingImage("remove")})}else{d=
$("#file_context_links ."+f.context_string+"_attachment_url").attr("href");d=$.replaceTags(d,"id",e.id);$.ajaxJSON(d,"PUT",{"attachment[folder_id]":f.id},function(l){j.loadingImage("remove");files.updateFile(f.context_string,l,false);files.selectFolder(c);files.refreshView()},function(){j.loadingImage("remove")})}else if($(b.helper).hasClass("copy_drag")){d=$("#file_context_links ."+f.context_string+"_folders_url").attr("href");g={"folder[source_folder_id]":e.id,"folder[parent_folder_id]":f.id};$.ajaxJSON(d,
"POST",g,function(){j.loadingImage("remove");files.refreshContext(f.root_context_string)},function(){j.loadingImage("remove")})}else{d=$("#file_context_links ."+f.context_string+"_folder_url").attr("href");d=$.replaceTags(d,"id",e.id);$.ajaxJSON(d,"PUT",{"folder[parent_folder_id]":f.id},function(){j.loadingImage("remove");files.refreshContext(e.root_context_string)},function(){j.loadingImage("remove")})}}},over:function(h,b){$(b.helper).hasClass("true-draggable")||$(this).removeClass("drop_target");
var d=files.itemData($(b.draggable)),e=files.itemData($(this).parent(".folder"));e=e||files.itemData($(this));$(b.helper).find(".header .sub_header").text("move to "+e.name);if(d&&e&&d.context_string!=e.context_string){$(b.helper).addClass("copy_drag");$(b.helper).find(".header .sub_header").html("<strong>copy</strong> to "+e.name)}},out:function(h,b){$(b.helper).removeClass("copy_drag");$(b.helper).find(".header .sub_header").html("&nbsp;")}},breadcrumb:function(){for(var h=location.hash.substring(1).replace(/\/\//g,
"\\").split("/"),b=$("<div/>"),d=[],e=0;e<h.length-1;e++){var c=$("<a/>");d.push(h[e].replace(/\\\\/g,"/"));c.attr("href","#"+d.join("/"));c.text(h[e]);b.append(c)}return b},refreshContext:function(h,b){files.refreshContext.refreshing=files.refreshContext.refreshing||{};if(!files.refreshContext.refreshing[h]){files.refreshContext.refreshing[h]=true;var d=$("#file_context_links ."+h+"_attachments_url").attr("href");$.ajaxJSON(d,"GET",{},function(e){files.clearDataCache();files.refreshContext.refreshing[h]=
false;var c=j.scrollTop(),f=null,g;for(g in fileStructureData){var l=fileStructureData[g][0];if(l.context_string==h){f=l.context_name;fileStructureData[g][0].context.includes_files=true;for(var n in e.folders)for(var o in fileStructureData[g][1].folders)if(fileStructureData[g][1].folders[o].id==e.folders[n].id)e.folders[n].includes_files=fileStructureData[g][1].folders[o].includes_files;e.files=e.files||[];for(n in fileStructureData[g][1].files)e.files.push(fileStructureData[g][1].files[n]);fileStructureData[g][1]=
e}}var m=$("#files_structure > ul > li.context."+h).filter(":first");if(m.length===0)m=null;var p=[];l=false;if(m){l=m.hasClass("open");m.find("li.node.open").each(function(){p.push(files.itemData($(this)).id)})}var q=null;for(g in e.contexts)for(n in e.contexts[g])if(!q){q=n;f=e.contexts[g][n].name}q=null;if(!e.folders&&e[0]&&e[0][1]&&e[0][1].folders)e.folders=e[0][1].folders;for(g in e.folders)if(!q&&e.folders[g].folder&&e.folders[g].folder.parent_folder_id===null)q=e.folders[g].folder;var s=m;
if(!s||s.length===0)s=j.find(".folder_blank").clone(true).removeClass("folder_blank");s.children(".name").html(f);s.children(".id").text(q.id);s.addClass("context folder folder_"+q.id+" "+h);s.find("li").addClass("to_be_removed");f=s.children("ul");var t=function(y,B){for(var z in e.folders)if(B.id&&e.folders[z].folder.parent_folder_id==B.id){var x=y.children("ul").children(".folder_"+e.folders[z].folder.id);if(x.length===0){x=j.find(".folder_blank").clone(true).removeClass("folder_blank");x.addClass("folder folder_"+
e.folders[z].folder.id);x.children(".id").text(e.folders[z].folder.id);x.children(".name").text(e.folders[z].folder.name)}x.removeClass("to_be_removed");t(x,e.folders[z].folder);x.parents("body").length===0&&y.children("ul").append(x.show())}};for(g in e.folders)if(e.folders[g].folder.parent_folder_id==q.id){m=f.find(".folder_"+e.folders[g].folder.id);if(m.length===0){m=j.find(".folder_blank").clone(true).removeClass("folder_blank");m.addClass("folder folder_"+e.folders[g].folder.id);m.children(".name").text(e.folders[g].folder.name);
m.children(".id").text(e.folders[g].folder.id)}m.removeClass("to_be_removed");t(m,e.folders[g].folder);m.parents("body").length===0&&f.append(m.show())}if(e.collaborations&&!h.match(/^user_/)){q=j.find(".folder_blank").clone(true).removeClass("folder_blank");q.addClass("collaborations");q.fillTemplateData({data:{name:"collaborations"}});for(g in e.collaborations){m=$(".collaboration_"+(e.collaborations[g].collaboration||e.collaborations[g].google_docs_collaboration||e.collaborations[g].etherpad_collaboration).id);
if(m.length===0){m=j.find(".file_blank").clone(true).removeClass("file_blank");m.addClass("collaboration_"+e.collaborations[g].collaboration.id);m.addClass("collaboration "+e.collaborations[g].collaboration.collaboration_type);m.fillTemplateData({data:{name:e.collaborations[g].collaboration.title,id:e.collaborations[g].collaboration.id}})}m.removeClass("to_be_removed");m.parents("body").length===0&&q.children("ul").append(m.show())}f.append(q.show())}q={};for(g in e.groups)q[(e.groups[g].group||e.groups[g].course_assigned_group).category]=
true;for(g in q){m=j.find(".folder_blank").clone(true).removeClass("folder_blank");m.fillTemplateData({data:{name:g}});m.addClass("groups");for(n in e.groups){var v=e.groups[n].group||e.groups[n].course_assigned_group;if(v.category==g){var u=null;for(o in e.folders)if(!u&&!e.folders[o].folder.parent_folder_id===null)u=e.folders[o].folder;if(u){var w=m.children("ul").children(".group_"+v.id);if(w.length===0){w=j.find(".folder_blank").clone(true).removeClass("folder_blank");w.addClass("group context folder folder_"+
u.id);w.addClass("group_"+v.id);w.fillTemplateData({data:{name:v.name,id:u.id}})}w.removeClass("to_be_removed");t(w,u);w.parents("body").length===0&&m.children("ul").append(w.show())}}}f.append(m.show())}var A=false;s.find(".to_be_removed").remove();j.find("#files_structure_list > .folder").each(function(){var y=files.itemData($(this));if(y&&y.root_context_string==h){if($(this)[0]!=s[0]){$(this).after(s.show());$(this).remove()}A=true}});A||j.find("#files_structure_list").append(s.show());s.children(".text").droppable(files.droppable_options);
s.find(".folder > .text").droppable(files.droppable_options);for(g in p)files.expandFolder(s.find(".folder_"+p[g]));l&&files.expandFolder(s);j.scrollTop(c);r.instTree.InitInstTree(r);j.find("li.node.active-node,li.leaf.active-leaf").filter(":first").children(".name").click();b&&$.isFunction(b)&&b()},function(){files.refreshContext.refreshing[h]=false})}},refreshContentListeners:function(){var h=files.currentContext();if(h&&h.permissions&&h.permissions.manage_files){a.find(".folder.draggable_droppable").droppable(files.droppable_options);
a.sortable("enable");a.sortable("refresh")}else a.sortable("disable").removeClass("ui-state-disabled");if(files.canManageAContext){a.find(".folder.draggable_droppable").draggable(files.draggable_options);a.find(".file").draggable(files.draggable_options)}},nodeClumpSize:25,addScrollCatcher:function(){var h=$("<li class='catcher'>&nbsp;</li>");if(!files.watchingScroll){a.bind("scroll",function(){var b=a.find(".catcher:visible:first");if(b.length>0){b=b.offset().top;var d=a.offset().top+a.height();
if(b<d){b=a.scrollTop();d=0;a.find(".catcher").remove();var e=a.find(".folder_item:visible:last").data("node");if(e){e=e.next();for(var c=false;e.length>0;){if(!e.hasClass("separator")){d++;if(d<=files.nodeClumpSize)files.addContentItem(e);else c=true}e=e.next()}files.refreshContentListeners();c&&files.addScrollCatcher()}a.scrollTop(b)}}});files.watchingScroll=true}a.append(h)},addContentItem:function(h,b){var d=files.itemData(h);if(d&&d.id){var e=false;if(h.hasClass("node")){var c=a.find(".folder_"+
d.id);if(c.length===0){e=true;c=$("#content_templates .folder:first").clone(true);b&&c.hide();c.fillTemplateData({data:d});c.data("parent_node",h.parent().parent());var f=$.replaceTags($("."+d.context_string+"_folder_url").attr("href"),"id",d.id);c.find(".rename_item_link,.delete_item_link,.folder_url").attr("href",f);c.addClass("folder_"+d.id);c.find(".item_icon.draggable").attr("title","Click and drag to move folder to another folder");c.data("node",h)}c.toggleClass("editable_folder_item",!!(!h.hasClass("context")&&
(d.context&&d.context.permissions&&d.context.permissions.manage_files||d.permissions&&d.permissions.update)));c.removeClass("to_be_removed");c.find(".item_icon").toggleClass("draggable",c.hasClass("editable_folder_item"));c.find(".item_icon").attr("alt","Folder").attr("src",$("#content_blank_icon").attr("src"));d&&d.currently_locked&&c.find(".item_icon").attr("alt","Locked Folder").attr("src",$("#content_locked_icon").attr("src"));c.find(".lock_item_link").showIf(!d.currently_locked);c.find(".unlock_item_link").showIf(d.currently_locked);
c.toggleClass("folder_locked",!!(d&&d.currently_locked));c.toggleClass("draggable_droppable",h.hasClass("folder")&&!h.hasClass("context"))}else if(h.hasClass("collaboration")){c=a.find(".collaboration_"+d.id);if(c.length===0){e=true;c=$("#content_templates .collaboration:first").clone(true);b&&c.hide();c.fillTemplateData({data:d});c.data("parent_node",h.parent().parent());c.data("node",h);f=$.replaceTags($("."+d.context_string+"_collaboration_url").attr("href"),"id",d.id);c.find(".collaboration_url").attr("href",
f);c.addClass("collaboration_"+d.id);c.addClass(d.collaboration_type)}c.toggleClass("editable_folder_item",!!(d.permissions&&d.permissions.update));c.removeClass("to_be_removed");c.find(".item_icon").attr("alt","Collaboration").attr("src",$("#content_blank_icon").attr("src"))}else{c=a.find(".file_"+d.id);if(c.length===0){e=true;c=$("#content_templates .file:first").clone(true);b&&c.hide();c.fillTemplateData({data:d});c.data("parent_node",h.parent().parent());c.data("node",h);f=$.replaceTags($("#file_context_links ."+
d.context_string+"_attachment_url").attr("href"),"id",d.id);var g=$.replaceTags($("#file_context_links ."+d.context_string+"_download_attachment_url").attr("href"),"id",d.id);c.addClass("file_"+d.id);c.addClass(d.mime_class);c.find(".attachment_url").attr("href",f);c.find(".download_url").attr("href",g);c.find(".item_icon.draggable").attr("title","Click and drag to move file to another folder")}c.toggleClass("editable_folder_item",!!(d.context&&d.context.permissions&&d.context.permissions.manage_files||
d.permissions&&d.permissions.update));c.removeClass("to_be_removed");c.find(".item_icon").attr("alt","File").attr("src",$("#content_blank_icon").attr("src"));d&&d.currently_locked&&c.find(".item_icon").attr("alt","Locked File").attr("src",$("#content_locked_icon").attr("src"));c.find(".lock_item_link").showIf(!d.currently_locked);c.find(".unlock_item_link").showIf(d.currently_locked);c.find(".preview_item_link").showIf(d.scribd_doc||d.content_type.match(/image/)||d.content_type.match(/(video|audio)/)&&
d.media_entry_id);c.find(".edit_item_content_link_holder").showIf(c.hasClass("editable_folder_item")&&d.context_type!="User"&&(c.hasClass("text")||c.hasClass("html")||c.hasClass("code")));c.find(".item_icon").toggleClass("draggable",c.hasClass("editable_folder_item"))}e&&a.append(c);return e}},reorderContent:function(h,b){for(var d=[],e=[],c=0;c<b.length;c++)if(b[c].attachment)d.push(b[c]);else b[c].folder&&e.push(b[c]);j.find(".folder_"+h).each(function(){var f=$(this),g=[],l=[];f.children("ul").children("li").each(function(){$(this).hasClass("file")?
l.push($(this)):g.push($(this))});l=l.sort(function(o,m){var p=files.itemData(o),q=files.itemData(m);return p.position-q.position});for(var n in l){f.children("ul").append(l[n].prev(".separator"));f.children("ul").append(l[n])}g=g.sort(function(o,m){var p=files.itemData(o)||{};return((files.itemData(m)||{}).position||0)-(p.position||0)});for(n in g){f.children("ul").prepend(l[n].prev(".separator"));f.children("ul").prepend(l[n])}});files.refreshView()},updateCollaboration:function(h,b,d){var e=$.underscore(b.collaboration.context_type)+
"_"+b.collaboration.context_id,c;for(c in fileStructureData)if(fileStructureData[c]&&(fileStructureData[c][0].context_string==h||fileStructureData[c][0].context_string==e)){var f=false,g;for(g in fileStructureData[c][1].collaborations){var l=fileStructureData[c][1].collaborations[g].collaboration;if(l.id==b.collaboration.id){fileStructureData[c][1].collaborations[g]=b;j.find(".collaboration_"+l.id).each(function(){files.itemData($(this).parent("ul").parent("li"));$(this).fillTemplateData({data:{name:b.collaboration.title}})});
f=true}}if(!f){l=b.collaboration;fileStructureData[c][1].collaborations.push(b);f=j.find(".file_blank").clone(true).removeClass("file_blank");f.removeClass("file");f.addClass("collaboration collaboration_"+l.id+" "+l.collaboration_type);l.name=l.title;f.fillTemplateData({data:l});j.find("."+h+" .collaborations").children("ul").prepend(f.show())}}if(d!==false){files.refreshView(b.attachment);r.instTree.InitInstTree(r)}},updateFile:function(h,b,d){files.clearDataCache();var e=$.underscore(b.attachment.context_type)+
"_"+b.attachment.context_id,c;for(c in fileStructureData)if(fileStructureData[c]&&(fileStructureData[c][0].context_string==h||fileStructureData[c][0].context_string==e)){var f=false,g=false;if(!b.definitely_new)for(var l in fileStructureData[c][1].files){var n=fileStructureData[c][1].files[l].attachment;if(n.id==b.attachment.id){fileStructureData[c][1].files[l]=b;j.find(".file_"+n.id).each(function(){if(files.itemData($(this).parent("ul").parent("li")).id==b.attachment.folder_id)$(this).fillTemplateData({data:{name:b.attachment.display_name}});
else g=true});f=true;g&&j.find(".file_"+n.id).remove()}}if(!f||g){n=b.attachment;if(!f){b.definitely_new=false;fileStructureData[c][1].files.push(b)}f=j.find(".file_blank").clone(true).removeClass("file_blank");f.addClass("file_"+n.id);f.addClass(n.mime_class);n.name=n.display_name;f.fillTemplateData({data:n});j.find(".folder_"+n.folder_id).children("ul").append(f.show())}}if(d!==false){files.refreshView(b.attachment);r.instTree.InitInstTree(r)}},updateFolder:function(h,b,d){files.clearDataCache();
var e=$.underscore(b.folder.context_type)+"_"+b.folder.context_id,c=b.already_in_place;b.already_in_place=null;for(var f in fileStructureData)if(fileStructureData[f]&&(fileStructureData[f][0].context_string==h||fileStructureData[f][0].context_string==e)){var g=false,l=false,n;for(n in fileStructureData[f][1].folders){var o=fileStructureData[f][1].folders[n].folder;if(o.id==b.folder.id){if(o.includes_files)b.folder.includes_files=o.includes_files;fileStructureData[f][1].folders[n]=b;j.find(".folder_"+
o.id).each(function(){var m=files.itemData($(this).parent("ul").parent("li"));m=m||{parent_folder_id:null};if(m.id==b.folder.parent_folder_id){$(this).hasClass("context")||$(this).children(".name").text(b.folder.name);if(!c){$(this).prev("li.separator").remove();var p=$(this).parent("ul").parent("li"),q=null,s=$(this);p.children("ul").children("li:not(.separator)").each(function(){var t=files.itemData($(this)).position;if($(this)[0]!=s[0]&&(!$(this).hasClass("folder")||t>=m.position)){q=$(this);return false}});
if(q){q.before($(this).show());q.before("<li class='separator'/>")}else{p.children("ul").append("<li class='separator'/>");p.children("ul").append($(this).show())}}}else l=true});g=true;l&&j.find(".folder_"+o.id).remove()}}if(!g||l){files.foldersStillLoading=files.foldersStillLoading||{};files.foldersStillLoading[b.folder.id]=b;files.refreshContext(h);h!=e&&files.refreshContext(e)}}d!==false&&files.refreshView(b.folder)},refreshView:function(h){j.find("li.node.active-node,li.leaf.active-leaf").filter(":first").children(".text:visible:first").click();
if(h&&h.id){a.find(".file_"+h.id).mouseover();a.find(".folder_"+h.id).mouseover()}k.triggerHandler("show")},currentItemData:function(){return files.itemData(j.find("li.node.active-node,#files_structure li.leaf.active-leaf"))},currentContext:function(){var h=files.currentItemData().context_string,b;for(b in fileStructureData)if(fileStructureData[b][0].context_string==h)return fileStructureData[b][0].context;return null},clearDataCache:function(){files.clearDataCache.cacheIndex++},itemData:function(h){var b=
h.data("item_data");if(b&&b.cacheIndex==files.clearDataCache.cacheIndex)return b;if(b=files.uncachedItemData(h)){b.cacheIndex=files.clearDataCache.cacheIndex;h.data("item_data",b)}return b},uncachedItemData:function(h){if(h.closest("#files_content").length>0)return files.itemData(h.data("node"));var b=h.getTemplateData({textValues:["id"]}).id,d;for(d in fileStructureData){var e=fileStructureData[d];if(h.hasClass("file")){var c=e[1].files,f;for(f in c){var g=c[f].attachment;if(g.id==b){g.context_string=
$.underscore(g.context_type)+"_"+g.context_id;g.root_context_string=e[0].context_string;g.context=e[0].context;g.name=g.display_name;return g}}}else if(h.hasClass("collaborations")){if(h.parents("li.context:last").hasClass(e[0].context_string)){res=h.getTemplateData({textValues:["name"]});res.context_string=e[0].context_string;res.context=e[0].context;return res}}else if(h.hasClass("groups")){if(h.parents("li.context:last").hasClass(e[0].context_string)){res=h.getTemplateData({textValues:["name"]});
res.context_string=e[0].context_string;res.context=e[0].context;return res}}else if(h.hasClass("collaboration")){c=e[1].collaborations;for(f in c){g=c[f].collaboration;if(g.id==b){g.context_string=$.underscore(g.context_type)+"_"+g.context_id;g.root_context_string=e[0].context_string;g.name=g.title;return g}}}else if(h.hasClass("folder")){c=e[1].folders;for(f in c){g=c[f].folder;if(g.id==b){g.context_string=$.underscore(g.context_type)+"_"+g.context_id;g.root_context_string=e[0].context_string;if(h.hasClass("context"))g.name=
h.getTemplateData({textValues:["name"]}).name;g.context=e[0].context;return g}}}else if(h.hasClass("group")){c=e[1].groups;for(f in c){g=c[f].group||c[f].course_assigned_group;g.context_string=$.underscore(g.context_type)+"_"+g.context_id;g.root_context_string=e[0].context_string;if(g.id==b)return g}}}if(h.hasClass("folder")){e=null;for(d in fileStructureData)if(h.closest(".context").hasClass(fileStructureData[d][0].context_string))e=fileStructureData[d];for(d in files.foldersStillLoading)if(files.foldersStillLoading[d].folder.id==
b){g=files.foldersStillLoading[d].folder;g.name=h.getTemplateData({textValues:["name"]}).name;g.context_string=e[0].context_string;g.context=e[0].context;return g}if(e){g={};g.name=h.getTemplateData({textValues:["name"]}).name;g.id=b;g.context_string=e[0].context_string;g.permissions={read_contents:true};g.context=e[0].context;g.false_folder=true;return g}}return null}});$(document).ready(function(){files.init();setInterval(function(){k.triggerHandler("show")},1E3);$(".folder_item").live("mousedown",
function(b){b.preventDefault()});$(".folder_item.ui-draggable").live("mouseover",function(){$(this).find(".item_icon").attr("title","Drag to move to a different folder")});k.bind("show",function(){var b=k.width(),d=k.height(),e=k.offset(),c=a.offset();e.left-=c.left;e.top-=c.top;i.css({width:b+5,height:d+5,top:e.top-5,left:e.left-5})});$("#file_uploads_dialog_link").click(function(b){b.preventDefault();$("#file_uploads").dialog("close").dialog({autoOpen:false,title:"File Uploads Queue"}).dialog("open")});
setTimeout(function(){j.find(".folder > .text").droppable(files.droppable_options);a.sortable({distance:5,cancel:".draggable.item_icon",items:"li.file,li.folder",axis:"y",hoverClass:"lameness",containment:"parent",start:function(){a.addClass("dragging")},stop:function(){setTimeout(function(){a.removeClass("dragging")},500)},helper:files.draggable_helper,update:function(b,d){var e=files.itemData($(d.item)),c=[],f=[],g=a.find(".file:first"),l=a.find(".folder_item"),n=l.index(g);a.find(".folder").each(function(){l.index($(this))>
n&&g.before($(this));var p=files.itemData($(this)).id;c.push(p)});a.find(".file").each(function(){var p=files.itemData($(this)).id;f.push(p)});a.loadingImage();var o={order:f.join(","),folder_id:e.folder_id||e.parent_folder_id,folder_order:c.join(",")},m=$("#file_context_links ."+e.context_string+"_reorder_attachments_url").attr("href");$.ajaxJSON(m,"POST",o,function(p){a.loadingImage("remove");for(var q in p)if(p[q].attachment)files.updateFile(e.context_string,p[q],false);else p[q].folder&&files.updateFolder(e.context_string,
p[q],false);files.reorderContent(e.folder_id,p);files.refreshView(e)},function(){a.loadingImage("remove")})}});$("#files_structure_list > li").hide();r.instTree({autoclose:false,multi:false,dragdrop:false,onExpand:function(b){if(b.hasClass("folder"))(b=files.itemData(b))&&!b.includes_files&&files.getFilesForFolder(b,false)},onCollapse:function(b){b.find(".node.active-node,.leaf.active-leaf").length>0&&b.find(".text:visible:first").click()},onClick:function(b,d){a.find(".content_panel").addClass("to_be_hidden");
a.find(".folder_item").addClass("to_be_removed");a.find(".catcher").addClass("to_be_removed");a.find(".file_preview").remove();a.find(".message").remove();var e=function(){a.find(".content_panel.to_be_hidden").hide();a.find(".catcher.to_be_removed").remove();a.find(".folder_item.to_be_removed").remove()},c=files.itemData(d),f=encodeURIComponent(files.fullPath(d));location.hash!="#"+f&&location.replace("#"+f);i.css("left",-1E3);!c.includes_files&&c.full_name&&files.getFilesForFolder(c);if(c.context_string){if(INST)INST.interaction_context=
c.context_string;files.updatePageView(c.context_string)}if(d.hasClass("node")){var g=$.replaceTags($("."+c.context_string+"_folder_url").attr("href"),"id",c.id),l=false,n=$("<li class='message'>Nothing in this Folder</li>");if(d.hasClass("folder"))if(!c||!c.permissions||!c.permissions.read_contents){a.find(".content_panel:last").after("<li class='message'>You cannot read the contents of this folder.</li>");l=true}else{f=$("#folder_panel");f.find(".rename_item_link,.delete_item_link,.folder_url").attr("href",
g);f.find(".breadcrumb").empty().append(files.breadcrumb());f.toggleClass("editable_content_panel",!!(c.context&&c.context.permissions&&c.context.permissions.manage_files||c.permissions&&c.permissions.update)).toggleClass("addable_content_panel",!!(c.context&&c.context.permissions&&c.context.permissions.manage_files||c.permissions&&c.permissions.update));f.removeClass("to_be_hidden");f.find(".download_zip,.upload_zip").hide();if(d.hasClass("context")||!(c&&c.permissions&&c.permissions.update))f.removeClass("editable_content_panel");
g=$.replaceTags($("."+c.context_string+"_folder_url").attr("href")+"/download","id",c.id);$(".download_zip_link").attr("href",g);$(".upload_zip_link").attr("href",$("."+c.context_string+"_import_url").attr("href")+"?return_to="+encodeURIComponent(location.href)+"&folder_id="+c.id);c.unlock_at_string=$.parseFromISO(c.unlock_at).datetime_formatted;c.lock_at_string=$.parseFromISO(c.lock_at).datetime_formatted;f.find(".lock_after").showIf(c.lock_at);f.find(".lock_until").showIf(c.unlock_at);f.find(".currently_locked_box").showIf(c.currently_locked);
f.find(".lock_item_link").showIf(c.parent_folder_id&&!c.currently_locked);f.find(".unlock_item_link").showIf(c.parent_folder_id&&c.currently_locked);f.find(".download_zip").showIf(c.permissions&&c.permissions.read_contents);f.find(".upload_zip").showIf(c.context&&c.context.permissions&&c.context.permissions.manage_files&&c.context_type&&c.context_type=="Course");f.find(".edit_link").showIf(c.context&&c.context.permissions&&c.context.permissions.manage_files);f.fillTemplateData({data:c});f.data("node",
d);f.show();k.triggerHandler("show")}else if(d.hasClass("collaborations")){f=$("#collaborations_panel");g=c.context;f.find(".header .name").text(g.name);f.find(".breadcrumb").empty().append(files.breadcrumb());var o=$("."+c.context_string+"_collaborations_url").attr("href");f.find(".collaborations_link").attr("href",o);f.find(".add_collaboration_link").attr("href",o);f.find(".view_collaborations").showIf(g&&g.permissions&&g.permissions.manage_grades);f.removeClass("to_be_hidden");f.toggleClass("addable_content_panel",
!!(c.context&&c.context.permissions&&c.context.permissions.create_collaborations));f.data("node",d);f.show()}else if(d.hasClass("groups")){f=$("#groups_panel");g=c.context;o=$("."+c.context_string+"_groups_url").attr("href");f.find(".category_name").text(c.name);f.find(".context_name").text(g.name);f.find(".breadcrumb").empty().append(files.breadcrumb());f.find(".groups_link").attr("href",o);f.removeClass("to_be_hidden");g&&g.permissions&&g.permissions.read_roster&&f.toggleClass("addable_content_panel",
true);f.show()}if(!l){var m=0,p=d.children("ul").children("li.node,li.leaf").length;e.already_cleared=true;setTimeout(function(){var t=false;d.children("ul").children("li.node,li.leaf").each(function(){m++;if(m<files.nodeClumpSize)if(newItem=files.addContentItem($(this),true))t=true});a.find("li.folder_item").show();p>=files.nodeClumpSize&&files.addScrollCatcher();t&&files.refreshContentListeners();if(d.children("ul").children("li.node,li.leaf").length===0||d.hasClass("folder")&&!c.includes_files){if(d.hasClass("folder")&&
!c.includes_files){n.addClass("no_content");n.text("Loading Files...");files.getFilesForFolder(c,function(v){v.files.length>0?files.refreshView():a.find(".message.no_content").remove()})}if(a.find(".message.no_content").length===0){d.hasClass("collaborations")&&n.html('<div class="ui-state-highlight" style="padding:1em;"><p>Collaborations are a way for you to use web-based tools like <a href="http://docs.google.com">Google Docs</a> and <a href="http://www.etherpad.org">EtherPad</a> to work collaboratively on tasks like group papers or note-taking.  This is a special folder that shows you any collaborations you have createdso you have an easy place to keep track of and create those collaborations</p><p>To find out more about a particular type of collaboration, click &quot;New collaboration&quot;and then choose that type in the dropdown list.</p></div><p>There are no collaborations to show</p>');
a.append(n)}}e()},10)}}else if(d.hasClass("file")){f=$("#file_panel");l=null;c.unlock_at_string=$.parseFromISO(c.unlock_at).datetime_formatted;c.lock_at_string=$.parseFromISO(c.lock_at).datetime_formatted;f.find(".lock_after").showIf(c.lock_at);f.find(".lock_until").showIf(c.unlock_at);f.find(".currently_locked_box").showIf(c.currently_locked);f.find(".lock_item_link").showIf(!c.currently_locked);f.find(".unlock_item_link").showIf(c.currently_locked);f.removeClass("to_be_hidden");f.fillTemplateData({data:c});
o=$.replaceTags($("#file_context_links ."+c.context_string+"_attachment_url").attr("href"),"id",c.id);g=$.replaceTags($("#file_context_links ."+c.context_string+"_download_attachment_url").attr("href"),"id",c.id);f.find(".breadcrumb").empty().append(files.breadcrumb());f.find(".attachment_url").attr("href",o).end().find(".download_item_link").attr("href",g);f.removeClass("editable_content_panel");c&&c.permissions&&c.permissions.update&&f.addClass("editable_content_panel");f.removeClass("panel_locked");
if(!c||!c.permissions||!c.permissions.download)f.addClass("panel_locked");else if(c&&c.scribd_doc&&c&&c.permissions.download){l=$("#content_templates .file_scribd_preview").clone(true);l.append("<div id='scribd_preview'/>")}else if(c&&c.content_type.match(/image/)){l=$("#content_templates .file_image_preview").clone(true);o=$.replaceTags($("#file_context_links ."+c.context_string+"_preview_attachment_url").attr("href"),"id",c.id);l.find("a").attr("href",g);l.find("img").attr("src",$(".preview_loading_image").attr("src")).attr("src",
o||"").attr("title",c.display_name)}else{if(c&&c.content_type.match(/(video|audio)/)&&c.media_entry_id){l=$("#content_templates .file_media_preview").clone(true);l.fillTemplateData({data:c});o=c.content_type.match(/video/)?"video":"audio";l.find(".media_preview").mediaComment("show_inline","maybe",o,g)}else{l=$("#content_templates .file_no_preview").clone(true);l.fillTemplateData({data:c})}l.find("a").attr("href",g)}f.data("node",d);f.show();if(l){l.addClass("file_preview");a.append(l);if(c.scribd_doc&&
c.permissions&&c.permissions.download){var q=scribd.Document.getDoc(c.scribd_doc.attributes.doc_id,c.scribd_doc.attributes.access_key);$.each({jsapi_version:1,disable_related_docs:true,auto_size:false,height:"100%"},function(t,v){q.addParam(t,v)});q.write("scribd_preview");files.viewFile(c.context_string,c.id)}}$(window).triggerHandler("resize")}else if(d.hasClass("collaboration")){f=$("#collaboration_panel");f.find(".header .name").text(c.name);f.removeClass("to_be_hidden");o={name:c.name,updated_at:$.parseFromISO(c.updated_at).datetime_formatted,
collaborator_count:(c.collaborator_ids||"").split(",").length,description:c.description,collaborator_ids:c.collaborator_ids};f.find(".breadcrumb").empty().append(files.breadcrumb());var s=$("."+c.context_string+"_collaboration_url").attr("href");s=$.replaceTags(s,"id",c.id);f.find(".collaborations_link").attr("href",s);f.find(".edit_collaboration_link").attr("href",s);f.find(".delete_collaboration_link").attr("href",s);f.find(".view_item_link").attr("href",s);f.data("node",d);g=$("#collaboration_sub_panel");
g.find(".subcontent").fillTemplateData({data:o});g.removeClass("to_be_hidden");g.find(".subcontent .collaboration_icon").hide();g.find(".subcontent .google_docs_icon").showIf(c.collaboration_type=="google_docs");g.find(".subcontent .etherpad_icon").showIf(c.collaboration_type=="etherpad");g.find(".view_item_link").attr("href",s);g.find(".collaborators").empty();o=(o.collaborator_ids||[]).split(",");for(l in o){s=$("."+c.context_string+"_user_list:first .collaborator_"+o[l]).clone(true);s.find(":checkbox").remove();
g.find(".collaborators").append(s)}a.find(".content_panel:last").after(g);f.show();f.removeClass("editable_content_panel");c&&c.permissions&&c.permissions.update&&f.addClass("editable_content_panel")}e.already_cleared||e()}});$("#files_structure_list > li.context").show();$("#files_structure_list .context").length==1&&files.expandFolder($("#files_structure_list .context"))},500);$(window).bind("resize",function(){var b=j.offset().top;b=$(window).height()-b;var d=$("#section-tabs").height();j.height(Math.max(d,
b-142));a.height(Math.max(d,b-142));b=a.height();d=$("#file_panel").outerHeight();$("#scribd_preview").height(b-d)});$(".folder_item .edit_collaboration_link, #collaboration_panel .edit_collaboration_link").click(function(b){b.preventDefault();b.stopPropagation();$("#edit_collaboration_form").attr("action",$(this).attr("href"));$("#edit_collaboration_form").attr("method","PUT");$("#edit_collaboration_form .submit_button").text("Update Collaboration");$("#edit_collaboration_form .add_collaboration").hide();
if(!(a.find(".add_form:visible").length>0)){a.children(".message").remove();b=files.itemData($(this).parents(".folder_item,#collaboration_panel"));var d=b.context_string;$("#edit_collaboration_dialog").data("context_string",d);d=$("."+d+"_user_list:first").clone(true);var e=(b.collaborator_ids||"").split(",");$("#edit_collaboration_form").fillFormData(b,{object_name:"collaboration"});d.find(".collaborator input").each(function(){$(this).attr("id",$(this).attr("class"));var c=$(this).parent("li.collaborator").getTemplateData({textValues:["user_id"]}).user_id;
$.inArray(c,e)!=-1&&$(this).attr("checked",true)});$("#edit_collaboration_dialog .collaborator_list").empty().append(d);$("#edit_collaboration_dialog").dialog("close").dialog({autoOpen:false,title:"Edit Collaboration",width:500}).dialog("open")}});$("#collaborations_panel .add_collaboration_link").click(function(b){b.preventDefault();$("#edit_collaboration_form").attr("action",$(this).attr("href"));$("#edit_collaboration_form").attr("method","POST");$("#edit_collaboration_form .submit_button").text("Add Collaboration");
$("#edit_collaboration_form .add_collaboration").show();$("#collaboration_collaboration_type").triggerHandler("change");if(!(a.find(".add_form:visible").length>0)){a.children(".message").remove();b=files.itemData($("#collaborations_panel").data("node"));b.title="";b.description="";$("#edit_collaboration_form").fillFormData(b,{object_name:"collaboration"});b=b.context_string;$("#edit_collaboration_dialog").data("context_string",b);b=$("."+b+"_user_list:first").clone(true);b.find(".collaborator input").each(function(){$(this).attr("id",
$(this).attr("class"))});$("#edit_collaboration_dialog .collaborator_list").empty().append(b);$("#edit_collaboration_dialog").dialog("close").dialog({autoOpen:false,title:"Add New Collaboration",width:500}).dialog("open")}});$("#folder_panel .download_zip").click(function(b){b.preventDefault();INST.downloadFolderFiles($(this).find(".download_zip_link").attr("href"))});$("#edit_collaboration_dialog").find(".select_all_link,.deselect_all_link").click(function(b){b.preventDefault();var d=$(this);$("#edit_collaboration_dialog .collaborator_list :checkbox").each(function(){$(this).attr("checked",
d.hasClass("select_all_link"))})});$("#edit_collaboration_dialog .cancel_button").click(function(){$("#edit_collaboration_dialog").dialog("close")});$("#edit_collaboration_form").formSubmit({beforeSubmit:function(){$(this).loadingImage()},success:function(b){var d=$("#edit_collaboration_dialog").data("context_string");$("#edit_collaboration_dialog").dialog("close");files.updateCollaboration(d,b);$(this).loadingImage("remove")},error:function(b){$(this).loadingImage("remove");$(this).formErrors(b)}});
$("#collaboration_collaboration_type").change(function(){$("#edit_collaboration_dialog .collaboration_description").hide();$("#edit_collaboration_dialog #"+$(this).val()+"_description").show();$("#edit_collaboration_dialog .collaborate_data").show();$("#edit_collaboration_dialog .collaboration_authorization").hide();if($(this).val()=="google_docs"&&$("#edit_collaboration_dialog #collaborate_authorize_google_docs").length>0){$("#edit_collaboration_dialog .collaborate_data").hide();$("#edit_collaboration_dialog #collaborate_authorize_google_docs").show()}}).triggerHandler("change");
$(".folder_item .edit_item_content_link").click(function(b){b.preventDefault();b.stopPropagation();b=$(this).parents(".folder_item,#file_panel,#folder_panel");var d=files.itemData(b),e=b.find(".download_url").attr("href"),c=b.find(".name:first").text(),f=$("#edit_content_dialog");f.data("update_url",b.find(".rename_item_link").attr("href")).data("content_type",d.content_type||"").data("filename",d.filename||"");f.find(".display_name").text(c);f.find(".loading_message").text("Loading File Contents...").show().end().find(".content").hide();
f.dialog("close").dialog({autoOpen:false,width:600,height:400}).dialog("open");$.ajax({dataType:"json",error:function(){f.find(".loading_message").text("Error Loading File Contents.  Please try again.")},success:function(g){g=g.body;f.find("textarea").val(g);f.find(".loading_message").hide().end().find(".content").show();f.find(".textarea").focus()},url:e.replace(/\/download/,"/contents")})});$("#edit_content_dialog .cancel_button").click(function(){$("#edit_content_dialog").dialog("close")});$("#edit_content_dialog .save_button").click(function(){var b=
$("#edit_content_dialog");b.find("button").attr("disabled",false).filter(".save_button").text("Update File");b.find("button").attr("disabled",true).filter(".save_button").text("Updating File...");var d=files.currentItemData().context_string;$.ajaxFileUpload({url:b.data("update_url"),method:"PUT",data:{"attachment[uploaded_data]":{fake_file:true,name:b.data("filename"),content_type:b.data("content_type"),content:b.find("textarea").val()}},success:function(e){b.find("button").attr("disabled",false).filter(".save_button").text("Update File");
files.updateFile(d,e);b.dialog("close")},error:function(){b.find("button").attr("disabled",false).filter(".save_button").text("Updating File Failed, please try again")}})});$(".folder_item .preview_item_link").click(function(b){b.preventDefault();b.stopPropagation();files.selectFolder($(this).parents(".folder_item").data("node"))});$(".folder_item .rename_item_link,#file_panel .rename_item_link,#folder_panel .rename_item_link").click(function(b){b.preventDefault();b.stopPropagation();b=$(this).parents(".folder_item,#file_panel,#folder_panel");
var d=b.getTemplateData({textValues:["name"]}).name;b.find(".name").hide().after($("#rename_entry_field"));$("#rename_entry_field").val(d).focus().select();$(this).blur()});$("#rename_entry_field").bind("blur",function(b,d){var e=$(this).parents(".folder_item,#file_panel,#folder_panel");if(e.length!==0){var c=e.getTemplateData({textValues:["name"]}).name,f=$(this).val();if(d!==false&&c!=f){e.find(".name").text(f);c=files.itemData(e.data("node"));var g=c.root_context_string;if(e.hasClass("folder")||
e.attr("id")=="folder_panel"){c=$.replaceTags($("#file_context_links ."+g+"_folder_url").attr("href"),"id",c.id);$.ajaxJSON(c,"PUT",{"folder[name]":f},function(l){files.updateFolder(g,{folder:l.folder,already_in_place:true})},function(){})}else{c=$.replaceTags($("#file_context_links ."+g+"_attachment_url").attr("href"),"id",c.id);$.ajaxJSON(c,"PUT",{"attachment[display_name]":f},function(l){files.updateFile(g,l)},function(){})}}e.find(".name").show();$(this).val("").appendTo($("#file_context_links"));
$(this).triggerHandler("blur",false)}});$("#rename_entry_field").keycodes("return esc",function(b){$(this).triggerHandler("blur",b.keyString=="return")});$(".folder_item .delete_item_link,#folder_panel .delete_item_link,#file_panel .delete_item_link").click(function(b){b.preventDefault();b.stopPropagation();var d=files.itemData($(this).parents(".folder_item"));d=d||files.itemData($(this).parents("#folder_panel,#file_panel").data("node"));b=$(this).parents(".folder_item").hasClass("file")?"file":"folder";
if($(this).parents(".folder_item").hasClass("collaboration"))b="collaboration";$(this).parents(".folder_item").confirmDelete({message:$(this).parents(".folder_item").hasClass("folder")?"Are you sure you want to delete this folder and all of its contents?":"Are you sure you want to delete this "+b+"?",url:$(this).attr("href"),success:function(){j.find(".file_"+d.id+",.folder_"+d.id).filter(".active-node,.active-leaf").length>0&&files.selectFolder(j.find(".file_"+d.id+",.folder_"+d.id).filter(".active-node,.active-leaf").parent("ul").parent("li"));
j.find(".file_"+d.id).prev("li.separator").remove();j.find(".file_"+d.id).remove();j.find(".folder_"+d.id).prev("li.separator").remove();j.find(".folder_"+d.id).remove();j.find(".collaboration_"+d.id).prev("li.separator").remove();j.find(".collaboration_"+d.id).remove();files.refreshView();files.updateQuota();$(this).slideUp(function(){$(this).remove()})}})});$(".folder_item:not(.add_item)").click(function(b){var d=$(this);b.preventDefault();if(!(a.filter(".dragging").length>0))if(!($(this).find("#rename_entry_field").length>
0)){b.stopPropagation();d.data("parent_node")&&files.expandFolder(d.data("parent_node"));setTimeout(function(){if(d.hasClass("folder")){files.expandFolder(d.data("node"));var e=function(){files.refreshView();$(this).unbind("files_load",e)};d.data("node").bind("files_load",e);d.data("node").children(".text").click()}else if(d.hasClass("collaboration"))d.data("node").children(".text").click();else{d.find(".name").focus();location.href=d.find(".download_url").attr("href")}},50)}});$(".folder_item").hover(function(){$(".folder_item_hover").removeClass("folder_item_hover");
$(this).addClass("folder_item_hover")},function(){});$("#folder_panel .add_file_link").click(function(b){b.preventDefault();if(!(a.find(".add_form:visible").length>0)){b=$("#add_file_form").clone(true).removeAttr("id");a.children(".message").remove();a.append(b);a.scrollToVisible(b);var d=files.currentItemData();b.fillFormData({folder_id:d.id},{object_name:"attachment"});b.find("form").attr("action",$("#file_context_links ."+d.context_string+"_attachments_url").attr("href")+".text");b.mouseover();
b.find(":text:first").focus().select()}});$("#folder_panel .add_folder_link").click(function(b){b.preventDefault();if(!(a.find(".add_form:visible").length>0)){b=$("#add_folder_form").clone(true).removeAttr("id");a.children(".message").remove();a.find("#folder_panel.addable_content_panel").after(b);a.scrollToVisible(b);var d=files.currentItemData();b.fillFormData({parent_folder_id:d.id},{object_name:"folder"});b.find("form").attr("action",$("#file_context_links ."+d.context_string+"_folders_url").attr("href"));
b.mouseover();b.find(":text:first").focus().select()}});$("#add_folder_form :text").keycodes("esc",function(b){b.keyString=="esc"&&$(this).trigger("blur",true)});$("#add_folder_form :text").bind("blur",function(b,d){if(d)$(this).parents("li").remove();else $.trim($(this).val())&&$(this).parents("form").trigger("submit")});$("#add_folder_form .add_folder_form").formSubmit({beforeSubmit:function(b){if($(this).hasClass("submitting"))return false;$(this).addClass("submitting");$(this).find(".name").show().text(b["folder[name]"]);
$(this).find(":text").hide();$(this).data("root_context_string",files.currentItemData().root_context_string)},success:function(b){$(this).removeClass("submitting");for(var d in fileStructureData)fileStructureData[d][0].context_string==$(this).data("root_context_string")&&fileStructureData[d][1].folders.push(b);d=b.folder;var e=j.find(".folder_blank").clone(true).removeClass("folder_blank");e.addClass("folder folder_"+d.id);e.fillTemplateData({data:{name:d.name,id:d.id}});var c=j.find(".folder_"+d.parent_folder_id);
c.children("ul").append("<li class='separator'/>");c.children("ul").append(e.show());files.updateFolder($(this).data("root_context_string"),b);$(this).parents("li").remove();files.refreshView(d)},error:function(b){$(this).removeClass("submitting");$(this).formErrors(b)}});$("#add_file_form .add_file_form").formSubmit({fileUpload:true,beforeSubmit:function(){$(this).data("context_string",files.currentItemData().context_string);$(this).find(".loading_message").slideDown()},success:function(b){$(this).parents("li").remove();
files.updateFile($(this).data("context_string"),b);files.updateQuota()},error:function(b){$(this).find(".loading_message").slideUp();$(this).formErrors(b)}});$("#add_file_form .cancel_button").click(function(){$(this).parents("li").remove()});$(".folder_item .lock_item_link,#file_panel .lock_item_link,#folder_panel .lock_item_link").click(function(b){b.preventDefault();b.stopPropagation();b="File";var d="attachment",e=$("#lock_attachment_form"),c=$(this).parents(".folder_item,#file_panel,#folder_panel"),
f=files.itemData(c)||files.itemData(c.data("node")),g=$(this).attr("href");if(c.hasClass("folder")||$(this).parents("#folder_panel").length>0){b="Folder";d="folder";e=$("#lock_folder_form")}e.attr("action",g);e.data("context_string",f.context_string);$("#lock_item_dialog form").hide();e.show();f.lock_at=$.parseFromISO(f.last_lock_at).datetime_formatted;f.unlock_at=$.parseFromISO(f.last_unlock_at).datetime_formatted;f.locked=!f.lock_at&&!f.unlock_at?"1":"0";$("#lock_item_dialog").fillTemplateData({data:{name:f.name}});
e.fillFormData(f,{object_name:d});e.find("#folder_just_hide,#attachment_just_hide").attr("checked",false).change();e.find(".item_type").text(d);$("#lock_item_dialog").dialog("close").dialog({autoOpen:true,modal:true,width:350,title:"Lock "+b}).dialog("open")});$("#folder_just_hide,#attachment_just_hide").change(function(){$(this).parents("form").find(".full_lock").showIf(!$(this).attr("checked"));$(this).parents("form").find(".lock_checkbox").change()}).change();$("#lock_item_dialog .cancel_button").click(function(){$("#lock_item_dialog").dialog("close")});
$("#lock_item_dialog .lock_checkbox").change(function(){$(this).parents("table").find(".lock_range").showIf(!$(this).attr("checked"))}).change();$("#lock_attachment_form").formSubmit({processData:function(b){return b},beforeSubmit:function(){$(this).loadingImage()},success:function(b){$(this).loadingImage("remove");$("#lock_item_dialog").dialog("close");files.updateFile($(this).data("context_string"),b)}});$("#lock_folder_form").formSubmit({processData:function(b){return b},beforeSubmit:function(){$(this).loadingImage()},
success:function(b){$(this).loadingImage("remove");$("#lock_item_dialog").dialog("close");files.updateFolder($(this).data("context_string"),{folder:b.folder,already_in_place:true})}});$(".folder_item .unlock_item_link,#file_panel .unlock_item_link,#folder_panel .unlock_item_link").click(function(b){b.preventDefault();b.stopPropagation();var d="attachment";$("#lock_attachment_form");var e=$(this).parents(".folder_item,#file_panel,#folder_panel"),c=files.itemData(e)||files.itemData(e.data("node"));
b=$(this).attr("href");if(e.hasClass("folder")||$(this).parents("#folder_panel").length>0){d="folder";$("#lock_folder_form");b=e.find(".folder_url").attr("href")}e.loadingImage();var f={};f["["+d+"][locked]"]="";f["["+d+"][hidden]"]="";f["["+d+"][lock_at]"]="";f["["+d+"][unlock_at]"]="";e.loadingImage();$.ajaxJSON(b,"PUT",f,function(g){e.loadingImage("remove");d=="attachment"?files.updateFile(c.context_string,g):files.updateFolder(c.context_string,{folder:g.folder,already_in_place:true})},function(){e.loadingImage("remove")})});
if(location.hash===""||location.hash=="#"){var h=$("#files_structure_list .context:first .name:first").text();location.href="#"+encodeURIComponent(h)}$(document).fragmentChange(function(b,d){setTimeout(function(){files.selectNodeFromPath(d.substring(1));j.scrollToVisible($("li.active-node,li.active-leaf").find("span.name").filter(":first"))},100)}).fragmentChange();setTimeout(function(){$(window).triggerHandler("resize");swfUpload=new SWFUpload({upload_url:"/bad_location",flash_url:"/flash/swf_upload/Flash/swfupload.swf",
file_size_limit:"100 MB",swfupload_loaded_handler:function(){k.text("Add Files").triggerHandler("show")},button_image_url:"/images/not_a_file.png",file_queue_error_handler:fileUpload.fileQueueError,file_queued_handler:fileUpload.fileQueued,file_dialog_complete_handler:fileUpload.fileDialogComplete,assume_success_timeout:15,upload_progress_handler:fileUpload.uploadProgress,upload_error_handler:fileUpload.uploadError,upload_start_handler:fileUpload.uploadStart,upload_success_handler:fileUpload.uploadSuccess,
upload_complete_handler:fileUpload.uploadComplete,button_placeholder_id:"blech",button_width:50,button_height:22,button_text:'<span class="link">&nbsp;</span>',button_text_style:".link { font-family: Arial, sans-serif; font-size: 15px; color: transparent; text-align: right; text-decoration: none;}",button_text_top_padding:4,button_text_left_padding:0,button_window_mode:SWFUpload.WINDOW_MODE.TRANSPARENT,button_cursor:SWFUpload.CURSOR.HAND,file_post_name:"attachment_uploaded_data",use_query_string:true,
post_params:{authenticity_token:$("#ajax_authenticity_token").text(),_normandy_session:$("#file_uploads_session_id").text(),format:"json"},http_success:[200,201]})},1E3)})})();
var fileUpload={ajaxUploadCount:0,swfUploadCount:0,queuedAjaxUploads:[],currentlyUploading:false,queueAjaxUpload:function(a,i){fileUpload.ajaxUploadCount=fileUpload.queuedAjaxUploads.length;var k={file:a,folder_id:i,name:a.name},j=fileUpload.initFile(k);j.data("folder",files.currentItemData());j.find(".status").text("Queued");fileUpload.queuedAjaxUploads.push(k);fileUpload.updateUploadCount();fileUpload.uploadAjaxFiles()},uploadAjaxFiles:function(a){if(!(fileUpload.currentlyUploading&&!a)){var i=
fileUpload.queuedAjaxUploads.shift();if(i){fileUpload.currentlyUploading=true;var k=fileUpload.initFile(i);k.find(".status").text("Uploading");k.find(".progress_bar").progressbar("value",10);a=k.data("folder");i=i.file;$.ajaxFileUpload({url:$("."+a.context_string+"_attachments_url").attr("href"),data:{"attachment[uploaded_data]":i,"attachment[display_name]":i.name,"attachment[folder_id]":a.id},method:"POST",success:function(j){setTimeout(function(){fileUpload.uploadAjaxFiles(true)},500);var r=j.attachment;
$.underscore(r.context_type);k.find(".cancel_upload_link").hide().end().find(".status").text("Done uploading");k.addClass("done");setTimeout(function(){k.slideUp(function(){k.remove()})},5E3);files.updateFile(r.context_code,j)},error:function(){setTimeout(function(){fileUpload.uploadAjaxFiles(true)},500);k.find(".status").text("Failed").end().find(".cancel_upload_link").hide()}})}else{fileUpload.currentlyUploading=false;fileUpload.ajaxUploadCount=0;fileUpload.updateUploadCount()}}},updateSwfUploadCount:function(a){fileUpload.swfUploadCount=
a;fileUpload.updateUploadCount()},updateUploadCount:function(){fileUpload.ajaxUploadCount=fileUpload.queuedAjaxUploads.length;fileUpload.currentlyUploading&&fileUpload.ajaxUploadCount++;var a=fileUpload.swfUploadCount+fileUpload.ajaxUploadCount;if(a===0){$("#file_uploads_progress").slideUp();$("#file_uploads_spinner").slideUp();var i=$("#file_upload_blank").clone(true).removeAttr("id").empty();i.text("Finished uploading all files");$("#file_uploads").prepend(i.slideDown("fast"));i.addClass("finished_message");
i.click(function(){$(this).slideUp(function(){$(this).remove()})});setTimeout(function(){i.slideUp(function(){i.remove()})},5E3)}else{$("#file_uploads_dialog_link").text("Uploading "+a+" Files...");$("#file_uploads_progress").slideDown()}},fileDialogComplete:function(a,i){try{i>0&&this.startUpload()}catch(k){this.debug(k)}},fileQueued:function(a){a=fileUpload.initFile(a);a.data("folder",files.currentItemData());a.find(".status").text("Queued");fileUpload.updateSwfUploadCount(this.getStats().files_queued)},
fileQueueError:function(a,i,k){a=fileUpload.initFile(a);a.find(".status").text("Failed").end().find(".cancel_upload_link").hide();a.append(k)},initFile:function(a){if(!a.id)a.id="tmp_"+Math.round(Math.random()*9999);var i=$("#file_upload_"+a.id);if(i.length===0){i=$("#file_upload_blank").clone(true).attr("id","file_upload_"+a.id);$("#file_uploads").append(i);i.find(".progress_bar").progressbar();i.click(function(k){if($(this).find(".cancel_upload_link:visible").length===0&&$(this).hasClass("done")){k.preventDefault();
$(this).slideUp(function(){$(this).remove()})}});i.find(".cancel_upload_link").click(function(k){k.preventDefault();k=($(this).parents(".file_upload").attr("id")||"").substring(12);swfUpload.cancelUpload(k,true)})}i.find(".file_name").text(a.name);i.slideDown("fast");return i},uploadStart:function(a){var i=fileUpload.initFile(a).data("folder");this.addFileParam(a.id,"file_extension",a.type);if(i){this.addPostParam("attachment[folder_id]",i.id);this.setUploadURL($("."+i.context_string+"_attachments_url").attr("href"))}},
uploadProgress:function(a,i){try{var k=Math.ceil(i/a.size*100);$("#file_upload_"+a.id).find(".progress_bar").progressbar("value",k);k===100?$("#file_upload_"+a.id).find(".cancel_upload_link").hide().end().find(".status").text("Uploading"):$("#file_upload_"+a.id).find(".status").text("Uploading")}catch(j){this.debug(j)}},uploadSuccess:function(a,i){try{$("#file_upload_"+a.id).find(".cancel_upload_link").hide().end().find(".status").text("Done uploading");var k=$("#file_upload_"+a.id);k.addClass("done");
var j=k.data("folder").context_string;setTimeout(function(){k.slideUp(function(){k.remove()})},5E3);if(i){var r=JSON.parse(i);r.swf=true;setTimeout(function(){files.updateFile(j,r)},500)}else $("#file_upload_"+a.id).find(".cancel_upload_link").hide().end().find(".status").text("File may have uploaded, but the server failed to respond.  Reload the page to confirm.");fileUpload.updateSwfUploadCount(this.getStats().files_queued)}catch(h){console.log("upload processing error");this.debug(h)}},uploadComplete:function(){try{this.getStats().files_queued>
0?this.startUpload():fileUpload.updateSwfUploadCount(0);files.updateQuota()}catch(a){console.log("upload completion error");this.debug(a)}},uploadError:function(a,i){try{$("#file_uploads_dialog_link").text("Uploading Error");$("#file_uploads_progress").slideDown();$("#file_upload_"+a.id).find(".cancel_upload_link").hide().end().find(".status").text("Failed uploading");$("#file_upload_"+a.id).addClass("done");switch(i){case SWFUpload.UPLOAD_ERROR.FILE_CANCELLED:try{$("#file_upload_"+a.id).find(".status").text("Cancelled")}catch(k){this.debug(k)}break;
case SWFUpload.UPLOAD_ERROR.UPLOAD_STOPPED:try{$("#file_upload_"+a.id).find(".status").text("Stopped Uploading")}catch(j){this.debug(j)}}}catch(r){console.log("upload error error");this.debug(r)}}},SWFUpload;if(SWFUpload==undefined)SWFUpload=function(a){this.initSWFUpload(a)};
SWFUpload.prototype.initSWFUpload=function(a){try{this.customSettings={};this.settings=a;this.eventQueue=[];this.movieName="SWFUpload_"+SWFUpload.movieCount++;this.movieElement=null;SWFUpload.instances[this.movieName]=this;this.initSettings();this.loadFlash();this.displayDebugInfo()}catch(i){delete SWFUpload.instances[this.movieName];throw i;}};SWFUpload.instances={};SWFUpload.movieCount=0;SWFUpload.version="2.2.0 2009-03-25";
SWFUpload.QUEUE_ERROR={QUEUE_LIMIT_EXCEEDED:-100,FILE_EXCEEDS_SIZE_LIMIT:-110,ZERO_BYTE_FILE:-120,INVALID_FILETYPE:-130};SWFUpload.UPLOAD_ERROR={HTTP_ERROR:-200,MISSING_UPLOAD_URL:-210,IO_ERROR:-220,SECURITY_ERROR:-230,UPLOAD_LIMIT_EXCEEDED:-240,UPLOAD_FAILED:-250,SPECIFIED_FILE_ID_NOT_FOUND:-260,FILE_VALIDATION_FAILED:-270,FILE_CANCELLED:-280,UPLOAD_STOPPED:-290};SWFUpload.FILE_STATUS={QUEUED:-1,IN_PROGRESS:-2,ERROR:-3,COMPLETE:-4,CANCELLED:-5};
SWFUpload.BUTTON_ACTION={SELECT_FILE:-100,SELECT_FILES:-110,START_UPLOAD:-120};SWFUpload.CURSOR={ARROW:-1,HAND:-2};SWFUpload.WINDOW_MODE={WINDOW:"window",TRANSPARENT:"transparent",OPAQUE:"opaque"};SWFUpload.completeURL=function(a){if(typeof a!=="string"||a.match(/^https?:\/\//i)||a.match(/^\//))return a;var i=window.location.pathname.lastIndexOf("/");path=i<=0?"/":window.location.pathname.substr(0,i)+"/";return path+a};
SWFUpload.prototype.initSettings=function(){this.ensureDefault=function(a,i){this.settings[a]=this.settings[a]==undefined?i:this.settings[a]};this.ensureDefault("upload_url","");this.ensureDefault("preserve_relative_urls",false);this.ensureDefault("file_post_name","Filedata");this.ensureDefault("post_params",{});this.ensureDefault("use_query_string",false);this.ensureDefault("requeue_on_error",false);this.ensureDefault("http_success",[]);this.ensureDefault("assume_success_timeout",0);this.ensureDefault("file_types",
"*.*");this.ensureDefault("file_types_description","All Files");this.ensureDefault("file_size_limit",0);this.ensureDefault("file_upload_limit",0);this.ensureDefault("file_queue_limit",0);this.ensureDefault("flash_url","swfupload.swf");this.ensureDefault("prevent_swf_caching",true);this.ensureDefault("button_image_url","");this.ensureDefault("button_width",1);this.ensureDefault("button_height",1);this.ensureDefault("button_text","");this.ensureDefault("button_text_style","color: #000000; font-size: 16pt;");
this.ensureDefault("button_text_top_padding",0);this.ensureDefault("button_text_left_padding",0);this.ensureDefault("button_action",SWFUpload.BUTTON_ACTION.SELECT_FILES);this.ensureDefault("button_disabled",false);this.ensureDefault("button_placeholder_id","");this.ensureDefault("button_placeholder",null);this.ensureDefault("button_cursor",SWFUpload.CURSOR.ARROW);this.ensureDefault("button_window_mode",SWFUpload.WINDOW_MODE.WINDOW);this.ensureDefault("debug",false);this.settings.debug_enabled=this.settings.debug;
this.settings.return_upload_start_handler=this.returnUploadStart;this.ensureDefault("swfupload_loaded_handler",null);this.ensureDefault("file_dialog_start_handler",null);this.ensureDefault("file_queued_handler",null);this.ensureDefault("file_queue_error_handler",null);this.ensureDefault("file_dialog_complete_handler",null);this.ensureDefault("upload_start_handler",null);this.ensureDefault("upload_progress_handler",null);this.ensureDefault("upload_error_handler",null);this.ensureDefault("upload_success_handler",
null);this.ensureDefault("upload_complete_handler",null);this.ensureDefault("debug_handler",this.debugMessage);this.ensureDefault("custom_settings",{});this.customSettings=this.settings.custom_settings;if(this.settings.prevent_swf_caching)this.settings.flash_url=this.settings.flash_url+(this.settings.flash_url.indexOf("?")<0?"?":"&")+"preventswfcaching="+(new Date).getTime();if(!this.settings.preserve_relative_urls){this.settings.upload_url=SWFUpload.completeURL(this.settings.upload_url);this.settings.button_image_url=
SWFUpload.completeURL(this.settings.button_image_url)}delete this.ensureDefault};
SWFUpload.prototype.loadFlash=function(){var a,i;if(document.getElementById(this.movieName)!==null)throw"ID "+this.movieName+" is already in use. The Flash Object could not be added";a=document.getElementById(this.settings.button_placeholder_id)||this.settings.button_placeholder;if(a==undefined)throw"Could not find the placeholder element: "+this.settings.button_placeholder_id;i=document.createElement("div");i.innerHTML=this.getFlashHTML();a.parentNode.replaceChild(i.firstChild,a);if(window[this.movieName]==
undefined)window[this.movieName]=this.getMovieElement()};
SWFUpload.prototype.getFlashHTML=function(){return['<object id="',this.movieName,'" type="application/x-shockwave-flash" data="',this.settings.flash_url,'" width="',this.settings.button_width,'" height="',this.settings.button_height,'" class="swfupload"><param name="wmode" value="',this.settings.button_window_mode,'" /><param name="movie" value="',this.settings.flash_url,'" /><param name="quality" value="high" /><param name="menu" value="false" /><param name="allowScriptAccess" value="always" />','<param name="flashvars" value="'+
this.getFlashVars()+'" />',"</object>"].join("")};
SWFUpload.prototype.getFlashVars=function(){var a=this.buildParamString(),i=this.settings.http_success.join(",");return["movieName=",encodeURIComponent(this.movieName),"&amp;uploadURL=",encodeURIComponent(this.settings.upload_url),"&amp;useQueryString=",encodeURIComponent(this.settings.use_query_string),"&amp;requeueOnError=",encodeURIComponent(this.settings.requeue_on_error),"&amp;httpSuccess=",encodeURIComponent(i),"&amp;assumeSuccessTimeout=",encodeURIComponent(this.settings.assume_success_timeout),"&amp;params=",
encodeURIComponent(a),"&amp;filePostName=",encodeURIComponent(this.settings.file_post_name),"&amp;fileTypes=",encodeURIComponent(this.settings.file_types),"&amp;fileTypesDescription=",encodeURIComponent(this.settings.file_types_description),"&amp;fileSizeLimit=",encodeURIComponent(this.settings.file_size_limit),"&amp;fileUploadLimit=",encodeURIComponent(this.settings.file_upload_limit),"&amp;fileQueueLimit=",encodeURIComponent(this.settings.file_queue_limit),"&amp;debugEnabled=",encodeURIComponent(this.settings.debug_enabled),
"&amp;buttonImageURL=",encodeURIComponent(this.settings.button_image_url),"&amp;buttonWidth=",encodeURIComponent(this.settings.button_width),"&amp;buttonHeight=",encodeURIComponent(this.settings.button_height),"&amp;buttonText=",encodeURIComponent(this.settings.button_text),"&amp;buttonTextTopPadding=",encodeURIComponent(this.settings.button_text_top_padding),"&amp;buttonTextLeftPadding=",encodeURIComponent(this.settings.button_text_left_padding),"&amp;buttonTextStyle=",encodeURIComponent(this.settings.button_text_style),
"&amp;buttonAction=",encodeURIComponent(this.settings.button_action),"&amp;buttonDisabled=",encodeURIComponent(this.settings.button_disabled),"&amp;buttonCursor=",encodeURIComponent(this.settings.button_cursor)].join("")};SWFUpload.prototype.getMovieElement=function(){if(this.movieElement==undefined)this.movieElement=document.getElementById(this.movieName);if(this.movieElement===null)throw"Could not find Flash element";return this.movieElement};
SWFUpload.prototype.buildParamString=function(){var a=this.settings.post_params,i=[];if(typeof a==="object")for(var k in a)a.hasOwnProperty(k)&&i.push(encodeURIComponent(k.toString())+"="+encodeURIComponent(a[k].toString()));return i.join("&amp;")};
SWFUpload.prototype.destroy=function(){try{this.cancelUpload(null,false);var a=null;if((a=this.getMovieElement())&&typeof a.CallFunction==="unknown"){for(var i in a)try{if(typeof a[i]==="function")a[i]=null}catch(k){}try{a.parentNode.removeChild(a)}catch(j){}}window[this.movieName]=null;SWFUpload.instances[this.movieName]=null;delete SWFUpload.instances[this.movieName];this.movieName=this.eventQueue=this.customSettings=this.settings=this.movieElement=null;return true}catch(r){return false}};
SWFUpload.prototype.displayDebugInfo=function(){this.debug(["---SWFUpload Instance Info---\nVersion: ",SWFUpload.version,"\nMovie Name: ",this.movieName,"\nSettings:\n\tupload_url:               ",this.settings.upload_url,"\n\tflash_url:                ",this.settings.flash_url,"\n\tuse_query_string:         ",this.settings.use_query_string.toString(),"\n\trequeue_on_error:         ",this.settings.requeue_on_error.toString(),"\n\thttp_success:             ",this.settings.http_success.join(", "),"\n\tassume_success_timeout:   ",
this.settings.assume_success_timeout,"\n\tfile_post_name:           ",this.settings.file_post_name,"\n\tpost_params:              ",this.settings.post_params.toString(),"\n\tfile_types:               ",this.settings.file_types,"\n\tfile_types_description:   ",this.settings.file_types_description,"\n\tfile_size_limit:          ",this.settings.file_size_limit,"\n\tfile_upload_limit:        ",this.settings.file_upload_limit,"\n\tfile_queue_limit:         ",this.settings.file_queue_limit,"\n\tdebug:                    ",
this.settings.debug.toString(),"\n\tprevent_swf_caching:      ",this.settings.prevent_swf_caching.toString(),"\n\tbutton_placeholder_id:    ",this.settings.button_placeholder_id.toString(),"\n\tbutton_placeholder:       ",this.settings.button_placeholder?"Set":"Not Set","\n\tbutton_image_url:         ",this.settings.button_image_url.toString(),"\n\tbutton_width:             ",this.settings.button_width.toString(),"\n\tbutton_height:            ",this.settings.button_height.toString(),"\n\tbutton_text:              ",
this.settings.button_text.toString(),"\n\tbutton_text_style:        ",this.settings.button_text_style.toString(),"\n\tbutton_text_top_padding:  ",this.settings.button_text_top_padding.toString(),"\n\tbutton_text_left_padding: ",this.settings.button_text_left_padding.toString(),"\n\tbutton_action:            ",this.settings.button_action.toString(),"\n\tbutton_disabled:          ",this.settings.button_disabled.toString(),"\n\tcustom_settings:          ",this.settings.custom_settings.toString(),"\nEvent Handlers:\n\tswfupload_loaded_handler assigned:  ",
(typeof this.settings.swfupload_loaded_handler==="function").toString(),"\n\tfile_dialog_start_handler assigned: ",(typeof this.settings.file_dialog_start_handler==="function").toString(),"\n\tfile_queued_handler assigned:       ",(typeof this.settings.file_queued_handler==="function").toString(),"\n\tfile_queue_error_handler assigned:  ",(typeof this.settings.file_queue_error_handler==="function").toString(),"\n\tupload_start_handler assigned:      ",(typeof this.settings.upload_start_handler===
"function").toString(),"\n\tupload_progress_handler assigned:   ",(typeof this.settings.upload_progress_handler==="function").toString(),"\n\tupload_error_handler assigned:      ",(typeof this.settings.upload_error_handler==="function").toString(),"\n\tupload_success_handler assigned:    ",(typeof this.settings.upload_success_handler==="function").toString(),"\n\tupload_complete_handler assigned:   ",(typeof this.settings.upload_complete_handler==="function").toString(),"\n\tdebug_handler assigned:             ",
(typeof this.settings.debug_handler==="function").toString(),"\n"].join(""))};SWFUpload.prototype.addSetting=function(a,i,k){return i==undefined?this.settings[a]=k:this.settings[a]=i};SWFUpload.prototype.getSetting=function(a){if(this.settings[a]!=undefined)return this.settings[a];return""};
SWFUpload.prototype.callFlash=function(a,i){i=i||[];var k=this.getMovieElement(),j,r;try{r=k.CallFunction('<invoke name="'+a+'" returntype="javascript">'+__flash__argumentsToXML(i,0)+"</invoke>");j=eval(r)}catch(h){throw"Call to "+a+" failed";}if(j!=undefined&&typeof j.post==="object")j=this.unescapeFilePostParams(j);return j};SWFUpload.prototype.selectFile=function(){this.callFlash("SelectFile")};SWFUpload.prototype.selectFiles=function(){this.callFlash("SelectFiles")};
SWFUpload.prototype.startUpload=function(a){this.callFlash("StartUpload",[a])};SWFUpload.prototype.cancelUpload=function(a,i){if(i!==false)i=true;this.callFlash("CancelUpload",[a,i])};SWFUpload.prototype.stopUpload=function(){this.callFlash("StopUpload")};SWFUpload.prototype.getStats=function(){return this.callFlash("GetStats")};SWFUpload.prototype.setStats=function(a){this.callFlash("SetStats",[a])};
SWFUpload.prototype.getFile=function(a){return typeof a==="number"?this.callFlash("GetFileByIndex",[a]):this.callFlash("GetFile",[a])};SWFUpload.prototype.addFileParam=function(a,i,k){return this.callFlash("AddFileParam",[a,i,k])};SWFUpload.prototype.removeFileParam=function(a,i){this.callFlash("RemoveFileParam",[a,i])};SWFUpload.prototype.setUploadURL=function(a){this.settings.upload_url=a.toString();this.callFlash("SetUploadURL",[a])};
SWFUpload.prototype.setPostParams=function(a){this.settings.post_params=a;this.callFlash("SetPostParams",[a])};SWFUpload.prototype.addPostParam=function(a,i){this.settings.post_params[a]=i;this.callFlash("SetPostParams",[this.settings.post_params])};SWFUpload.prototype.removePostParam=function(a){delete this.settings.post_params[a];this.callFlash("SetPostParams",[this.settings.post_params])};
SWFUpload.prototype.setFileTypes=function(a,i){this.settings.file_types=a;this.settings.file_types_description=i;this.callFlash("SetFileTypes",[a,i])};SWFUpload.prototype.setFileSizeLimit=function(a){this.settings.file_size_limit=a;this.callFlash("SetFileSizeLimit",[a])};SWFUpload.prototype.setFileUploadLimit=function(a){this.settings.file_upload_limit=a;this.callFlash("SetFileUploadLimit",[a])};
SWFUpload.prototype.setFileQueueLimit=function(a){this.settings.file_queue_limit=a;this.callFlash("SetFileQueueLimit",[a])};SWFUpload.prototype.setFilePostName=function(a){this.settings.file_post_name=a;this.callFlash("SetFilePostName",[a])};SWFUpload.prototype.setUseQueryString=function(a){this.settings.use_query_string=a;this.callFlash("SetUseQueryString",[a])};SWFUpload.prototype.setRequeueOnError=function(a){this.settings.requeue_on_error=a;this.callFlash("SetRequeueOnError",[a])};
SWFUpload.prototype.setHTTPSuccess=function(a){if(typeof a==="string")a=a.replace(" ","").split(",");this.settings.http_success=a;this.callFlash("SetHTTPSuccess",[a])};SWFUpload.prototype.setAssumeSuccessTimeout=function(a){this.settings.assume_success_timeout=a;this.callFlash("SetAssumeSuccessTimeout",[a])};SWFUpload.prototype.setDebugEnabled=function(a){this.settings.debug_enabled=a;this.callFlash("SetDebugEnabled",[a])};
SWFUpload.prototype.setButtonImageURL=function(a){if(a==undefined)a="";this.settings.button_image_url=a;this.callFlash("SetButtonImageURL",[a])};SWFUpload.prototype.setButtonDimensions=function(a,i){this.settings.button_width=a;this.settings.button_height=i;var k=this.getMovieElement();if(k!=undefined){k.style.width=a+"px";k.style.height=i+"px"}this.callFlash("SetButtonDimensions",[a,i])};SWFUpload.prototype.setButtonText=function(a){this.settings.button_text=a;this.callFlash("SetButtonText",[a])};
SWFUpload.prototype.setButtonTextPadding=function(a,i){this.settings.button_text_top_padding=i;this.settings.button_text_left_padding=a;this.callFlash("SetButtonTextPadding",[a,i])};SWFUpload.prototype.setButtonTextStyle=function(a){this.settings.button_text_style=a;this.callFlash("SetButtonTextStyle",[a])};SWFUpload.prototype.setButtonDisabled=function(a){this.settings.button_disabled=a;this.callFlash("SetButtonDisabled",[a])};
SWFUpload.prototype.setButtonAction=function(a){this.settings.button_action=a;this.callFlash("SetButtonAction",[a])};SWFUpload.prototype.setButtonCursor=function(a){this.settings.button_cursor=a;this.callFlash("SetButtonCursor",[a])};
SWFUpload.prototype.queueEvent=function(a,i){if(i==undefined)i=[];else i instanceof Array||(i=[i]);var k=this;if(typeof this.settings[a]==="function"){this.eventQueue.push(function(){this.settings[a].apply(this,i)});setTimeout(function(){k.executeNextEvent()},0)}else if(this.settings[a]!==null)throw"Event handler "+a+" is unknown or is not a function";};SWFUpload.prototype.executeNextEvent=function(){var a=this.eventQueue?this.eventQueue.shift():null;typeof a==="function"&&a.apply(this)};
SWFUpload.prototype.unescapeFilePostParams=function(a){var i=/[$]([0-9a-f]{4})/i,k={},j;if(a!=undefined){for(var r in a.post)if(a.post.hasOwnProperty(r)){j=r;for(var h;(h=i.exec(j))!==null;)j=j.replace(h[0],String.fromCharCode(parseInt("0x"+h[1],16)));k[j]=a.post[r]}a.post=k}return a};SWFUpload.prototype.testExternalInterface=function(){try{return this.callFlash("TestExternalInterface")}catch(a){return false}};
SWFUpload.prototype.flashReady=function(){var a=this.getMovieElement();if(a){this.cleanUp(a);this.queueEvent("swfupload_loaded_handler")}else this.debug("Flash called back ready but the flash movie can't be found.")};
SWFUpload.prototype.cleanUp=function(a){try{if(this.movieElement&&typeof a.CallFunction==="unknown"){this.debug("Removing Flash functions hooks (this should only run in IE and should prevent memory leaks)");for(var i in a)try{if(typeof a[i]==="function")a[i]=null}catch(k){}}}catch(j){}window.__flash__removeCallback=function(r,h){try{if(r)r[h]=null}catch(b){}}};SWFUpload.prototype.fileDialogStart=function(){this.queueEvent("file_dialog_start_handler")};
SWFUpload.prototype.fileQueued=function(a){a=this.unescapeFilePostParams(a);this.queueEvent("file_queued_handler",a)};SWFUpload.prototype.fileQueueError=function(a,i,k){a=this.unescapeFilePostParams(a);this.queueEvent("file_queue_error_handler",[a,i,k])};SWFUpload.prototype.fileDialogComplete=function(a,i,k){this.queueEvent("file_dialog_complete_handler",[a,i,k])};SWFUpload.prototype.uploadStart=function(a){a=this.unescapeFilePostParams(a);this.queueEvent("return_upload_start_handler",a)};
SWFUpload.prototype.returnUploadStart=function(a){var i;if(typeof this.settings.upload_start_handler==="function"){a=this.unescapeFilePostParams(a);i=this.settings.upload_start_handler.call(this,a)}else if(this.settings.upload_start_handler!=undefined)throw"upload_start_handler must be a function";if(i===undefined)i=true;this.callFlash("ReturnUploadStart",[!!i])};SWFUpload.prototype.uploadProgress=function(a,i,k){a=this.unescapeFilePostParams(a);this.queueEvent("upload_progress_handler",[a,i,k])};
SWFUpload.prototype.uploadError=function(a,i,k){a=this.unescapeFilePostParams(a);this.queueEvent("upload_error_handler",[a,i,k])};SWFUpload.prototype.uploadSuccess=function(a,i,k){a=this.unescapeFilePostParams(a);this.queueEvent("upload_success_handler",[a,i,k])};SWFUpload.prototype.uploadComplete=function(a){a=this.unescapeFilePostParams(a);this.queueEvent("upload_complete_handler",a)};SWFUpload.prototype.debug=function(a){this.queueEvent("debug_handler",a)};
SWFUpload.prototype.debugMessage=function(a){if(this.settings.debug){var i=[];if(typeof a==="object"&&typeof a.name==="string"&&typeof a.message==="string"){for(var k in a)a.hasOwnProperty(k)&&i.push(k+": "+a[k]);a=i.join("\n")||"";i=a.split("\n");a="EXCEPTION: "+i.join("\nEXCEPTION: ")}SWFUpload.Console.writeLine(a)}};SWFUpload.Console={};
SWFUpload.Console.writeLine=function(a){var i,k;try{i=document.getElementById("SWFUpload_Console");if(!i){k=document.createElement("form");document.getElementsByTagName("body")[0].appendChild(k);i=document.createElement("textarea");i.id="SWFUpload_Console";i.style.fontFamily="monospace";i.setAttribute("wrap","off");i.wrap="off";i.style.overflow="auto";i.style.width="700px";i.style.height="350px";i.style.margin="5px";k.appendChild(i)}i.value+=a+"\n";i.scrollTop=i.scrollHeight-i.clientHeight}catch(j){alert("Exception: "+
j.name+" Message: "+j.message)}};
