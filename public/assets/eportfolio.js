(function(){function n(){var a=$("#edit_page_form").getFormData({object_name:"eportfolio_entry",values:["eportfolio_entry[name]","eportfolio_entry[allow_comments]","eportfolio_entry[show_comments]"]}),b=0;$("#edit_page_form .section").each(function(){var c=$(this).getTemplateData({textValues:["section_type"]}).section_type;if(c=="rich_text"||c=="html"||$(this).hasClass("read_only")){b++;var d="section_"+b;if(c=="rich_text"){a[d+"[section_type]"]="rich_text";a[d+"[content]"]=$(this).find(".edit_section").editorBox("get_code")}else if(c==
"html"){a[d+"[section_type]"]="html";a[d+"[content]"]=$(this).find(".edit_section").val()}else if(c=="submission"){a[d+"[section_type]"]="submission";a[d+"[submission_id]"]=$(this).getTemplateData({textValues:["submission_id"]}).submission_id}else if(c=="upload"){a[d+"[section_type]"]="attachment";a[d+"[attachment_id]"]=$(this).getTemplateData({textValues:["attachment_id"]}).attachment_id}}});a.section_count=b;return a}function i(a){var b=$("#"+a+"_name_holder"),c=$("#"+a+"_name").val(),d=b.parents("li."+
a);d.find(".name").text(c);if(d.parent("ul").length>0){b.hide().appendTo($("body"));d.find("."+a+"_url").show()}d.attr("id")==a+"_new"&&d.remove()}function j(a,b){if(a.length!==0){var c="PUT",d=a.find(".rename_"+b+"_url").attr("href");if(a.attr("id")==b+"_new"){c="POST";d=$(".add_"+b+"_url").attr("href")}var e=a.parents("ul").find("."+b+":not(.unsaved)"),f=a.find("#"+b+"_name").val();e.each(function(){if(this!=a[0]&&$(this).find(".name").text()==f)f=""});if(!f)return false;var g="eportfolio_category";
if(b=="page")g="eportfolio_entry";e={};e[g+"[name]"]=f;if(b=="page")e[g+"[eportfolio_category_id]"]=$("#eportfolio_category_id").text();c=="POST"&&a.attr("id",b+"_saving");a.addClass("event_pending");$.ajaxJSON(d,c,e,function(l){a.removeClass("event_pending");a.removeClass("unsaved");var m=l[g];if(c=="POST"){a.remove();$(document).triggerHandler(b+"_added",l)}else $(document).triggerHandler(b+"_updated",l);a.fillTemplateData({data:m,id:b+"_"+m.id,hrefValues:["id","slug"]});h(b)});return true}}function k(a,
b){var c=a.find("."+b+"_url"),d=c.outerWidth()-30;d=145;var e=$("#"+b+"_name_holder"),f=$("#"+b+"_name");f.width(d);c.hide().before(e);f.val($.trim(c.find(".name").text()));e.show();f.focus().select()}function h(a){$("#"+a+"_list ."+a+":not(.unsaved)").length>1?$("#"+a+"_list .remove_page_link").css("display",""):$("#"+a+"_list .remove_page_link").hide()}$(document).ready(function(){$(".portfolio_settings_link").click(function(a){a.preventDefault();$("#edit_eportfolio_form").dialog("close").dialog({autoOpen:false,
width:"auto",title:"ePortfolio Settings"}).dialog("open")});$("#edit_eportfolio_form .cancel_button").click(function(){$("#edit_eportfolio_form").dialog("close")});$("#edit_eportfolio_form").formSubmit({object_name:"eportfolio",beforeSubmit:function(){$(this).loadingImage()},success:function(){$(this).loadingImage("remove");$(this).dialog("close")}});$(".edit_content_link").click(function(a){a.preventDefault();$(".edit_content_link_holder").hide();$("#page_content").addClass("editing");$("#edit_page_form").addClass("editing");
$("#page_sidebar").addClass("editing");$("#edit_page_form .section").each(function(){var b=$(this),c=b.getTemplateData({textValues:["section_type"],htmlValues:["section_content"]});c.section_content=$.trim(c.section_content);var d="edit_"+c.section_type+"_content",e=$("#edit_content_templates ."+d).clone(true);b.append(e.show());if(d=="edit_html_content"){e.find(".edit_section").attr("id","edit_"+b.attr("id"));e.find(".edit_section").val(c.section_content)}else if(d=="edit_rich_text_content"){e.find(".edit_section").attr("id",
"edit_"+b.attr("id"));e.find(".edit_section").editorBox().editorBox("set_code",c.section_content)}});$("#edit_page_form :text:first").focus().select();$("#page_comments_holder").hide();$(document).triggerHandler("editing_page")});$("#edit_page_form").find(".allow_comments").change(function(){$("#edit_page_form .show_comments_box").showIf($(this).attr("checked"))}).change();$("#edit_page_sidebar .submit_button").click(function(){$("#edit_page_form").submit()});$("#edit_page_form,#edit_page_sidebar").find(".preview_button").click(function(){$("#page_content .section.failed").remove();
$("#edit_page_form,#page_content,#page_sidebar").addClass("previewing");$("#page_content .section").each(function(){var a=$(this).find(".section_content").clone().removeClass("section_content").addClass("preview_content").addClass("preview_section"),b=$(this).getTemplateData({textValues:["section_type"]}).section_type;if(b=="html"){a.html($(this).find(".edit_section").val());$(this).find(".section_content").after(a)}else if(b=="rich_text"){a.html($(this).find(".edit_section").editorBox("get_code"));
$(this).find(".section_content").after(a)}})}).end().find(".keep_editing_button").click(function(){$("#edit_page_form,#page_content,#page_sidebar").removeClass("previewing");$("#page_content .preview_section").remove()}).end().find(".cancel_button").click(function(){$("#edit_page_form,#page_content,#page_sidebar").removeClass("editing");$("#page_content .section.unsaved").remove();$(".edit_content_link_holder").show();$("#edit_page_form .edit_section").each(function(){$(this).editorBox("destroy");
$(this).remove()});$("#page_content .section .form_content").remove();$("#page_comments_holder").show()});$("#edit_page_form").formSubmit({processData:function(a){$("#page_content .section.unsaved").removeClass("unsaved");$("#page_content .section.failed").remove();$("#page_content .section").each(function(){var b=$(this).getTemplateData({textValues:["section_type"]}).section_type;if(b=="rich_text"||b=="html"){var c=$(this).find(".edit_section").val();if(b=="rich_text")c=$(this).find(".edit_section").editorBox("get_code");
$(this).find(".section_content").html(c)}else $(this).hasClass("read_only")||$(this).remove()});return a=n()},beforeSubmit:function(){$("#edit_page_form,#page_content,#page_sidebar").removeClass("editing").removeClass("previewing");$("#page_content .section.unsaved").remove();$("#edit_page_form .edit_section").each(function(){$(this).editorBox("destroy");$(this).remove()});$(this).loadingImage()},success:function(a){$(".edit_content_link_holder").show();a.eportfolio_entry.allow_comments&&$("#page_comments_holder").slideDown("fast");
$(this).loadingImage("remove")}});$("#edit_page_form .switch_views_link").click(function(a){a.preventDefault();$("#edit_page_content").editorBox("toggle")});$("#edit_page_sidebar .add_content_link").click(function(a){a.preventDefault();$("#edit_page_form .keep_editing_button:first").click();var b=$("#page_section_blank").clone(true).attr("id","page_section_"+sectionCountIdx);b.addClass("unsaved");b.attr("id","page_section_"+sectionCountIdx++);$("#page_content").append(b);var c="rich_text";a="Rich Text Content";
if($(this).hasClass("add_html_link")){c="html";a="HTML/Embedded Content"}else if($(this).hasClass("add_submission_link")){c="submission";a="Course Submission"}else if($(this).hasClass("add_file_link")){c="upload";a="Image/File Upload"}var d="edit_"+c+"_content";b.fillTemplateData({data:{section_type:c,section_type_name:a}});var e=$("#edit_content_templates ."+d).clone(true);b.append(e.show());if(d=="edit_html_content")e.find(".edit_section").attr("id","edit_"+b.attr("id"));else if(d=="edit_rich_text_content"){e.find(".edit_section").attr("id",
"edit_"+b.attr("id"));e.find(".edit_section").editorBox()}b.hide().slideDown("fast",function(){$("html,body").scrollTo(b);if(c=="rich_text")e.find(".edit_section").editorBox("focus",true);else c=="html"&&e.find(".edit_section").focus().select()})});$(".delete_page_section_link").click(function(a){a.preventDefault();$(this).parents(".section").confirmDelete({success:function(){$(this).slideUp(function(){$(this).remove()})}})});$("#page_content").sortable({handle:".move_link",helper:"clone",axis:"y",
start:function(a,b){var c=$(b.item);c.getTemplateData({textValues:["section_type"]}).section_type=="rich_text"&&c.find("textarea").editorBox("destroy")},stop:function(a,b){var c=$(b.item);c.getTemplateData({textValues:["section_type"]}).section_type=="rich_text"&&c.find("textarea").editorBox()}});$("#page_content").delegate(".cancel_content_button","click",function(a){a.preventDefault();$(this).parents(".section").slideUp(function(){$(this).remove()})}).delegate(".select_submission_button","click",
function(a){a.preventDefault();a=$(this).parents(".section");var b=a.find(".submission_list li.active-leaf:first");if(b.length!==0){var c=b.find(".submission_preview_url").attr("href");b=b.attr("id").substring(11);a.fillTemplateData({data:{submission_id:b}});a.find(".section_content").empty();b=$("#edit_content_templates").find(".submission_preview").clone();b.attr("src",c);a.append(b);a.addClass("read_only")}}).delegate(".upload_file_button","click",function(a){a.preventDefault();a.stopPropagation();
a=$(this).parents(".section");var b=$("#edit_content_templates").find(".uploading_file").clone(),c=$(this).parents(".section").find(".file_upload");if(!(!c.val()&&a.find(".file_list .leaf.active").length===0)){b.fillTemplateData({data:{file_name:c.val()}});$(this).parents(".section").find(".section_content").empty().append(b.show());b=$("#upload_file_form").clone(true).attr("id","");$("body").append(b.hide());b.data("section",a);b.find(".file_upload").remove().end().append(c).submit();a.addClass("read_only")}});
$("#upload_file_form").formSubmit({fileUpload:true,object_name:"attachment",processData:function(a){if(!a.uploaded_data){var b=$(this).data("section"),c=b.find(".file_list .leaf.active");if(c.length>0){a=c.getTemplateData({textValues:["id","name"]});var d=a.id,e=$("#file_uuid_"+d).text(),f=a.name;b.find(".attachment_id").text(d);d=$(".eportfolio_download_url").attr("href");d=$.replaceTags(d,"uuid",e);if(c.hasClass("image")){a=$("#eportfolio_view_image").clone(true).removeAttr("id");a.find(".eportfolio_image").attr("src",
d).attr("alt",f);a.find(".eportfolio_download").attr("href",d);b.find(".section_content").empty().append(a)}else{f=$("#eportfolio_download_file").clone(true).removeAttr("id");f.fillTemplateData({data:{filename:a.name}});f.find(".eportfolio_download").attr("href",d);b.find(".section_content").empty().append(f)}$(this).remove()}else $(this).errorBox("Please select a file");return false}},success:function(a){var b=$(this).data("section");a=a.attachment;b.find(".attachment_id").text(a.id);var c=$(".eportfolio_download_url").attr("href");
c=$.replaceTags(c,"uuid",a.uuid);if(a.content_type.indexOf("image")!=-1){var d=$("#eportfolio_view_image").clone(true).removeAttr("id");d.find(".eportfolio_image").attr("src",c).attr("alt",a.display_name)}else{d=$("#eportfolio_download_file").clone(true).removeAttr("id");d.fillTemplateData({data:{filename:a.display_name}})}d.find(".eportfolio_download").attr("href",c);b.find(".section_content").empty().append(d);$(this).remove()},error:function(a){var b=$(this).data("section");b.find(".uploading_file").html("Upload Failed.");
b.addClass("failed");b.formErrors(a.errors||a)}});$("#recent_submissions .submission").click(function(a){if($(a.target).closest("a").length===0){a.preventDefault();a.stopPropagation();$(this).removeClass("active-leaf");$("#category_select").triggerHandler("change");a=$(this).getTemplateData({textValues:["submission_id"]}).submission_id;$("#add_submission_form .submission_id").val(a);var b=$(this).find(".assignment_title").text();a=$(this).find(".context_name").text();$("#add_submission_form .submission_description").val("This is my "+
b+" submission for "+a+".");$("#add_submission_form").dialog("close").dialog({autoOpen:false,title:"Add Page for Submission",width:400,open:function(){$(this).find(":text:visible:first").val(b).focus().select();$(document).triggerHandler("submission_dialog_opened")}}).dialog("open")}});$("#add_submission_form .cancel_button").click(function(){$("#add_submission_form").dialog("close")});$("#add_submission_form").formSubmit({processData:function(){var a=$(this).find(".add_eportfolio_entry_url").attr("href");
$(this).attr("action",a)},beforeSubmit:function(){$(this).loadingImage()},success:function(a){$(this).loadingImage("remove");$(this).dialog("close");var b=a.eportfolio_entry;try{var c=b.content[1].submission_id;$("#submission_"+c+",#recent_submission_"+c).addClass("already_used")}catch(d){}c=$(this).find(".eportfolio_named_entry_url").attr("href");c=$.replaceTags(c,"category_slug",b.category_slug);c=$.replaceTags(c,"slug",b.slug);location.href=c;$(document).triggerHandler("page_added",a)}});$("#category_select").change(function(){var a=
$(this).val();if(a!="new"){$("#page_select_list .page_select:not(#page_select_blank)").remove();$("#structure_category_"+a).find(".entry_list li.entry").each(function(){var b=$("#page_select_blank").clone(true).removeAttr("id");b.text($(this).getTemplateData({textValues:["name"]}).name);$("#page_select_list").append(b.show())})}}).triggerHandler("change");$.scrollSidebar();$(".delete_comment_link").click(function(a){a.preventDefault();$(this).parents(".comment").confirmDelete({url:$(this).attr("href"),
message:"Are you sure you want to delete this message?",success:function(){$(this).slideUp(function(){$(this).remove()})}})});$(".delete_eportfolio_link").click(function(a){a.preventDefault();$("#delete_eportfolio_form").toggle(function(){$("html,body").scrollTo($("#delete_eportfolio_form"))})});$(document).blur(function(){})});$(document).ready(function(){$(".submission_list").instTree({multi:false,dragdrop:false});$(".file_list > ul").instTree({autoclose:false,multi:false,dragdrop:false,overrideEvents:true,
onClick:function(){$(this).parents(".file_list").find("li.active").removeClass("active");$(this).addClass("active");$(this).hasClass("file")&&$(this).getTemplateData({textValues:["id"]})}})});$(document).ready(function(){h("page");$(document).bind("page_deleted",function(a,b){if(b){var c=b.eportfolio_entry;$("#page_"+c.id).remove();$("#structure_entry_"+c.id).remove();h("page")}});$(document).bind("page_added page_updated",function(a,b){var c=b.eportfolio_entry,d=$("#page_"+c.id);if(d.length===0){d=
$("#page_blank").clone(true).removeAttr("id");$("#page_list").append(d.show())}d.removeClass("unsaved");d.fillTemplateData({data:c,id:"page_"+c.id,hrefValues:["id","slug"]});d=$("#structure_entry_"+c.id);if(d.length===0){d=$("#structure_entry_blank").clone(true).removeAttr("id");$("#structure_category_"+c.eportfolio_category_id+" .entry_list").append(d)}d.fillTemplateData({id:"structure_entry_"+c.id,data:c});h("page")});$(".manage_pages_link,#section_pages .done_editing_button").click(function(a){a.preventDefault();
if($("#page_list").hasClass("editing")){$("#page_list").removeClass("editing");$("#page_list .page").attr("title","");$("#page_list").sortable("destroy");$("#section_pages").removeClass("editing")}else{$("#page_list").addClass("editing");$("#page_list .page").attr("title","Click to edit, drag to reorder");$("#page_list").sortable({axis:"y",helper:"clone",stop:function(b,c){c.item.addClass("just_dropped")},update:function(){var b=$("#page_list").sortable("toArray"),c=[],d;for(d in b){var e=b[d];e=
parseInt(e.substring(5));isNaN(e)||c.push(e)}b={order:c.join(",")};$("#page_list").loadingImage({image_size:"small"});$.ajaxJSON($(".reorder_pages_url").attr("href"),"POST",b,function(){$("#page_list").loadingImage("remove")})}});$("#section_pages").addClass("editing")}});$("#page_list").delegate(".edit_page_link","click",function(a){$(this).parents("li").hasClass("unsaved")&&a.preventDefault();if($(this).parents("#page_list").hasClass("editing")){a.preventDefault();a=$(this).parents("li");a.hasClass("just_dropped")?
a.removeClass("just_dropped"):k(a,"page")}});$(".add_page_link").click(function(a){a.preventDefault();a=$("#page_blank").clone(true).attr("id","page_new");$("#page_list").append(a.show());k(a,"page")});$(".remove_page_link").click(function(a){a.preventDefault();i("page");$(this).parents("li").confirmDelete({message:"Delete this page and all its content?",url:$(this).parents("li").find(".rename_page_url").attr("href"),success:function(b){$(this).fadeOut(function(){$(this).remove();$(document).triggerHandler("page_deleted",
b);h("page")})}})});$("#page_name").keydown(function(a){if(a.keyCode==27)i("page");else if(a.keyCode==13){$(this).parents("li").find(".name").text($(this).val());j($(this).parents("li"),"page")&&i("page")}}).blur(function(){var a=true;a=$(this).parents("li.page");(a=j(a,"page"))&&i("page")})});$(document).ready(function(){h("section");$(document).bind("section_deleted",function(a,b){var c=b.eportfolio_category;$("#section_"+c.id).remove();$("#structure_category_"+c.id).remove();h("section")});$(document).bind("section_added section_updated",
function(a,b){var c=b.eportfolio_category,d=$("#section_"+c.id);if(d.length===0){d=$("#section_blank").clone(true).removeAttr("id");$("#section_list").append(d.show())}d.removeClass("unsaved");d.fillTemplateData({data:c,id:"section_"+c.id,hrefValues:["id","slug"]});d=$("#structure_category_"+c.id);if(d.length===0){d=$("#structure_category_blank").clone(true).removeAttr("id");$("#eportfolio_structure").append(d)}d.fillTemplateData({id:"structure_category_"+c.id,data:c});d=$("#category_select_"+c.id);
if(d.length===0){d=$("#category_select_blank").clone(true).removeAttr("id");$("#category_select_blank").before(d.show())}d.attr("id","category_select_"+c.id).val(c.id).text(c.name);h("section")});$(".manage_sections_link,#section_list_manage .done_editing_button").click(function(a){a.preventDefault();if($("#section_list").hasClass("editing")){$("#section_list").sortable("destroy");$("#section_list_manage").removeClass("editing");$("#section_list").removeClass("editing").sortable("disable");$(".arrange_sections_link").text("Manage Sections").val("Manage Sections");
$(".add_section").hide();$("#section_list > li").attr("title","")}else{$("#section_list_manage").addClass("editing");$("#section_list").sortable({axis:"y",helper:"clone",stop:function(b,c){c.item.addClass("just_dropped")},update:function(){var b=$("#section_list").sortable("toArray"),c=[],d;for(d in b){var e=b[d];e=parseInt(e.substring(8));isNaN(e)||c.push(e)}b={order:c.join(",")};$("#section_list").loadingImage({image_size:"small"});$.ajaxJSON($(".reorder_sections_url").attr("href"),"POST",b,function(){$("#section_list").loadingImage("remove")})}});
$("#section_list").addClass("editing").sortable("enable");$(".arrange_sections_link").text("Done Editing").val("Done Editing");$(".add_section").show();$("#section_list > li").attr("title","Drag to Arrange, Click to Edit")}});$(".add_section_link").click(function(a){a.preventDefault();a=$("#section_blank").clone(true).attr("id","section_new");$("#section_list").append(a.show());k(a,"section")});$(".remove_section_link").click(function(a){a.preventDefault();i("section");$(this).parents("li").confirmDelete({message:"Delete this section and all its pages?",
url:$(this).parents("li").find(".rename_section_url").attr("href"),success:function(b){$(this).fadeOut(function(){$(this).remove();$(document).triggerHandler("section_deleted",b);h("section")})}})});$("#section_list").delegate(".edit_section_link","click",function(a){$(this).parents("li").hasClass("unsaved")&&a.preventDefault();if($(this).parents("#section_list").hasClass("editing")){a.preventDefault();a=$(this).parents("li");a.hasClass("just_dropped")?a.removeClass("just_dropped"):k(a,"section")}});
$("#section_name").keydown(function(a){if(a.keyCode==27)i("section");else if(a.keyCode==13){$(this).parents("li").find(".name").text($(this).val());j($(this).parents("li"),"section")&&i("section")}}).blur(function(){var a=true;a=$(this).parents("li.section");(a=j(a,"section"))&&i("section")});$(".download_eportfolio_link").click(function(a){$(this).slideUp();a.preventDefault();$("#export_progress").progressbar().progressbar("option","value",0);var b=$("#downloading_eportfolio_message");b.slideDown();
b.find(".message").text("Collecting ePortfolio resources. this may take a while if you have a lot of files in your ePortfolio...");var c=$(this).attr("href"),d=0,e=function(f){req_url=c;if(f)req_url=c+"?compile=1";$.ajaxJSON(req_url,"GET",{},function(g){if(g.attachment&&g.attachment.file_state&&g.attachment.file_state=="available"){$("#export_progress").progressbar("option","value",100);location.href=c+".zip"}else{if(g.attachment&&g.attachment.file_state){g=parseInt(g.attachment.file_state,10);$("#export_progress").progressbar("option",
"value",Math.max(Math.min($("#export_progress").progressbar("option","value")+0.1,90),g))}else $("#export_progress").progressbar("option","value",Math.min($("#export_progress").progressbar("option","value")+0.1,90));setTimeout(e,2E3)}},function(){d++;d>5?b.find(".message").text("There was an error compiling your eportfolio.  Please try again in a little while."):setTimeout(e,5E3)})};e(true)});$(".download_eportfolio_link").click(function(){$("#downloading_eportfolio_dialog").dialog("close").dialog({autoOpen:false,
title:"Download ePortfolio"}).dialog("open")})})})();
