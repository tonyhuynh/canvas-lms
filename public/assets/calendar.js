(function(){function G(){$(".calendar_month, .calendar_week, .calendar_day, .calendar_undated, .mini_calendar, .mini_calendar_week, .mini_calendar_day").each(function(){if(!$(this).data("drag_position")){var c=$(this),f=c.offset(),g=c.outerWidth(),b=c.outerHeight();if($(this).hasClass(".calendar_week"))b=c.find(".calendar_day:first").outerHeight();$(this).data("drag_position",{offset:f,width:g,height:b})}})}function I(c){c=c.originalEvent;var f=c.pageX,g=c.pageY,b=null,e=null,h=null;if($(".calendar_day_undated").data("drag_position")){if(J){c=
J.data("drag_position");if(f>=c.offset.left&&f<=c.offset.left+c.width&&g>=c.offset.top&&g<=c.offset.top+c.height)return J}$(".calendar_day_undated").each(function(){var a=$(this).data("drag_position");if(f>=a.offset.left&&f<=a.offset.left+a.width&&g>=a.offset.top&&g<=a.offset.top+a.height){h=$(this);return false}});if(h)return h;$(".calendar_month,.mini_calendar").each(function(){var a=$(this).data("drag_position");if(f>=a.offset.left&&f<=a.offset.left+a.width&&g>=a.offset.top&&g<=a.offset.top+a.height){b=
$(this);return false}});if(b){b.find(".calendar_week,.mini_calendar_week").each(function(){var a=$(this).data("drag_position");if(f>=a.offset.left&&f<=a.offset.left+a.width&&g>=a.offset.top&&g<=a.offset.top+a.height){e=$(this);return false}});e&&e.find(".calendar_day,.mini_calendar_day").each(function(){var a=$(this).data("drag_position");if(f>=a.offset.left&&f<=a.offset.left+a.width&&g>=a.offset.top&&g<=a.offset.top+a.height){h=$(this);return false}})}return J=h}}function o(c,f,g){$before=null;f.length===
0&&c.remove();g||f.find(".calendar_event").each(function(){var b=($(this).data("event_data")||{}).time_sortable||"",e=(c.data("event_data")||{}).time_sortable||"";if(b>e){$before=$(this);return false}else if(b==e&&$(this).find(".title").text()>c.find(".title").text()){$before=$(this);return false}});$before&&!g?$before.before(c.show()):f.children("div.calendar_day").append(c.show());return c}function w(c,f){calendarMonths.changeMonth(c,f);c.hasClass("mini_month")||setTimeout(B,500)}function B(){$month=
$(".calendar_container .calendar_month");s($month,true)}function t(c){for(var f in k)calendar.appendToCache(f,[c])}function j(c,f){var g=0,b=[],e=function(h){if(c.length>0){var a=c.shift();g++;if(a){a=r(a,null,f);b.push("#event_"+a)}if(g>50){g=0;setTimeout(function(){e(h)},500)}else e(h)}else h&&b.join(",")};setTimeout(function(){e(true)},10)}function s(c,f,g,b){var e,h=true;if(typeof c=="string"){e=c.split("/");g=e[0];e=e[1];c=$(".calendar_month:first");h=false}else{c.monthLoading();g=parseInt(c.find(".month_number").text(),
10);e=parseInt(c.find(".year_number").text(),10)}var a=monthDataURL.replace("%25m",g).replace("%25y",e).replace(/&amp;/g,"&");b=a+(b==false?"":"&include_undated=1");var d=[];k[a]||(k[a]=[]);k[a].contexts_last_update_at=k[a].contexts_last_update_at||{};k[a].contexts_loading=k[a].contexts_loading||{};var i=null,n=true;$(".calendar_links .group_reference_checkbox:checked").each(function(){var p=$(this).attr("id").substring(6);k[a].contexts_last_update_at[p]||(n=false);if(i!=""&&k[a].contexts_last_update_at[p]){if(!i||
k[a].contexts_last_update_at[p]<i)i=k[a].contexts_last_update_at[p]}else i="";if(!k[a].contexts_loading[p])if(!f||!k[a].contexts_last_update_at[p])d.push(p)});b=b+"&last_update_at="+(i||"");var l={};h&&c.find(".calendar_event").each(function(){if($(this).attr("id"))l[$(this).attr("id")]=true});delete l.event_blank;delete l.event_new;delete l.event_id;if(f&&n&&k[a]&&(k[a].dont_retry||k[a].length>0)){var m=$.merge([],k[a]);if(h){j(m);c.monthLoading("remove")}}else{h&&c.monthLoading("remove");g=[];e=
[];for(m in d){e.push(d[m]);if(e.length>=5){g.push(e);e=[]}}e.length>0&&g.push(e);for(m in g){h&&c.monthLoading();(function(p,q,C){for(var D in p)k[q].contexts_loading[p[D]]=true;C=C+"&only_contexts="+p.join(",");$.ajaxJSON(C,"GET",{},function(F){calendar.appendToCache(q,F);$.each(F,function(W,K){var P=(K.calendar_event||K.assignment).context_code,L=(K.calendar_event||K.assignment).updated_at;if(!calendar.lastUpdate[q]||L>calendar.lastUpdate[q])calendar.lastUpdate[q]=L;if(!k[q].contexts_last_update_at[P]||
L>k[q].contexts_last_update_at[P])k[q].contexts_last_update_at[P]=L});var R=(new Date).toString("u"),M;for(M in p){k[q].contexts_last_update_at[p[M]]=k[q].contexts_last_update_at[p[M]]||R;k[q].contexts_loading[p[M]]=false}if(h){j(F,true);c.monthLoading("remove")}},function(){if(k[q]&&k[q].dont_retry)k[q].dont_retry=false;for(var F in p)k[q].contexts_loading[p[F]]=false;h&&c.monthLoading("remove")})})(g[m],a,b)}}}function r(c,f,g){var b=$.extend({},c.assignment),e=null,h=null;if(c.calendar_event){b=
$.extend({},c.calendar_event);e=$.parseFromISO(b.start_at);h=$.parseFromISO(b.end_at);b.start_time_string=e.time_string;b.end_time_string=h.time_string;b.start_time_formatted=e.time_formatted;b.start_date_string=e.date_formatted;b.end_time_formatted=h.time_formatted;b.time_sortable=e.time_sortable;b.event_type="calendar_event";e="calendar_event_"+b.id;r.details_urls=r.details_urls||{};key="calendar_event_"+b.context_type+b.context_id;if(!r.details_urls[key]){h=S;h=$.replaceTags(h,"context_id",b.context_id);
h=$.replaceTags(h,"context_type",b.context_type.toLowerCase());r.details_urls[key]=h}h=r.details_urls[key]}else{e=$.parseFromISO(b.due_at,"due_date");b.start_time_string=e.time_string;b.end_time_string=e.time_string;b.start_time_formatted=e.time_formatted;b.start_date_string=e.date_formatted;b.end_time_formatted=e.time_formatted;b.time_sortable=e.time_sortable;b.start_at=b.due_at;b.event_type="assignment";e="assignment_"+b.id;r.details_urls=r.details_urls||{};key="assignment_"+b.context_type+b.context_id;
if(!r.details_urls[key]){h=T;h=$.replaceTags(h,"context_id",b.context_id);h=$.replaceTags(h,"context_type",b.context_type.toLowerCase());r.details_urls[key]=h}h=r.details_urls[key];h=$.replaceTags(h,"id",b.id);h=$.replaceTags(h,"context_id",b.context_id);h=$.replaceTags(h,"context_type",b.context_type.toLowerCase())}f&&f.attr("id")=="event_new"&&f.attr("id","event_"+e);if(!b.start_at&&!f&&!calendar.showingUndatedEvents){calendar.hiddenUndatedEvents=calendar.hiddenUndatedEvents||[];calendar.hiddenUndatedEvents.push(c);
U.text(calendar.hiddenUndatedEvents.length)}else{if(!f||f.attr("id")!="event_new"&&f.attr("id")!="event_"+e){f=$("#event_"+e+":visible");if(f.length>0&&f.find(".updated_at").text()==b.updated_at)return}f=$("#event_"+e);var a=$.parseFromISO(b.all_day_date);b.all_day_date="";if(b.all_day){b.start_at=b.all_day_date.substring(0,10);if(a.date_timestamp){b.all_day_date=a.date_formatted;b.start_at=a.date_sortable.substring(0,10)}b.start_time_formatted="";b.end_time_formatted=""}a=managementContexts&&$.inArray(b.context_code,
managementContexts)!=-1;if(b.permissions||a){b.can_edit=a||b.permissions&&b.permissions.update;b.can_delete=a||b.permissions&&b.permissions["delete"]}if(b.workflow_state=="deleted"){f.remove();return e}if(!f||f.length===0){f=V.clone(true);h=$.replaceTags(h,"id",b.id);f.find(".title").attr("href",h);f.toggleClass("assignment",!!c.assignment);g!==true&&f.draggable(N)}f.fillTemplateData({data:{title:b.title},hrefValues:["id"],id:"event_"+e});f.data("event_data",b);f.toggleClass("draggable",b.can_edit);
f.data("description",b.description);f.attr("class");h="group_"+b.context_type.toLowerCase()+"_"+b.context_id;f.addClass(h);f.addClass("event_"+e);a=$(".calendar_undated");if(b.start_at!=null)a=$("#day_"+b.start_at.substring(0,10).replace(/-/g,"_"));f.hasClass("event_pending")||o(f,a,g);g=b.start_time_formatted||"";if(b.start_time_string&&b.start_time_string!=b.end_time_string)g+=" to "+(b.end_time_formatted||"");b=$("<div/>").html(b.title).text();b+=g?" - "+g:"";if(c.assignment&&g)b="due: "+b;f.find(".calendar_event_text").attr("title",
b).show();$("#"+h).length>0&&f.showIf($("#"+h).attr("checked"));return e}}function A(c){$(".calendar_month").each(function(){s($(this),c||false,true,null)})}function O(c,f){var g=$("#event_details"),b=$.extend({},c.getTemplateData({textValues:["id","start_time_string","end_time_string","start_date_string","title","event_type","can_edit","can_delete","context_id","context_type","all_day"],htmlValues:["description"]}),c.data("event_data"));b.description=c.data("description");b.start_time=b.start_time_string;
b.end_time=b.end_time_string;var e={},h="",a="";if(f.find(".day_number").length){h=f.find(".day_number").attr("title").split("/").pop();a=b.start_date_string;a.match(RegExp(h))||(a=a+" "+h)}if(b.all_day=="true"){e=Date.parse(a);b.time_string=$.dateString(e)}else if(b.start_time_string){e=Date.parse(a);b.time_string=$.dateString(e)}else{b.time_string="No Date Set";b.date=""}g.data("current_event",c).data("current_day",f);g.find(".title").attr("href",c.find(".title").attr("href"));g.find(".view_event_link").attr("href",
c.find(".title").attr("href"));g.find(".delete_event_link").attr("href",c.find(".delete_"+b.event_type+"_link").attr("href"));g.find(".edit_event").showIf(b.can_edit);g.find(".delete_event").showIf(b.can_delete);h="Event";c.attr("id")=="event_blank"?$("#edit_event").addClass("new_event"):$("#edit_event").removeClass("new_event");if(b.event_type=="assignment")h="Assignment";if(b.event_type=="assignment"||b.start_time==b.end_time){if(b.all_day=="true"&&b.event_type=="assignment")b.time_string=b.start_date_string+
" at "+b.start_time_string;else if(b.start_time){a=$.dateString(e);b.time_string=a+" at "+b.start_time_string}if(b.event_type=="assignment"&&b.time_string)b.time_string="due: "+b.time_string}b.description=c.data("description");g.fillTemplateData({data:b,htmlValues:["description"]});$("#edit_event").dialog("close");$("#event_details").dialog("close");$("#event_details").find(".description").css("max-height",Math.max($(window).height()-200,150));$("#event_details").show().dialog({title:h+" Details",
width:b.description.length>2E3?Math.max($(window).width()-300,450):450,resizable:true,close:function(){$(document).click();E()},open:function(){$(document).triggerHandler("event_dialog",$(this))},autoOpen:false}).dialog("open").dialog("option","title",h+" Details");c.addClass("selected");y(f.parents(".calendar_day_holder"))}function y(c){$(".calendar_container").data("prevent_hover",true);$(".calendar_day_holder.selected").removeClass("selected");$(".mini_calendar .day.related").removeClass("related");
c.addClass("selected");(c=c.find(".day_number").attr("title"))&&$(".mini_calendar .day.date_"+c.replace(/\//g,"_")).addClass("related")}function E(){$(".calendar_container").data("prevent_hover",false);$(".calendar_day_holder.selected").removeClass("selected");$(".mini_calendar .day.related").removeClass("related")}function x(c,f,g){if(c.attr("id")=="edit_assignment_form")if(c.hasClass("new_event")){c.attr("method","POST");var b=$("#context_urls ."+f+"_add_assignment_url").attr("href")||"";c.find(".more_options_link").attr("href",
$("."+f+"_add_assignment_url").attr("href")+"/new")}else{c.attr("method","PUT");b=$("#context_urls ."+f+"_assignment_url").attr("href")||"";b=$.replaceTags(b,"id",g);c.find(".more_options_link").attr("href",b+"/edit")}else if(c.hasClass("new_event")){c.attr("method","POST");b=$("#context_urls ."+f+"_add_event_url").attr("href")||"";c.find(".more_options_link").attr("href",$("."+f+"_add_event_url").attr("href")+"/new")}else{c.attr("method","PUT");b=$("#context_urls ."+f+"_event_url").attr("href")||
"";b=$.replaceTags(b,"id",g);c.find(".more_options_link").attr("href",b+"/edit")}c.attr("action",b)}function u(c,f){var g=$("#edit_event");$("#edit_event_tabs").show();var b=$.extend({},c.data("event_data"),c.getTemplateData({textValues:["title"]}));b.description=c.data("description");b.context_type=b.context_type||"";b.id=b.id||"";var e=b.context_type.toLowerCase()+"_"+b.context_id;if(!b.context_type||c.attr("id")=="event_blank")e=$("#edit_event select.context_id").val();b.start_time=b.start_time_string||
"";b.end_time=b.end_time_string||"";b.date=f.find(".day_number").attr("title");if(b.all_day=="true"){b.start_time="";b.end_time="";b.date=b.all_day_date}b.due_at="";var h=Date.parse(b.date+" "+b.start_time)||Date.parse(b.date),a=Date.parse(b.date+" "+b.end_time)||Date.parse(b.date);if(h){b.date=h.toString("MMM d, yyyy");b.due_at=$.datetime.clean(h);if(b.start_time_string)b.start_time=h.toString("h:mmtt").toLowerCase();if(b.end_time_string)b.end_time=a.toString("h:mmtt").toLowerCase()}else b.date=
"";h=c.attr("id")=="event_blank";a="Event";var d=null;$("#edit_event,#edit_assignment_form,#edit_calendar_event_form").toggleClass("new_event",h);var i=g.find("#edit_assignment_form").show();i.find("select.context_id").val(e);x(i,e,b.id);var n=g.find("#edit_calendar_event_form").show();n.find("select.context_id").val(e);x(n,e,b.id);if(b.event_type=="assignment"){d=i;a="Assignment"}else d=n;$("#edit_assignment_form,#edit_calendar_event_form").data("event_id",b.id).data("context",e);$("#event_details").data("current_event",
c);$("#edit_assignment_form").data("current_event",c);$("#edit_calendar_event_form").data("current_event",c);$("#edit_assignment_form").fillFormData(b,{object_name:"assignment"});$("#edit_calendar_event_form").fillFormData(b,{object_name:"calendar_event"});$("#event_details").dialog("close");$("#edit_event").dialog("close");y(f.parents(".calendar_day_holder"));$("#edit_event").show().dialog({title:h?"Add New "+a:"Edit "+a,width:400,open:function(){$(document).triggerHandler("edit_event_dialog",g);
var l=g.find("#edit_event_tabs"),m=$("#event_details").data("current_event"),p=$.extend({},m.data("event_data")),q=m.attr("id")=="event_blank",C=$.map($(".group_reference_checkbox:checked"),function(D){return $(D).attr("id").replace("group_","")});$("#edit_event .context_select").each(function(){var D=$(this).find("select.context_id"),F=window.thisElementFiredTheEvent&&($(window.thisElementFiredTheEvent).closest(".group_reference").find(".group_reference_checkbox").attr("id")||"").replace("group_",
"");D.find("option").attr("disabled",function(){return C.length&&$.inArray($(this).val(),C)===-1});if(C.length)D.val(F||C[0]);$(this).showIf(q);D.val(e);D.triggerHandler("change",false)});l.tabs("enable",0);l.tabs("enable",1);m=0;if(p.event_type=="assignment"){m=1;l.tabs("select",1);if(q)l.find(".ui-tabs-nav").show();else{l.find(".ui-tabs-nav").hide();l.tabs("disable",0)}}else{l.tabs("select",0);if(q)l.find(".ui-tabs-nav").show();else{l.find(".ui-tabs-nav").hide();l.tabs("disable",1)}if($("#edit_assignment_form select.context_id option").filter(function(){return!$(this).attr("disabled")}).length===
0){l.tabs("disable",1);m=0}}if(q)m=0;l.tabs("select",m);m==0?$("#edit_calendar_event_form :text:first").focus().select():$("#edit_assignment_form :text:first").focus().select();l.find(".ui-tabs-panel:eq("+l.tabs("option","selected")+") select.context_id").triggerHandler("change");$("#edit_assignment_form").find(".assignment_group_id").val(p.assignment_group_id)},drag:function(){d.hideErrors()},autoSize:true,close:function(){E();var l=$("#edit_event .assignment_group_id");l.length>0&&$("#"+l.attr("id").substring(5)).empty().append(l.children().clone());
l=$("#edit_event_tabs").data("selected.tabs");if($("#edit_event").hasClass("new_event")){var m={};if(l==1){m=$("#edit_assignment_form").getFormData({object_name:"assignment"});m.event_type="assignment";m.start_time_string=m.start_time;m.end_time_string=m.start_time}else{m=$("#edit_calendar_event_form").getFormData({object_name:"calendar_event"});m.event_type="calendar_event";m.start_time_string=m.start_time;m.end_time_string=m.end_time}$("#event_blank").fillTemplateData({data:m})}d.find("input[name='date']").datepicker("hide")},
autoOpen:false,resizable:false,modal:true}).dialog("open").dialog("option","title",h?"Add New "+a:"Edit "+a);if(b.context_id&&b.context_type){h=g.find("#edit_event_tabs");b=(""+b.context_type+"_"+b.context_id).toLowerCase();h.data("group_class")&&h.removeClass(h.data("group_class"));h.addClass("group_"+b).data("group_class","group_"+b)}}function v(c){var f=$(".calendar_container .calendar_day_holder.selected:first");if(!f||f.length===0)z(c);else{var g=f.find(".calendar_event"),b=g.filter(".selected:first");
if(g.length===0){if(c=="down")c="right";else if(c=="up")c="left";z(c)}else if(!b||b.length===0){$(".calendar_event.selected").removeClass("selected");b=c=="up"?f.find(".calendar_event:last"):f.find(".calendar_event:first");b.find("a.title").focus();b.addClass("selected");$("html,body").scrollTo(b)}else if((f=c=="up"?b.prev(".calendar_event"):b.next(".calendar_event"))&&f.length>0){$(".calendar_event.selected").removeClass("selected");f.find("a.title").focus();f.addClass("selected");$("html,body").scrollTo(f)}else{if(c==
"down")c="right";else if(c=="up")c="left";z(c)}}}function z(c){var f=$(".calendar_container .calendar_day_holder.selected:first");if(!f||f.length===0){$(".calendar_container .calendar_day_holder.selected").removeClass("selected");$(".calendar_container .calendar_event.selected").removeClass("selected");f=$(".calendar_container .calendar_day_holder .current_month").eq(0).parent();f.addClass("selected");$("html,body").scrollTo(f)}else{var g=f.parents(".calendar_month"),b=null,e=f.attr("id").split("_");
e=new Date(e[1],e[2]-1,e[3]);if(c=="right"){b=f.next().find(".current_month").parent();if(b.length===0)b=f.parent().next(".visible").find(".calendar_day_holder .current_month").eq(0).parent();if(b.length===0){e.setDate(e.getDate()+1);w(g,1);b=$("#day_"+$.datepicker.formatDate("yy_mm_dd",e))}}else if(c=="left"){b=f.prev().find(".current_month").parent();if(b.length===0)b=f.parent().prev(".visible").find(".calendar_day_holder .current_month").filter(":last").parent();if(b.length===0){e.setDate(e.getDate()-
1);w(g,-1);b=$("#day_"+$.datepicker.formatDate("yy_mm_dd",e))}}else if(c=="up"){c=f.parent().children(".calendar_day_holder").index(f);b=f.parent().prev(".visible").children(".calendar_day_holder").eq(c).find(".current_month").parent();if(b.length===0){e.setDate(e.getDate()-7);w(g,-1);b=$("#day_"+$.datepicker.formatDate("yy_mm_dd",e))}}else if(c=="down"){c=f.parent().children(".calendar_day_holder").index(f);b=f.parent().next(".visible").children(".calendar_day_holder").eq(c).find(".current_month").parent();
if(b.length===0){e.setDate(e.getDate()+7);w(g,1);b=$("#day_"+$.datepicker.formatDate("yy_mm_dd",e))}}if(b&&b.length>0){b.focus();$(".calendar_container .calendar_day_holder.selected").removeClass("selected");$(".calendar_container .calendar_day.hover").removeClass("hover");$(".calendar_container .calendar_event.selected").removeClass("selected");b.addClass("selected");b.find(".calendar_day").addClass("hover");$("html,body").scrollTo(b)}}}function H(){$(".calendar_month").each(function(){$(this).data("days",
$(this).find(".calendar_day_holder"))})}function Q(c){var f=$("#event_details"),g=$.extend({},c.data("event_data")),b=g.context_type.toLowerCase()+"_"+g.context_id,e="Are you sure you want to delete this event?";if(g.event_type=="assignment")e="Are you sure you want to delete this assignment?";var h=$("."+b+"_event_url").attr("href");if(g.event_type=="assignment")h=$("."+b+"_assignment_url").attr("href");h=$.replaceTags(h,"id",g.id);c.confirmDelete({url:h,message:e,confirmed:function(){f.dialog("close");
$(this).dim()},success:function(){$(document).triggerHandler("delete_event");$(this).fadeOut(function(){$(this).remove();var a=c.attr("id").split("_").pop(),d=c.hasClass("assignment")?"assignment":"calendar_event";calendar.removeFromCache({asset_string:d+"_"+a})})}})}window.calendar={viewItem:function(){},showingUndatedEvents:false,appendToCache:function(c,f){var g={};k[c]=k[c]||[];$.each(f,function(b,e){var h=null;h=e.calendar_event?"calendar_event_"+e.calendar_event.id:"assignment_"+e.assignment.id;
g[h]=e});$.each(k[c],function(b,e){var h=null;h=e.calendar_event?"calendar_event_"+e.calendar_event.id:"assignment_"+e.assignment.id;if(g[h]){k[c][b]=g[h];g[h]=null}});$.each(g,function(b,e){e&&k[c].push(e)})},removeFromCache:function(c){for(var f in k){for(var g=$.merge([],k[f]),b=[],e=false,h=0;h<g.length;h++){var a=g[h].assignment?"assignment":"calendar_event";a=a+"_"+g[h][a].id;if(c.asset_string&&c.asset_string==a)e=true;else b.push(g[h])}if(e)k[f]=b}},lastUpdate:{}};var J=null,N={helper:function(){var c=
$(this).outerWidth(),f=$(this).clone();f.width(c).css("zIndex",20);$(this).parents(".calendar_container").append(f);return f},scroll:true,drag:function(c,f){if(!$.browser.msie){var g=I(c,f);if(!(g&&g.hasClass("drop_target"))){$(".drop_target").removeClass("drop_target");g&&g.closest(".calendar_day_holder,.mini_calendar_day").addClass("drop_target")}}},start:function(c){$(document).data("dragging",true);$(this).parents(".calendar_day_holder").addClass("selected");if($(this).hasClass("event_pending")||
!($(this).data("event_data")||{}).can_edit){c.preventDefault();c.stopPropagation();return false}setTimeout(G,50);$(this).addClass("event_pending")},stop:function(c,f){$(document).data("dragging",false);$("td.selected").removeClass("selected");$(".drop_target").removeClass("drop_target");var g=I(c,f),b=$(this);if(g&&g[0]!=b.parents(".calendar_day")[0]){var e=$.extend({},b.getTemplateData({textValues:["start_date_string","start_time_string","end_time_string","event_type","id","context_id","context_type",
"all_day"]}),b.data("event_data")),h=e.context_type.toLowerCase()+"_"+e.context_id,a,d,i=e.event_type;if(e.all_day=="true"){e.start_time_string="";e.end_time_string=""}if(g.hasClass("calendar_day_undated"))d=a=null;else{b.parents(".calendar_day").find(".day_number").attr("title");var n=g.find(".day_number").attr("title");a=$.parseDateTime(n,e.start_time_string);d=$.parseDateTime(n,e.end_time_string)}n=$("#context_urls ."+h+"_event_url").attr("href");if(i=="assignment"){e=$.extend(e,$.formatDateTime(a,
{object_name:"assignment",property_name:"due_at"}));n=$("#context_urls ."+h+"_assignment_url").attr("href")}else{e=$.extend(e,$.formatDateTime(a,{object_name:"calendar_event",property_name:"start_at"}));e=$.extend(e,$.formatDateTime(d,{object_name:"calendar_event",property_name:"end_at"}))}n=$.replaceTags(n,"id",e.id);console.log(g);var l=null;if(g.hasClass("mini_calendar_day")){l=g.find(".day_number").attr("title")||"";if(h=Date.parse(l))g=$("#day_"+h.toString("yyyy_MM_dd")).find(".calendar_day")}o(b,
g.parent());$.ajaxJSON(n,"PUT",e,function(m){b.removeClass("event_pending");r(m);t(m);if(!g.length&&l)$.flashMessage((b.find(".title").text()||"event")+" was moved to "+l)})}else $(this).removeClass("event_pending")}},k={};$.fn.monthLoading=function(c){$.fn.monthLoading.cnt=Math.max($.fn.monthLoading.cnt||0,0);if(c)$.fn.monthLoading.cnt--;else $.fn.monthLoading.cnt++;this.find(".refresh_calendar_link").find(".static").showIf($.fn.monthLoading.cnt<=0).end().find(".animated").showIf($.fn.monthLoading.cnt>
0);return this};var S=$("#event_details").find(".calendar_event_url").attr("href"),T=$("#event_details").find(".assignment_url").attr("href"),V=$("#event_blank"),U=$(".show_undated_link .undated_count");$(document).ready(function(){$(".calendar_day.today").removeClass("today");$("#day_"+(new Date).toString("yyyy_MM_dd")).children(".calendar_day").addClass("today");$(".show_undated_link").click(function(a){a.preventDefault();calendar.showingUndatedEvents=true;$(".undated_link").hide();events=(calendar.hiddenUndatedEvents||
[]).sort(function(d,i){var n=(d.calendar_event||d.assignment||{}).title||"",l=(i.calendar_event||i.assignment||{}).title||"";return n<l?0:l>n?1:0});j(events||[],true);$(".undated_content").show()});$("#edit_calendar_event_form .more_options_link").click(function(a){a.preventDefault();a=$(this).attr("href").split("#");var d=$("#edit_calendar_event_form").getFormData({object_name:"calendar_event"}),i={};if(d.title)i.title=d.title;if(d.date){i.start_at=d.date+" "+(d.start_time||"");i.end_at=d.date+" "+
(d.end_time||"")}i.return_to=location.href;a[0]+="?"+$.param(i);location.href=a.join("#")});$(".calendar_event").live("mouseover",function(){!$(this).hasClass("ui-draggable")&&$(this).hasClass("draggable")&&$(this).draggable(N)});$("#edit_assignment_form .more_options_link").click(function(a){a.preventDefault();a=$(this).attr("href").split("#");var d=$("#edit_assignment_form").getFormData({object_name:"assignment"}),i={};if(d.title)i.title=d.title;if(d.due_at)i.due_at=d.due_at;if(d.assignment_group_id)i.assignment_group_id=
d.assignment_group_id;i.return_to=location.href;a[0]+="?"+$.param(i);location.href=a.join("#")});$(".calendar_feed_link").click(function(a){a.preventDefault();$("#calendar_feed_box").find(".calendar_feed_url").val($(this).attr("href")).end().find(".show_calendar_feed_link").attr("href",$(this).attr("href"));$("#calendar_feed_box").dialog("close").dialog({title:"Calendar Feed",width:375,autoOpen:false}).dialog("open")});$("#calendar_feed_box .calendar_feed_url").focus(function(){$(this).select()});
$(".calendar_day_holder").focus(function(){$(".calendar_container .calendar_day.hover").removeClass("hover");$(".calendar_container .calendar_event.selected").removeClass("selected");$(this).find(".calendar_day").addClass("hover")});$(".calendar_event a").focus(function(){$(".calendar_container .calendar_day.hover").removeClass("hover");$(".calendar_container .calendar_event.selected").removeClass("selected");$(this).parents(".calendar_event").addClass("selected");$(this).parents(".calendar_day").addClass("hover")});
$("#edit_event select.context_id").change(function(a,d){var i=$(this).val(),n=$("#"+i+"_assignment_groups").clone(true).attr("id","temp_"+i+"_assignment_groups");attachAddAssignmentGroup(n,$("#context_urls ."+i+"_add_assignment_group_url").attr("href"));$(this).parents("form").find(".assignment_group_select").empty().append(n);n=$(this).parents("form");var l=n.data("event_id");x(n,i,l);d!==false&&$(this).parents("#edit_event").find("select.context_id").not($(this)).val($(this).val()).triggerHandler("change",
false);n=$(this).closest("#edit_event");n.data("group_class")&&n.removeClass(n.data("group_class"));n.addClass("group_"+i).data("group_class","group_"+i)});$("#edit_assignment_form .datetime_field, #edit_calendar_event_form .datetime_field").datetime_field();$("#edit_calendar_event_form .time_field").time_field().blur(function(){var a=$("#edit_calendar_event_form .time_field.start_time").next(".datetime_suggest").text();if($("#edit_calendar_event_form .time_field.start_time").next(".datetime_suggest").hasClass("invalid_datetime"))a=
null;a=a||$("#edit_calendar_event_form .time_field.start_time").val();var d=$("#edit_calendar_event_form .time_field.end_time").next(".datetime_suggest").text();if($("#edit_calendar_event_form .time_field.end_time").next(".datetime_suggest").hasClass("invalid_datetime"))d=null;d=d||$("#edit_calendar_event_form .time_field.end_time").val();a=Date.parse(a);d=Date.parse(d);a=a||d;d=d||a;if($(this).hasClass("end_time")){if(a>d)a=d}else if(d<a)d=a;a&&$("#edit_calendar_event_form .time_field.start_time").val(a.toString("h:mmtt").toLowerCase());
d&&$("#edit_calendar_event_form .time_field.end_time").val(d.toString("h:mmtt").toLowerCase())});$("#edit_calendar_event_form .date_field").date_field();$("#edit_event_form input[name='date']").datepicker();$(".calendar_month").delegate(".next_month_link","click",function(a){a.preventDefault();a=$(".calendar_month .month_name").text()+" "+$(".calendar_month .year_number").text();a=Date.parse(a)||new Date;a.setMonth(a.getMonth()+1);var d={};try{d=JSON.parse($.decodeFromHex(location.hash.substring(1)))}catch(i){d=
{}}d.month=a.getMonth()+1;d.year=a.getFullYear();location.replace("#"+$.encodeToHex(JSON.stringify(d)))}).delegate(".prev_month_link","click",function(a){a.preventDefault();a=$(".calendar_month .month_name").text()+" "+$(".calendar_month .year_number").text();a=Date.parse(a)||new Date;a.setMonth(a.getMonth()-1);var d={};try{d=JSON.parse($.decodeFromHex(location.hash.substring(1)))}catch(i){d={}}d.month=a.getMonth()+1;d.year=a.getFullYear();location.replace("#"+$.encodeToHex(JSON.stringify(d)))});
var c=parseInt($("#max_calendar_count").text(),10)||10,f=function(){f.log=true};setInterval(function(){if(f.log){f.log=false;monthDataURL.replace("%25m",0).replace("%25y",0).replace(/&amp;/g,"&");var a=[];$(".calendar_links .group_reference_checkbox:checked").each(function(){var d=$(this).attr("id").substring(6);a.push(d)});$.store.userSet("checked_calendar_codes",a.join(","))}},1E3);$(".group_reference_checkbox").bind("change click",function(){var a=this;setTimeout(function(){$("."+$(a).attr("id")+
":not(.group_reference)").showIf($(a).attr("checked"));$(".calendar_links .group_reference_checkbox:checked").length>c&&$(".calendar_links .group_reference_checkbox:checked").not(a).filter(":first").attr("checked",false).change();$(a).attr("checked")&&A(true);f();$(".calendars_open_count").text($(".calendar_links .group_reference_checkbox:checked").length)},10)}).filter(":last").change();$(".calendar_container").delegate(".calendar_day","mouseover",function(a){if(!$(a.liveFired||$(this).parents(".calendar_container")).data("prevent_hover")){$(".calendar_day.hover").removeClass("hover");
$(this).addClass("hover");(a=$(this).find(".day_number").attr("title"))&&!$(document).data("dragging")&&$(".mini_calendar .day.date_"+a.replace(/\//g,"_")).addClass("related")}}).delegate(".calendar_day","mouseout",function(a){if(!$(a.liveFired||$(this).parents(".calendar_container")).data("prevent_hover")){$(this).removeClass("hover");(a=$(this).find(".day_number").attr("title"))&&$(".mini_calendar .day.date_"+a.replace(/\//g,"_")).removeClass("related")}});$(".mini_month").delegate(".next_month_link",
"mousedown",function(a){a.preventDefault();w($(a.liveFired||$(this).parents(".mini_month")),1)}).delegate(".prev_month_link","mousedown",function(a){a.preventDefault();w($(a.liveFired||$(this).parents(".mini_month")),-1)}).delegate(".next_month_link,.prev_month_link","click",function(a){a.preventDefault()}).delegate(".day_number","click",function(a){a.preventDefault();var d=$(this).attr("title");w($(a.liveFired||$(this).parents(".mini_month")),d);w($(".calendar_container .calendar_month"),d)});$(document).click(function(){var a=
$(this);$(".calendar_container .calendar_event.selected").each(function(){$(this).parent()[0]!=a[0]&&$(this).removeClass("selected")});$(".calendar_container .calendar_day_holder.selected").each(function(){$(this)[0]!=a.parent()[0]&&$(this).removeClass("selected")})});$(".calendar_event").live("click",function(a){a.preventDefault();a.stopPropagation();$(".calendar_day_holder.selected,.calendar_event.selected").removeClass("selected");O($(this),$(this).parents(".calendar_day"))});$(".calendar_container").delegate(".calendar_day",
"click",function(a){if(!($(a.target).closest(".calendar_event").length>0)){a.preventDefault();a.stopPropagation();if(canCreateEvent){u($("#event_blank"),$(this));var d=($(".group_reference_checkbox:checked:first").attr("id")||"").replace(/^group_/,"");d||(d=($(".group_reference.default_context").find(".group_reference_checkbox").attr("id")||"").replace(/^group_/,""));d&&$("#edit_event .context_select select.context_id").each(function(){$(this).val(d);if(this.selectedIndex<0)this.selectedIndex=0;$(this).triggerHandler("change",
false)})}}});$(document).delegate(".add_event_link","click",function(a){window.thisElementFiredTheEvent=this;a.preventDefault();u($("#event_blank"),$(this));a=($(this).closest(".group_reference").find(".group_reference_checkbox").attr("id")||"").replace("group_","");$("#edit_event .context_select select.context_id").val(a).triggerHandler("change",false);window.thisElementFiredTheEvent=undefined});$(document).keycodes("ctrl+left ctrl+right ctrl+up ctrl+down",function(a){a.preventDefault();a.stopPropagation();
z(a.keyString.substring(5))});$(document).keycodes("j k o d e n r",function(a){a.preventDefault();a.stopPropagation();var d=$(".calendar_event.selected:first"),i=$(".calendar_day_holder.selected:first");if(a.keyString=="j")v("down");else if(a.keyString=="k")v("up");else if(a.keyString=="o")d.click();else if(a.keyString=="d")d.length>0&&d.find(".can_delete").text()=="true"&&Q(d);else if(a.keyString=="e")d.length>0&&d.find(".can_edit").text()=="true"&&u(d,i.children(".calendar_day"));else if(a.keyString==
"n")u($("#event_blank"),i.children(".calendar_day"));else a.keyString=="r"&&A()});$("#edit_calendar_event_form").formSubmit({object_name:"calendar_event",required:["title"],processData:function(a){if(a.start_time)if(!a.end_time)a.end_time=a.start_time;var d=Date.parse(a.date+" "+a.start_time);a.start_at="";a.end_at="";if(d){a.time_sortable=d.toString("HH:mm");a.event_date_string=d.toString("yyyy_MM_dd");a.start_at=$.datetime.process(d);a.start_time=d.toString("hh:mmtt").toLowerCase()}else{a.time_sortable=
"0";a.event_date_string=null}if(a.start_time&&!a.end_time)a.end_time=a.start_time;if(d=Date.parse(a.date+" "+a.end_time)){a.end_at=$.datetime.process(d);a.end_time=d.toString("hh:mmtt").toLowerCase()}a["calendar_event[start_at]"]=a.start_at;a["calendar_event[end_at]"]=a.end_at;return a},beforeSubmit:function(a){var d=$(this).data("current_event");if(!d)return false;if(d.attr("id")=="event_blank"){d=d.clone(true).attr("id","event_new");d.draggable(N)}a=$.extend(a,$(this).getFormData({object_name:"calendar_event"}));
a.start_time_string=a.start_time;a.end_time_string=a.end_time;a.event_type="calendar_event";d.fillTemplateData({data:a});var i=$(this).find("select.context_id").val();d.addClass("group_"+i);$("#group_"+i).attr("checked",true).change();d.find(".calendar_event_text").attr("title",a.title);d.addClass("event_pending");i=$(".calendar_undated");if(a.event_date_string)i=$("#day_"+a.event_date_string);o(d,i);$("#edit_event").dialog("close");return d},success:function(a,d){d.removeClass("event_pending");$(document).triggerHandler("add_event",
d);r(a,d);t(a)}});$("#edit_calendar_event_form input[name='date'],#edit_assignment_form input[name='date']").change(function(){$(".calendar_day.hover").removeClass("hover");$(".calendar_day_holder.selected").removeClass("selected");var a=$(this).val().split("/"),d=null;if(a.length==3)d=a[2]+"_"+a[0]+"_"+a[1];d&&y($("#day_"+d))});$("#edit_assignment_form").formSubmit({object_name:"assignment",required:["title"],processData:function(a){var d=Date.parse(a.due_at);a.time_sortable="0";a.event_date_string=
"";a.start_time="";if(d){a["assignment[due_at]"]=$.datetime.process(d);a.time_sortable=d.toString("HH:mm");a.event_date_string=d.toString("yyyy_MM_dd");a.start_time=d.toString("hh:mmtt").toLowerCase()}a.start_time_string=a.start_time;a.end_time_string=a.start_time;a.event_type="assignment";return a},beforeSubmit:function(a){var d=$(this).data("current_event");if(!d)return false;if(d.attr("id")=="event_blank"){d=d.clone(true).attr("id","event_new");d.draggable(N)}var i=$(this).find("select.context_id").val();
d.addClass("group_"+i);$("#group_"+i).attr("checked",true).change();d.find(".calendar_event_text").attr("title",a.title);d.fillTemplateData({data:a});d.find(".calendar_event_text").attr("title",a.title);d.addClass("event_pending");o(d,$("#day_"+a.event_date_string));$("#edit_event").dialog("close");return d},success:function(a,d){d.removeClass("event_pending");$(document).triggerHandler("add_event",d);r(a,d);t(a)}});$(".refresh_calendar_link").click(function(a){a.preventDefault();a=$(this).parents(".calendar_month");
a.length>0?s(a):A()});$("#event_details").delegate(".edit_event_link","click",function(a){a.preventDefault();var d=$("#event_details");a=d.data("current_event");d=d.data("current_day");a&&d&&u(a,d)}).delegate(".delete_event_link","click",function(a){a.preventDefault();a=$("#event_details").data("current_event");Q(a)});$(document).fragmentChange(function(a,d){if(d.indexOf("#calendar_event_")==0||d.indexOf("#assignment_")==0){var i="event_"+d.substring(1);i=$("#"+i);if(i.length>0){i.addClass("selected");
$("html,body").scrollTo(i.parents(".calendar_day"));i.click()}}});$("#edit_event_tabs").tabs().bind("tabsselect",function(a,d){$(document).triggerHandler("event_tab_select",d.index);$(d.panel).find("select.context_id").triggerHandler("change")});var g=$.store.userGet("checked_calendar_codes");if(g){g=g.split(/,/);var b=0,e;for(e in g){var h=$("#group_"+g[e]);h.attr("checked",true);h.length>0&&b++}b==0&&$(".group_reference .group_reference_checkbox:lt(10)").each(function(){$(this).attr("checked",true)})}else $(".group_reference .group_reference_checkbox:lt(10)").each(function(){$(this).attr("checked",
true)});setTimeout(A,3E3);setInterval(A,6E5);setTimeout(H,1E3)});$(function(){$("#right-side").delegate(".group_reference","mouseenter mouseleave",function(c){$(this).find(".add_event_link").showIf(c.type==="mouseenter"&&$(this).find(".group_reference_checkbox").attr("checked"))})});$(function(){$(document).fragmentChange(function(){var c=null;try{c=JSON.parse($.decodeFromHex(document.location.hash.substring(1)))}catch(f){}if(c&&c.month&&parseInt(c.month,10)&&c.year&&parseInt(c.year,10)){var g=$(".calendar_month .month_name").text()+
" "+$(".calendar_month .year_number").text();g=Date.parse(g)||new Date;var b=Date.parse(c.month+" "+c.year)||new Date;if(!(b.getMonth()==g.getMonth()&&b.getFullYear()==g.getFullYear())){g=$.datepicker.formatDate("mm/dd/yy",b);w($(".calendar_month"),g);w($(".calendar_container").find(".mini_month"),g)}}if(c&&c.show){var e=c.show.split(","),h=!e&&!e.length,a=false,d=[];$(".group_reference_checkbox").each(function(){var i=this.checked;a=(this.checked=$.inArray($(this).attr("id"),e)>-1||h)||a;this.checked!=
i&&d.push(this)});!a&&e!="nothing"&&$(".group_reference_checkbox").each(function(){var i=this.checked;this.checked=true;this.checked!=i&&d.push(this)});$.each(d,function(){$(this).triggerHandler("change","dontUpdateFragment")})}});$(".group_reference_checkbox").bind("change click",function(){setTimeout(function(){if(c==="dontUpdateFragment")return true;var c=null;try{c=JSON.parse($.decodeFromHex(document.location.hash.substring(1)))}catch(f){}var g=[];$(".group_reference_checkbox:checked").each(function(){g.push($(this).attr("id"))});
var b={};b.show=g.join(",")||"nothing";var e=$(".calendar_month:first .month_number").text(),h=$(".calendar_month:first .year_number").text();b.month=c&&c.month||e;b.year=c&&c.year||h;location.replace("#"+$.encodeToHex(JSON.stringify(b)))},10)})})})(jQuery);
var calendarMonths=function(){function G(o){return{day:o.getDate(),month:o.getMonth(),year:o.getFullYear()}}var I=["January","February","March","April","May","June","July","August","September","October","November","December"];return{changeMonth:function(o,w){o.data("calendar_objects");var B={},t=null;if(typeof w=="string")(t=$.datepicker.parseDate("mm/dd/yy",w))&&t.setDate(1);if(!t){var j=parseInt(o.find(".month_number").text(),10),s=parseInt(o.find(".year_number").text(),10);t=new Date(s,j+w-1,1)}B=
{month_name:I[t.getMonth()],month_number:t.getMonth()+1,year_number:t.getFullYear()};o.fillTemplateData({data:B});j=new Date;B=G(j);var r=G(t);j=t;j.setDate(0);j.setDate(j.getDate()-j.getDay());s=G(j);var A=null;if(r.day!=s.day){j.setDate(1);j.setMonth(j.getMonth()+1);j.setDate(0);A={day:j.getDate(),month:s.month,year:s.year};j.setDate(1);j.setMonth(j.getMonth()+1)}j.setMonth(t.getMonth()+1);j.setDate(0);t={day:j.getDate(),month:r.month,year:r.yearh};j.setDate(j.getDate()+1);j.setDate(j.getDate()+
(6-j.getDay()));j.setDate(j.getDate()+7);var O=G(j),y=o.data("days");if(!y){y=o.find(".calendar_day_holder");o.data("days",y)}if(o.hasClass("mini_month"))y=o.find(".day");o.find(".calendar_event").remove();var E=0,x=s.day;j=s.month;for(s=s.year;x<=O.day||j!=O.month;){var u=y.eq(E);if(u.length>0){for(var v=u.attr("class").split(" "),z=[],H=0;H<v.length;H++)v[H].indexOf("date_")!=0&&z.push(v[H]);u.attr("class",z.join(" "))}u.show().addClass("visible").parents("tr").show().addClass("visible");v=j<9?
"0"+(j+1):j+1;z=x<10?"0"+x:x;id="day_"+s+"_"+v+"_"+z;if(o.hasClass("mini_month"))id="mini_"+id;u.attr("id",id).find(".day_number").text(x).attr("title",v+"/"+z+"/"+s).addClass("date_"+v+"_"+z+"_"+s);v=u.children("div");if(o.hasClass("mini_month"))v=u;v.removeClass("current_month other_month today");j==r.month?v.addClass("current_month"):v.addClass("other_month");j==B.month&&x==B.day&&s==B.year&&v.addClass("today");x++;E++;if(A&&x>A.day&&j==A.month||x>t.day&&j==t.month){j+=1;if(j>=12){j-=12;s++}x=
1}}for(;E<y.length;){u=y.eq(E);u.parents("tr").hide().removeClass("visible");u.hide().removeClass("visible");E++}o.hasClass("mini_month")}}}();
