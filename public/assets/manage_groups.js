var contextGroups={autoLoadGroupThreshold:15,studentGroupsCategoryName:$.encodeToHex("Student Groups"),loadMembersForGroup:function(a){var b=$("#manage_group_urls .list_users_url").attr("href"),c=a.getTemplateData({textValues:["group_id"]}).group_id;b=$.replaceTags(b,"id",c);a.find(".load_members_link").hide();a.find(".loading_members").show();$.ajaxJSON(b,"GET",null,function(d){a.find(".student").remove();for(var f=$(".user_template"),g=0;g<d.length;g++){var e=d[g],h=f.clone();h.removeClass("user_template");
h.addClass("user_id_"+e.user_id);h.fillTemplateData({data:e});contextGroups.insertIntoGroup(h,a);a.find(".user_count_hidden").text("0");$(window).triggerHandler("resize");contextGroups.updateCategoryCounts(a.parents(".group_category"))}a.find(".loading_members").hide()})},loadUnassignedMembersPage:function(a,b){if(!(b<0&&a.data("page_loaded"))){b=Math.abs(b);if(b==0)b=a.data("page_loaded")||1;var c=a.closest(".group_category").find(".category_name").first().text(),d=$("#manage_group_urls .list_unassigned_users_url").attr("href");
d+="?category="+encodeURIComponent(c)+"&page="+b;a.find(".load_members_link").hide();a.find(".loading_members").text("Loading...");a.find(".loading_members").show();$.ajaxJSON(d,"GET",null,function(f){a.data("page_loaded",b);a.find(".user_count").text(f.total_entries);a.find(".user_count_label").text(f.total_entries==1?"student":"students");a.find(".user_count_hidden").text(f.total_entries-f.users.length);a.find(".group_user_count").show();a.find(".student").remove();for(var g=$(".user_template"),
e=f.users,h=0;h<e.length;h++){var k=e[h],j=g.clone();j.removeClass("user_template");j.addClass("user_id_"+k.user_id);j.fillTemplateData({data:k});contextGroups.insertIntoGroup(j,a)}a.find(".loading_members").html(f.pagination_html);a.find(".unassigned_members_pagination a").click(function(i){i.preventDefault();match=/page=(\d+)/.exec($(this).attr("href"));if(match.length>=1){i=match[1];contextGroups.loadUnassignedMembersPage($(this).closest(".group_blank").first(),i)}});$(window).triggerHandler("resize")})}},
moveToGroup:function(a,b){if(a.parents(".group")[0]!=b[0]){var c=b.getTemplateData({textValues:["group_id"]}).group_id,d=a.getTemplateData({textValues:["user_id"]}).user_id,f=a.parents(".group"),g=$("#manage_group_urls .add_user_url").attr("href");method="POST";if(!c||c.length==0){g=$("#manage_group_urls .remove_user_url").attr("href");method="DELETE";c=f.getTemplateData({textValues:["group_id"]}).group_id}g=$.replaceTags(g,"id",c);c={user_id:d};a.remove();var e=a;contextGroups.insertIntoGroup(a,
b);if(b.parents(".group_category").attr("id")==contextGroups.studentGroupsCategoryName&&b.get(0)!==b.parents(".group_category").find(".group_blank").get(0)){var h=a.clone();e=e.add(h);contextGroups.insertIntoGroup(h,f)}a=e;a.addClass("event_pending");contextGroups.updateCategoryCounts(b.parents(".group_category"));$.ajaxJSON(g,method,c,function(k){var j=$.encodeToHex(b.parents(".group_category").getTemplateData({textValues:["category_name"]}).category_name);$(".student.user_"+d).each(function(){var l=
$(this).find("."+j+"_group_id");if(!l||l.length==0){l=$(document.createElement("span"));l.addClass(j+"_group_id");$(this).find(".data").append(l)}l.text(k.group_membership.group_id||"")});a.removeClass("event_pending");contextGroups.updateCategoryCounts(b.parents(".group_category"));var i=b.parents(".group_category").find(".group_blank"),m=i.find(".student_list .student").length,n=parseInt(i.find(".user_count_hidden").text());m<=5&&n>0&&contextGroups.loadUnassignedMembersPage(i,0)})}},insertIntoGroup:function(a,
b){var c=null,d=a.getTemplateData({textValues:["name","user_id"]}),f=d.name;if(!(b.find(".student_list .user_id_"+d.user_id).length>0)){b.find(".student.user_"+d.user_id).remove();b.find(".student_list .student").each(function(){if($(this).getTemplateData({textValues:["name"]}).name>f){c=$(this);return false}});c?c.before(a):b.find(".student_list").append(a);a.draggable({helper:function(){var g=$(this).clone().css("cursor","pointer");g.addClass("dragging");g.width($(this).width());$(this).parents(".group_category").append(g);
return g}})}},updateCategoryCounts:function(a){a.find(".group").each(function(){var d=$(this).find(".student_list .student").length+parseInt($(this).find(".user_count_hidden").text());$(this).find(".user_count").text(d);$(this).find(".user_count_label").text(d==1?"student":"students")});var b=a.find(".group:not(.group_blank)").length,c=b==1?"Group":"Groups";a.find(".group_count").text(b+" "+c);a.find(".group").each(function(){$(this).find(".expand_collapse_links").showIf($(this).find(".student_list li").length>
0)})},populateCategory:function(a){a=$(a);a.find(".group").each(function(){var b=parseInt($(this).find(".user_count_hidden").text());b<contextGroups.autoLoadGroupThreshold&&b>0&&contextGroups.loadMembersForGroup($(this))});contextGroups.loadUnassignedMembersPage(a.find(".group_blank"),-1)},addGroupToSidebar:function(a){if(!($("#sidebar_group_"+a.id).length>0)){var b=$("#sidebar_category_"+$.encodeToHex(a.category));if(b.length==0){b=$("#sidebar_category_blank").clone(true);b.find("ul").empty();b.fillTemplateData({data:a,
id:"sidebar_category_"+$.encodeToHex(a.category)});$(".sidebar_category:last").after(b.show())}var c=$("#sidebar_group_blank").clone(true);c.fillTemplateData({data:a,hrefValues:["id"],id:"sidebar_group_"+a.id});b.find("ul").append(c.show());$("#category_header").show()}},droppable_options:{accept:".student",hoverClass:"hover",tolerance:"pointer",drop:function(a,b){$(".group_category > .student").remove();contextGroups.moveToGroup($(b.draggable),$(this))}}},addGroupCategory;
$(document).ready(function(){$("li.student").live("mousedown",function(a){a.preventDefault();return false});$("#group_tabs").tabs();$("#group_tabs").bind("tabsselect",function(a,b){contextGroups.populateCategory(b.panel)});$(".group").filter(function(){return $(this).parents("#category_template").length==0}).droppable(contextGroups.droppable_options);$(".add_group_link").click(function(a){a.preventDefault();a=$(this).parents(".group_category");var b=$("#category_template").find(".group_blank").clone(true);
b.removeAttr("id");b.find(".student_list").empty();b.removeClass("group_blank");b.find(".load-more").hide();b.find(".name").text("Group Name");a.find(".clearer").before(b.show());b.find(".edit_group_link").click()});$("#edit_group_form").formSubmit({object_name:"group",processData:function(a){a["group[category]"]=$(this).parents(".group_category").getTemplateData({textValues:["category_name"]}).category_name;return a},beforeSubmit:function(a){var b=$(this).parents(".group");$(this).remove();b.removeClass("editing");
b.loadingImage();b.fillTemplateData({data:a,avoid:".student_list"});return b},success:function(a,b){var c=a.group||a.course_assigned_group;b.loadingImage("remove");b.droppable(contextGroups.droppable_options);b.find(".name.blank_name").hide().end().find(".group_name").show();b.find(".group_user_count").show();c.group_id=c.id;b.fillTemplateData({id:"group_"+c.id,data:c,avoid:".student_list",hrefValues:["id"]});contextGroups.addGroupToSidebar(c);contextGroups.updateCategoryCounts(b.parents(".group_category"))}});
$(".edit_group_link").click(function(a){a.preventDefault();a=$(this).parents(".group");var b=a.getTemplateData({textValues:["name","max_membership"]}),c=$("#edit_group_form").clone(true);c.fillFormData(b,{object_name:"group"});a.addClass("editing");a.prepend(c.show());c.find(":input:visible:first").focus().select();a.attr("id")?c.attr("method","PUT").attr("action",a.find(".edit_group_link").attr("href")):c.attr("method","POST").attr("action",$("#manage_group_urls .add_group_url").attr("href"));a.length>
0&&a.parents(".group_category").scrollTo(a)});$("#edit_group_form .cancel_button").click(function(){var a=$(this).parents(".group");$(this).parents(".group").removeClass("editing");$(this).parents("form").remove();a.attr("id")||a.remove()});$(".delete_category_link").click(function(a){a.preventDefault();var b=$("#group_tabs").tabs("option","selected");if(b==-1)b=$("#category_list li").index($("#category_list li.ui-tabs-selected"));$(this).parents(".group_category").confirmDelete({url:$(this).attr("href"),
message:"Are you sure you want to remove this set of groups?",success:function(){$("#group_tabs").tabs("remove",b);$("#group_tabs").showIf($("#category_list li").length>0);var c=$(this).getTemplateData({textValues:["category_name"]}).category_name;$("#sidebar_category_"+$.encodeToHex(c)).slideUp(function(){$(this).remove()});$("#no_groups_message").showIf($("#category_list li").length==0)}})});$(".add_category_link").click(function(a){a.preventDefault();addGroupCategory(function(b){$("#group_tabs").show();
$("#no_groups_message").hide();var c=$("#category_template").clone(true).removeAttr("id"),d=$("#category_template").find(".group_blank");c.find(".group").droppable(contextGroups.droppable_options);var f={},g;for(g in b){var e=b[g].group||b[g].course_assigned_group;e.group_id=e.id;f.category_name=e.category;$group=d.clone(true).removeClass("group_blank");$group.attr("id","group_"+e.id);if(!e.users||e.users.length==0)$group.find(".load-more").hide();$group.droppable(contextGroups.droppable_options);
e.user_count=e.users.length;e.user_count_hidden=e.users.length;$group.fillTemplateData({id:"group_"+e.id,data:e,avoid:".student_list",hrefValues:["id"]});c.find(".clearer").before($group);contextGroups.addGroupToSidebar(e);if(e.users){var h=$.encodeToHex(e.category),k;for(k in e.users){var j=e.users[k].user,i=$(document.createElement("span")).addClass(h+"_group_id");i.text(e.id);$(".student.user_"+j.id).find(".data").append(i)}}$group.find(".name.blank_name").hide().end().find(".group_name").show();
$group.find(".group_user_count").show()}c.fillTemplateData({data:f,hrefValues:["category_name"]});b=$(this).data("category_name");d=$.encodeToHex(b);c.attr("id",d);c.find(".category_name").text(b);f=$("#group_tabs").tabs("length");if($("li.category").last().find("a").attr("href")=="#"+contextGroups.studentGroupsCategoryName)f-=1;$("#group_tabs").append(c);$("#group_tabs").tabs("add","#"+d,b,f);$("#group_tabs").tabs("select",f);contextGroups.populateCategory(c);contextGroups.updateCategoryCounts(c);
$(window).triggerHandler("resize")})});$(".load_members_link").click(function(a){a.preventDefault();contextGroups.loadMembersForGroup($(this).parents(".group"))});$(".delete_group_link").click(function(a){a.preventDefault();$(this).parents(".group").confirmDelete({message:"Are you sure you want to delete this group?",url:$(this).attr("href"),success:function(){var b=$(this).parents(".group_category").find(".group_blank"),c=$(this).getTemplateData({textValues:["group_id"]}).group_id;$("#sidebar_group_"+
c).slideUp(function(){$(this).remove()});$(this).slideUp(function(){var d=$(this).parents(".group_category");d.attr("id")!=contextGroups.studentGroupsCategoryName&&$(this).find(".student").each(function(){contextGroups.insertIntoGroup($(this),b)});$(this).remove();contextGroups.updateCategoryCounts(d)})}})});$(".assign_students_link").click(function(a){a.preventDefault();if(confirm("This will randomly assign all unassigned students evenly among the existing student groups")){var b=$(this).parents(".group_category").find(".group:not(.group_blank)");
b.each(function(){$(this).data("student_count",$(this).find(".student").length)});var c=[];$(this).parents(".group_category").find(".group_blank").find(".student").each(function(){c.push($(this))});c.sort(function(){return Math.random()-0.5});$.each(c,function(){var d=-1,f=null;b.each(function(){if(d==-1||$(this).data("student_count")<d){d=$(this).data("student_count");f=$(this)}});if(f){contextGroups.moveToGroup($(this),f);f.data("student_count",f.data("student_count")+1)}})}});contextGroups.populateCategory($("#group_tabs .group_category:first"));
$(window).resize(function(){if($(".group_category:visible:first").length!=0){var a=$(".group_category:visible:first").offset().top,b=$(window).height();$(".group_category").height(b-a-40);var c=$(".group_category:visible:first"),d=c.offset().top;c=c.find(".left_side").offset().top;$(".group_category").find(".right_side,.left_side").height(b-a-40-(c-d)+10)}}).triggerHandler("resize");$(".group_category .group").find(".expand_group_link").click(function(a){a.preventDefault();$(this).hide().parents(".group").find(".student_list").slideDown().end().find(".load-more").slideDown().end().find(".collapse_group_link").show()}).end().find(".collapse_group_link").click(function(a){a.preventDefault();
$(this).hide().parents(".group").find(".student_list").slideUp().end().find(".load-more").slideUp().end().find(".expand_group_link").show()});$(".group_category").find(".expand_groups_link").click(function(a){a.preventDefault();$(this).parents(".group_category").find(".expand_group_link").click()});$(".group_category").find(".collapse_groups_link").click(function(a){a.preventDefault();$(this).parents(".group_category").find(".collapse_group_link").click()});$(".group").hover(function(){$(this).addClass("group-hover")},
function(){$(this).removeClass("group-hover")});$(".group_category").each(function(){contextGroups.updateCategoryCounts($(this))});$("#tabs_loading_wrapper").show()});
