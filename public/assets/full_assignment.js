var wikiSidebar,hideFullAssignmentForm,addGroupCategory;
jQuery(function(a){function n(b){a("#"+b).editorBox("focus")||setTimeout(function(){n(b)},500)}function m(){var b=a("#full_assignment"),c=a("#edit_assignment_form");if(c.css("display")==="none"){var d=b.getTemplateData({textValues:["title","due_date_string","due_time_string","points_possible","points_type"]});if(d.description=="No Content")d.description="";d.due_date=d.due_date_string;d.due_time=d.due_time_string;var e=Date.parse(a.trim(d.due_date+" "+d.due_time));d.due_at=a.parseFromISO(e&&e.toISOString()).datetime_formatted;
c.find("select[name='points_type']").change();c.fillFormData(d,{object_name:"assignment"});b.find(".description, .edit_full_assignment_link").hide();c.show().find("textarea:first").editorBox();if(wikiSidebar){wikiSidebar.attachToEditor(c.find("textarea:first"));wikiSidebar.show();a("#sidebar_content").hide()}c.find(".more_options_link").show();c.find(".more_assignment_values").hide();setTimeout(function(){n(c.find("textarea:first").attr("id"))},500);c.parents(".ui-dialog").length||a("html,body").scrollTo(c);
setTimeout(function(){c.find(".assignment_type").change()},500)}}hideFullAssignmentForm=function(){var b=a("#full_assignment");a("#edit_assignment_form").hide();if(wikiSidebar){wikiSidebar.hide();a("#sidebar_content").show()}b.find(".description").show();b.find(".edit_full_assignment_link").show()};wikiSidebar&&wikiSidebar.init();var h=a("#edit_assignment_form");h.find(".more_options_link").click(function(b){b.preventDefault();h.find(".more_options_link").hide();h.find(".more_assignment_values").show()});
a(".edit_full_assignment_link").click(function(b){b.preventDefault();m()});h.find(".time_field").timepicker();h.find(".date_field").datetime_field();h.find(".assignment_type").change(function(){var b=a(this).val();h.find(".assignment_content").showIf(b=="assignment"||b=="discussion_topic");h.find(".submission_content").showIf(b=="assignment");h.find(".quiz_content").showIf(b=="quiz");h.find(".discussion_topic_content").showIf(b=="discussion_topic");h.find(".not_graded_content").showIf(b=="not_graded");
h.find(".more_assignment_values.assignment_content").showIf((b=="assignment"||b=="discussion_topic")&&!h.find(".more_options_link:visible").length)}).triggerHandler("change");h.find(".points_possible").change(function(){var b=parseFloat(a(this).val());if(isNaN(b)||!isFinite(b))a(this).val("");else{var c=a("#edit_assignment_form"),d=c.getFormData({object_name:"assignment"}),e=a(this).data("old_value"),g={};g.points_possible=b;if(!d.mastery_score||e&&d.mastery_score==Math.round(e*7.5)/10)g.mastery_score=
Math.round(b*7.5)/10;if(!d.max_score||d.max_score==e)g.max_score=b;d.min_score||(g.min_score=0);c.fillFormData(g,{object_name:"assignment",call_change:false});a(this).data("old_value",b)}}).change();a(".more_grading_options_link").click(function(){var b=a(this).hasClass("hide_options");a(this).toggleClass("hide_options").text(b?"more grading options":"hide grading options");a(".more_grading_options").showIf(!b);return false});a(".switch_full_assignment_view").click(function(){h.find("textarea:first").editorBox("toggle");
return false});h.find(".submission_type_option").change(function(){h.find(".online_submission_types").showIf(a(this).val()=="online")}).change();h.formSubmit({required:["title"],object_name:"assignment",property_validations:{unlock_at:function(b,c){var d=Date.parse(c.unlock_at),e=Date.parse(c.due_at);if(d&&e&&d>e)return"The assignment should be unlocked before it's due"},lock_at:function(b,c){var d=Date.parse(c.lock_at),e=Date.parse(c.due_at);if(d&&e&&d<e)return"The assignment shouldn't be locked again until after the due date"},
"=submission_type":function(b,c){if(b=="online")if(!c.online_upload&&!c.online_text_entry&&!c.online_url&&!c.media_recording)return"Please choose at least one type of online submission"}},processData:function(b){var c;if(a(this).find(".more_grading_options").css("display")=="none"){delete b["assignment[min_score]"];delete b["assignment[max_score]"];delete b["assignment[mastery_score]"];delete b.never_drop}a.each(["unlock_at","lock_at","due_at"],function(d,e){if(e=="due_at"||b["assignment["+e+"]"])if(c=
Date.parse(b["assignment["+e+"]"]))b["assignment["+e+"]"]=c.toString("yyyy-MM-ddTHH:mm:ss")});a.extend(b,{"assignment[submission_types]":b.submission_type,due_date:a.dateString(c),description:a(this).find("textarea:first").editorBox("get_code"),"assignment[description]":b.description});if(b.submission_type=="online")b["assignment[submission_types]"]=a.map(["online_upload","online_text_entry","online_url","media_recording"],function(d){return b[d]&&d}).join(",")||"none";if(b.assignment_type=="quiz")b["assignment[submission_types]"]=
"online_quiz";if(b.assignment_type=="not_graded")b["assignment[submission_types]"]="not_graded";if(b.assignment_type=="discussion_topic")b["assignment[submission_types]"]="discussion_topic";return b},beforeSubmit:function(b){hideFullAssignmentForm();return a("#full_assignment").fillTemplateData({data:a.extend(a(this).getFormData({object_name:"assignment"}),{description:a(this).find("textarea:first").editorBox("get_code"),due_date_string:b.due_date,due_time_string:b.due_time}),htmlValues:["description"]}).loadingImage()},
success:function(b,c){var d=b.assignment,e=a.parseFromISO(d.due_at,"due_date");c=a("#full_assignment");a.extend(d,{due_date:e.date_formatted,due_time:e.time_formatted,timestamp:e.timestamp,due_date_string:e.date_string,due_time_string:e.time_string,lock_at:a.parseFromISO(d.lock_at).datetime_formatted,unlock_at:a.parseFromISO(d.unlock_at).datetime_formatted});c.find(".quiz_content").showIf(d.submission_types=="online_quiz"&&d.quiz);c.find(".discussion_topic_content").showIf(d.submission_types=="discussion_topic"&&
d.discussion_topic);a("#turnitin_enabled").showIf(d.turnitin_enabled);a(".readable_submission_types").text(d.readable_submission_types||"").showIf(d.readable_submission_types);d.quiz&&a.extend(d,{quiz_id:d.quiz.id,quiz_title:d.quiz.title});d.discussion_topic&&a.extend(d,{discussion_topic_id:d.discussion_topic.id,discussion_topic_title:d.discussion_topic.title});a(this).find("textarea:first").editorBox("set_code",d.description);a(this).fillFormData(d,{object_name:"assignment"});c.fillTemplateData({data:d,
htmlValues:["description"]});a("#full_assignment_holder").find(".points_text").showIf(d.points_possible||d.points_possible===0);c.find(".assignment_quiz_link").attr("href",a.replaceTags(c.find(".assignment_quiz_url").attr("href"),"quiz_id",d.quiz_id));c.find(".assignment_topic_link").attr("href",a.replaceTags(c.find(".assignment_topic_url").attr("href"),"discussion_topic_id",d.discussion_topic_id));c.loadingImage("remove");a(this).triggerHandler("assignment_updated",b);a("#full_assignment_holder .redirect_on_finish_url").ifExists(function(){window.location.href=
a(this).attr("href")+"#assignment_"+d.id})},error:function(b,c){m();c.loadingImage("remove");h.formErrors(b)}});h.find(".cancel_button").click(function(){hideFullAssignmentForm(true)});h.find("select.grading_type").change(function(){h.find(".edit_letter_grades_link").showIf(a(this).val()=="letter_grade")});h.find("#auto_peer_reviews,#manual_peer_reviews").change(function(){h.find(".auto_peer_reviews").showIf(a("#auto_peer_reviews").attr("checked"))}).change();h.find(".edit_letter_grades_link").click(function(b){b.preventDefault();
a("#edit_letter_grades_form").dialog("close").dialog({title:"View/Edit Grading Scheme",autoOpen:false,width:600,height:300}).dialog("open")});a(".rubric .long_description_link").click(function(b){b.preventDefault();if(!a(this).parents(".rubric").hasClass("editing")){b=a(this).parents(".criterion").getTemplateData({textValues:["long_description","description"]});var c=a("#rubric_long_description_dialog");c.fillTemplateData({data:b});c.find(".editing").hide();c.find(".displaying").show();c.dialog("close").dialog({autoOpen:false,
title:"Criterion Long Description",width:400}).dialog("open")}});a(".grading_standard .edit_grading_standard_link").click(function(b){b.preventDefault();b=a(this).parents(".grading_standard");b.addClass("editing");a(this).hasClass("read_only")&&b.attr("id","grading_standard_blank");b.find(".grading_standard_row").each(function(){var c=a(this).getTemplateData({textValues:["max_score","name"]});a(this).find(".standard_value").val(c.max_score).end().find(".standard_name").val(c.name)});b.find(":text:first").blur()});
a(".grading_standard .grading_standard_brief").find(".collapse_data_link,.expand_data_link").click(function(b){b.preventDefault();b=a(this).parents(".grading_standard_brief");b.find(".collapse_data_link,.expand_data_link").toggle();b.find(".details").slideToggle()});a(".grading_standard .grading_standard_select a").click(function(b){b.preventDefault();b=a(this).parents(".grading_standard_select").getTemplateData({textValues:["id"]}).id;a(".grading_standard .grading_standards_select .grading_standard_select").removeClass("selected_side_tab");
a(this).parents(".grading_standard_select").addClass("selected_side_tab");a(".grading_standard .grading_standards .grading_standard_brief").hide();a("#grading_standard_brief_"+b).show()});a(".grading_standard").find(".find_grading_standard_link,.cancel_find_grading_standard_link").click(function(b){b.preventDefault();a(this).parents(".grading_standard").find(".display_grading_standard,.find_grading_standard").toggle();var c=a(this).parents(".grading_standard").find(".find_grading_standard:visible");
if(c.length>0&&!c.hasClass("loaded")){c.find(".loading_message").text("Loading Grading Standards...");b=c.find(".grading_standards_url").attr("href");a.ajaxJSON(b,"GET",{},function(d){if(d.length===0)c.find(".loading_message").text("No grading standards found");else{c.find(".loading_message").remove();for(var e in d){var g=d[e].grading_standard;g.user_name=g.display_name;var f=c.find(".grading_standards_select .grading_standard_select.blank:first").clone(true);f.fillTemplateData({data:g});c.find(".grading_standards_select").append(f.show());
f=c.find(".grading_standard_brief.blank:first").clone(true);f.fillTemplateData({data:g,id:"grading_standard_brief_"+g.id});f.removeClass("blank");for(var j=0;j<g.data.length;j++){var i=g.data[j];i={name:i[0],value:Math.round(i[1]*100),next_value:100};if(g.data[j-1])i.next_value=Math.round(g.data[j-1][1]*100)-1;var k=f.find(".details_row.blank:first").clone(true);k.removeClass("blank");k.fillTemplateData({data:i});f.find(".details > table").append(k.show())}c.find(".grading_standards").append(f)}c.find(".grading_standards_select .grading_standard_select:visible:first a:first").click()}c.addClass("loaded");
c.find(".grading_standards_holder").slideDown()},function(){c.find(".loading_message").text("Loading Grading Standards Failed.  Please Try Again")})}});a(".grading_standard .grading_standard_brief .select_grading_standard_link").click(function(b){b.preventDefault();b=a(this).parents(".grading_standard_brief").getTemplateData({textValues:["id"]}).id;var c=a(this).parents(".grading_standard_brief").getTemplateData({textValues:["title"]}).title,d=[];a(this).parents(".grading_standard_brief").find(".details_row:not(.blank)").each(function(){var e=
a(this).find(".name").text(),g=parseInt(a(this).find(".value").text(),10)/100;if(isNaN(g))g="";d.push([e,g])});a(this).parents(".grading_standard").triggerHandler("grading_standard_updated",{id:b,data:d,title:c});a(this).parents(".grading_standard").find(".edit_grading_standard_link").addClass("read_only");a(this).parents(".find_grading_standard").find(".cancel_find_grading_standard_link").click()});a(".grading_standard .cancel_button").click(function(){a(this).parents(".grading_standard").removeClass("editing").find(".insert_grading_standard").hide();
var b=a(this).parents(".grading_standard");b.find(".to_add").remove();b.find(".to_delete").removeClass("to_delete").show()});a(".grading_standard").bind("grading_standard_updated",function(b,c){var d=a(this);d.addClass("editing");d.find(".update_grading_standard_url").attr("href",a("#update_grading_standard_url").attr("href"));d.fillTemplateData({data:c,id:"grading_standard_"+c.id,hrefValues:["id"]});var e=d.find(".insert_grading_standard:first").clone(true),g=d.find(".grading_standard_row:first").clone(true).removeClass("blank"),
f=d.find(".grading_standard_data");f.empty();f.append(e.clone(true).show());for(var j in c.data){var i=g.clone(true),k=c.data[j];i.removeClass("to_delete").removeClass("to_add");i.find(".standard_name").val(k[0]).end().find(".standard_value").val(k[1]*100);f.append(i.show());f.append(e.clone(true).show())}f.find(":text:first").blur();f.append(g.hide());f.append(e.hide());d.find(".grading_standard_row").each(function(){a(this).find(".name").text(a(this).find(".standard_name").val()).end().find(".max_score").text(a(this).find(".standard_value").val()).end().find(".min_score").text(a(this).find(".edit_min_score").text())});
d.removeClass("editing");d.find(".insert_grading_standard").hide();d={"assignment[grading_standard_id]":c.id,"assignment[grading_type]":"letter_grade"};a.ajaxJSON(a("#edit_assignment_form").attr("action"),"PUT",d,function(){},function(){})});a(".grading_standard .save_button").click(function(){var b=a(this).parents(".grading_standard"),c=a("#edit_letter_grades_form .create_grading_standard_url").attr("href"),d="POST";if(b.attr("id")!="grading_standard_blank"){c=a(this).parents(".grading_standard").find(".update_grading_standard_url").attr("href");
d="PUT"}var e=b.find(".standard_title,.grading_standard_row:visible").getFormData();b.loadingImage();a.ajaxJSON(c,d,e,function(g){g=g.grading_standard;b.loadingImage("remove");b.triggerHandler("grading_standard_updated",g)})});a(".grading_standard thead").mouseover(function(){if(a(this).parents(".grading_standard").hasClass("editing")){a(this).parents(".grading_standard").find(".insert_grading_standard").hide();a(this).parents(".grading_standard").find(".insert_grading_standard:first").show()}});
a(".grading_standard .grading_standard_row").mouseover(function(b){if(a(this).parents(".grading_standard").hasClass("editing")){a(this).parents(".grading_standard").find(".insert_grading_standard").hide();b=b.pageY;var c=a(this).offset(),d=a(this).height();b>c.top+d/2?a(this).next(".insert_grading_standard").show():a(this).prev(".insert_grading_standard").show()}});a(".grading_standard .insert_grading_standard_link").click(function(b){b.preventDefault();if(!(a(this).parents(".grading_standard").find(".grading_standard_row").length>
40)){b=a(this).parents(".grading_standard");for(var c=b.find(".grading_standard_row:first").clone(true).removeClass("blank"),d=b.find(".insert_grading_standard:first").clone(true),e=null;!e||a(".standard_name[name='grading_standard[standard_data][scheme_"+e+"][name]']").length>0;)e=Math.round(Math.random()*1E4);c.find(".standard_name").val("-").attr("name","grading_standard[standard_data][scheme_"+e+"][name]");c.find(".standard_value").attr("name","grading_standard[standard_data][scheme_"+e+"][value]");
a(this).parents(".insert_grading_standard").after(c.show());c.after(d);b.find(":text:first").blur();c.find(":text:first").focus().select();c.addClass("to_add")}});a(".grading_standard .delete_row_link").click(function(b){b.preventDefault();if(!(a(this).parents(".grading_standard").find(".grading_standard_row:visible").length<2)){b=a(this).parents(".grading_standard_row");b.prev(".insert_grading_standard").length>0?b.prev(".insert_grading_standard").remove():b.next(".insert_grading_standard").remove();
b.fadeOut(function(){a(this).addClass("to_delete")})}});a(".grading_standard input[type='text']").bind("blur change",function(){var b=a(this).parents(".grading_standard"),c=parseInt(a(this).parents(".grading_standard_row").find(".standard_value").val(),10);if(isNaN(c))c=null;var d=c||100;c=c||0;var e=b.find(".grading_standard_row:not(.blank,.to_delete)");for(b=e.index(a(this).parents(".grading_standard_row"))+1;b<e.length;b++){var g=e.eq(b),f=parseInt(g.find(".standard_value").val(),10);if(isNaN(f))f=
null;if(b==0)f=100;else if(!f||f>d-2)f=d-2;g.find(".standard_value").val(f);d=f}for(b=e.index(a(this).parents(".grading_standard_row"))-1;b>=0;b--){g=e.eq(b);f=parseInt(g.find(".standard_value").val(),10);if(isNaN(f))f=null;if(b==0)f=100;else if(!f||f<c+2)f=c+2;c=f;g.find(".standard_value").val(f)}d=100;e.each(function(j){var i=parseInt(a(this).find(".standard_value").val(),10);j=e.index(this);if(isNaN(i))i=null;if(j==0)i=100;else if(!i||i>d-2)i=d-2;a(this).find(".standard_value").val(i);d=i});c=
0;for(b=e.length-1;b>=0;b--){g=e.eq(b);f=parseInt(g.find(".standard_value").val(),10);if(isNaN(f))f=null;if(b==0)f=100;else if(!f||f<c+2)f=c+2;c=f;g.find(".standard_value").val(f)}e.each(function(j){j=e.eq(j+1);var i=0;if(j&&j.length>0){i=parseInt(j.find(".standard_value").val(),10)+1;if(isNaN(i))i=0;a(this).find(".edit_min_score").text(i)}});e.filter(":last").find(".edit_min_score").text(0)});h.find(":input").keycodes("esc",function(b){b.preventDefault();a(this).parents("form").find(".cancel_button").click()});
var l=h.find("#assignment_assignment_group_id");attachAddAssignmentGroup(l);if(editIfNoContent){l=a.trim(a("#full_assignment").find(".description").text());if(!l||l==""||l=="No Content")setTimeout(m,500)}a("#assignment_group_assignment").change(function(){a("#assignment_group_category").showIf(a(this).attr("checked"));a(this).attr("checked")||a("#assignment_group_category").val("")}).change();a("#assignment_peer_reviews").change(function(){a("#assignment_peer_reviews_options").showIf(a(this).attr("checked"));
a(this).attr("checked")||a("#assignment_peer_reviews_options :text").val("")}).change();a.scrollSidebar();a("#assignment_group_category_select").change(function(){var b=a(this);a(this).val()=="new"&&addGroupCategory&&addGroupCategory(function(){var c=a(this).data("category_name")||"Category",d=a(document.createElement("option"));d.text(c).val(c);b.find("option:last").before(d);b.val(c.toLowerCase().replace(/\s/g,"_"))})});a("#assignment_online_upload").change(function(){a("#restrict_file_extensions_options").showIf(a(this).attr("checked"))}).change();
a("#assignment_restrict_file_extensions").change(function(){var b=a("#allowed_extensions_options");if(a(this).attr("checked"))b.show();else{b.hide();a("#assignment_allowed_extensions").val("")}}).change();setTimeout(function(){if(a("#full_assignment_holder").hasClass("editing")){a(".edit_full_assignment_link:first").click();a("#full_assignment_holder .more_options_link:first").click()}},500)});
