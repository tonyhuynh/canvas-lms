(function(b){var o=b("#email_lists_processed_person_template").removeAttr("id").detach(),p=b("#user_emails_no_valid_emails"),q=b("#user_emails_with_errors"),i=b("#email_lists_processed_people"),r=b("#user_emails_duplicates_found"),c=b("#enroll_users_form"),s=b("#enrollment_blank").removeAttr("id").hide(),t=b("#email_lists_path").attr("href"),g=INST.EmailLists={init:function(){g.showTextarea();c.find(".cancel_button").click(function(){b(".add_users_link").show();c.hide()}).end().find(".go_back_button").click(g.showTextarea).end().find(".verify_syntax_button").click(function(a){a.preventDefault();
g.showProcessing();a={user_emails:b("#user_emails_textarea_container textarea").val().replace(/;/g,",")};b.ajaxJSON(t,"POST",a,g.showResults)}).end().submit(function(a){a.preventDefault();a.stopPropagation();c.find(".add_users_button").text("Adding Users...").attr("disabled",true);a=c.getFormData();var h=c.attr("action"),d={student_enrollment:"Students",teacher_enrollment:"Teachers",ta_enrollment:"TAs"}[a.enrollment_type]||"Users",j=[],f=0,k=0,n=function(){if(f==k)if(j.length){successCount=f-j.length;
var e=[successCount,"out of",f,d,"added"].join(" ");e+=".  The following addresses had problems:<br/><span style='font-size:0.8em;'>"+j.join(",")+"</span>";b.flashError(e,2E4)}else b.flashMessage([f,d,"added"].join(" "));else setTimeout(n,500)},m=[];b("#email_lists_processed_people .person").each(function(){var e={};e.name=b.trim(b(this).find(".name").text());e.email=b.trim(b(this).find(".address").text());m.push(e)});k=m.length;for(var u in m){var l=m[u];a=c.getFormData();a.user_emails=l.email;if(l.name)a.user_emails=
'"'+l.name.replace(/\"/g,"'")+'" <'+l.email+">";b.ajaxJSON(h,"POST",a,function(e){f+=1;if(!e||!e.length)return false;var v=b.underscore(e[0].enrollment.type);c.find(".user_emails").val("");g.showTextarea();b.each(e,function(){g.addUserToList(this.enrollment,v)})},function(){f+=1;j.push(l.email)})}setTimeout(n,500)});c.find("#enrollment_type").change(function(){b("#limit_priveleges_to_course_section_holder").showIf(b(this).val()=="TeacherEnrollment"||b(this).val()=="TaEnrollment")}).change();b(".unenroll_user_link").click(function(a){a.preventDefault();
a.stopPropagation();b(this).hasClass("cant_unenroll")?alert("This user was automatically enrolled using the campus enrollment system, so they can't be manually removed.  Please contact your system administrator if you have questions."):b(this).parents(".user").confirmDelete({message:"Are you sure you want to remove this user?",url:b(this).attr("href"),success:function(){b(this).fadeOut(function(){g.updateCounts()})}})})},showTextarea:function(){c.find(".add_users_button, .go_back_button, #user_emails_parsed").hide();
c.find(".verify_syntax_button, .cancel_button, #user_emails_textarea_container").show().removeAttr("disabled");c.find(".user_emails").removeAttr("disabled").loadingImage("remove").focus().select();c.find(".verify_syntax_button").attr("disabled",false).text("Continue...")},showProcessing:function(){c.find(".verify_syntax_button").attr("disabled",true).text("Processing...");c.find(".user_emails").attr("disabled",true).loadingImage()},showResults:function(a){c.find(".add_users_button, .go_back_button, #user_emails_parsed").show();
c.find(".add_users_button").attr("disabled",false).text("OK Looks Good, Add These "+a.addresses.length+" Users");c.find(".verify_syntax_button, .cancel_button, #user_emails_textarea_container").hide();c.find(".user_emails").removeAttr("disabled").loadingImage("remove");i.html("").show();if(!a||!a.addresses||!a.addresses.length){p.appendTo(i);c.find(".add_users_button").hide()}else{a.errored_addresses&&a.errored_addresses.length&&q.appendTo(i).find(".addresses_count").html(a.addresses.length).end().find(".errors_count").html(a.errored_addresses.length);
if(a.duplicates&&a.duplicates.length)r.appendTo(i).find(".duplicate_count").html(a.duplicates.length).end().find(".duplicates_plurality").html(a.duplicates.length>1?"es":"");b.each(a.addresses,function(){o.clone(true).fillTemplateData({data:this}).appendTo(i).show()})}},updateCounts:function(){b.each(["student","teacher","ta","teacher_and_ta","student_and_observer"],function(){b("."+this+"_count").text(b("."+this+"_enrollments .user:visible").length)})},addUserToList:function(a,h){var d=b(".user_list."+
h+"s");d.length||(d=h=="student_enrollment"||h=="observer_enrollment"?b(".user_list.student_and_observer_enrollments"):b(".user_list.teacher_and_ta_enrollments"));d.find(".none").remove();a.invitation_sent_at="Just Now";try{a.name=a.user.last_name_first||a.user.name;a.pseudonym_id=a.user.pseudonym.id;a.communication_channel_id=a.user.pseudonym.communication_channel.id}catch(j){}var f=null;d.find(".user").each(function(){var k=b(this).getTemplateData({textValues:["name"]}).name;if(k&&a.name&&k.toLowerCase()>
a.name.toLowerCase()){f=b(this);return false}});if(!b("#enrollment_"+a.id).length){a.pseudonym_id=a.users_pseudonym_id;d=s.clone(true).fillTemplateData({textValues:["name"],id:"enrollment_"+a.id,hrefValues:["id","user_id","pseudonym_id","communication_channel_id"],data:a}).addClass(h).removeClass("nil_class user_").addClass("user_"+a.user_id).toggleClass("pending",a.workflow_state!="active")[f?"insertBefore":"appendTo"](f||d).show().animate({backgroundColor:"#FFEE88"},1E3).animate({display:"block"},
2E3).animate({backgroundColor:"#FFFFFF"},2E3,function(){b(this).css("backgroundColor","")});d.parents(".user_list").scrollToVisible(d)}g.updateCounts()}};b(INST.EmailLists.init)})(jQuery,INST);
