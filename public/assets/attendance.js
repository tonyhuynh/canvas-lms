var datagrid={};
(function(){datagrid={columns:[],rows:[],dataRows:[],dataFragment:document.createDocumentFragment(),cells:{},divs:{},init:function(a,b){var c=b.onReady,f=b.tick,e=b.maxWidth||150;datagrid.borderSize=b.borderSize||1;if(b.scroll&&$.isFunction(b.scroll))datagrid.scrollCallback=b.scroll;datagrid.table=a;var g=a.find("tr:first td"),d=a.find("tr"),h=0;g.each(function(i){var l=$(this);datagrid.columns[i]=l;l.metrics={};l.metrics.width=Math.min(l.width(),e)+5;l.metrics.outerWidth=Math.min(l.outerWidth(),e)+
5;h+=l.metrics.width});var k=0;d.each(function(i){var l=$(this);datagrid.rows[i]=l;l.metrics={};l.metrics.outerHeight=l.find("td:first").outerHeight();l.metrics.height=l.find("td:first").height();k+=l.metrics.height});f&&$.isFunction(f)&&f();datagrid.divs.all=$(".datagrid");datagrid.divs.topleft=$("#datagrid_topleft");datagrid.divs.left=$("#datagrid_left");datagrid.divs.top=$("#datagrid_top");datagrid.divs.data=$("#datagrid_data");datagrid.divs.filler=$("#datagrid_filler");datagrid.divs.topleft.width(datagrid.columns[0].metrics.width+
datagrid.borderSize);datagrid.divs.left.width(datagrid.columns[0].metrics.width+datagrid.borderSize);datagrid.divs.filler.width(h-datagrid.columns[0].metrics.width);datagrid.divs.top.height(datagrid.rows[0].metrics.height+datagrid.borderSize);datagrid.divs.topleft.height(datagrid.rows[0].metrics.height+datagrid.borderSize);datagrid.divs.filler.height(k-datagrid.rows[0].metrics.height);datagrid._initializeListeners();datagrid._templateCellHTML=b.templateCellHTML;datagrid.sizeToWindow();$(window).resize(datagrid.sizeToWindow);
var j=datagrid._createRow(0,true);j.append(datagrid._createCell(0,0,a.find("tr:first td:first")));datagrid.divs.topleft.children(".content:first").append(j);j=datagrid._createRow(0);j.width(h-datagrid.columns[0].metrics.width+datagrid.columns.length);a.find("tr:first").children("td:not(:first)").each(function(i){j.append(datagrid._createCell(0,i+1,$(this)))});datagrid.divs.top.children(".content:first").append(j);f&&$.isFunction(f)&&f();var n=false,m=function(i){if(!n){j=datagrid._createRow(i+1,true);
j.append(datagrid._createCell(i+1,0,$(this).find("td:first")));datagrid.divs.left.children(".content:first").append(j)}j=datagrid._createRow(i+1);$(this).children("td:not(:first)").each(function(l){datagrid._createCell(i+1,l+1,$(this));datagrid._placeDataCell(i+1,l+1)});datagrid._placeDataRow(i+1)},p=[],u=0;a.find("tr:not(:first)").each(function(i){var l=0;j=datagrid._createRow(i+1,true);j.append(datagrid._createCell(i+1,0,$(this).find("td:first")));datagrid.divs.left.children(".content:first").append(j);
j=datagrid._createRow(i+1);j.width(h-datagrid.columns[0].metrics.width+datagrid.columns.length-1);$(this).children("td:not(:first)").each(function(v){l+=datagrid.columns[v+1].metrics.width});datagrid._placeDataRow(i+1);u+=datagrid.rows[i+1].metrics.height;p.push($(this))});n=true;datagrid._placeDataFragment();b&&b.onViewable&&$.isFunction(b.onViewable)&&b.onViewable.call(this);var q=0,o=function(i){try{f&&$.isFunction(f)&&i&&f();if(q<p.length){i=q;q++;m.call(p[i],i);setTimeout(function(){o(true)},
1)}else if(i&&!o.finished){o.finished=true;datagrid.initialized=true;a.hide();datagrid.ready&&$.isFunction(datagrid.ready)&&datagrid.ready();c&&$.isFunction(c)&&c()}}catch(l){INST.log_error({Msg:l.toString()})}};setTimeout(function(){o(true)},5);setTimeout(function(){o(false)},5);setTimeout(function(){o(false)},5);setTimeout(function(){o(false)},5);var r=datagrid.divs.top.children(".content:first"),s=datagrid.divs.left.children(".content:first"),t=false;setInterval(function(){if(t){if(r.length===
0)r=datagrid.divs.top.children(".content:first");if(s.length===0)s=datagrid.divs.left.children(".content:first");r.css("left",0-datagrid.divs.data.scrollLeft());s.css("top",0-datagrid.divs.data.scrollTop());datagrid.scrollCallback&&datagrid.scrollCallback();t=false}},100);datagrid.divs.data.bind("scroll",function(){t=true});datagrid.mouseHasMoved=true;$(document).mousemove(function(){datagrid.mouseHasMoved=true});$(document).keycodes("up down left right tab shift+tab",function(i){if(!($(i.target).closest(".ui-dialog").length>
0)){i.preventDefault();i.stopPropagation();if(i.keyString=="right"||i.keyString=="tab")datagrid.moveRight();else if(i.keyString=="down")datagrid.moveDown();else if(i.keyString=="up")datagrid.moveUp();else if(i.keyString=="left"||i.keyString=="shift+tab")datagrid.moveLeft()}})},_initializeListeners:function(){datagrid.divs.all.delegate(".cell","mousemove",datagrid._cellMove).delegate(".cell","mouseover",datagrid._cellOver).delegate(".cell","mouseout",datagrid._cellOut).delegate(".cell","click",datagrid._cellClick)},
titles:function(a){var b=[],c;for(c in a)b.push(datagrid.cells["0,"+a[c]].find(".assignment_title").text()||"--")},reorderColumns:function(a){for(var b={},c=[],f=[],e=0;e<a.length;e++)f[e]=e;for(var g=0;g<a.length;g++){var d=a[g];for(e=0;e<datagrid.rows.length;e++){var h=datagrid.cells[e+","+d];if(f[g]!=d)f[g]<d?datagrid.cells[e+","+f[g]].before(h):datagrid.cells[e+","+f[g]].after(h);b[e+","+g]=datagrid.cells[e+","+d];b[e+","+g].column=g;b[e+","+g].data("datagrid_position",{row:e,column:g});b[e+","+
g].data("column",g);c[g]=datagrid.columns[d]}h=-1;for(e=0;e<f.length;e++)if(f[e]==d)h=e;if(g!=h)if(g<h){f.splice(g,0,d);f.splice(h+1,1)}else{f.splice(g,0,d);f.splice(h,1)}}datagrid.cells=b;datagrid.columns=c},reorderRows:function(a){for(var b={},c=[],f=[],e=0;e<a.length;e++)f[e]=e;for(var g=0,d=0;d<a.length;d++){var h=a[d];e=datagrid.cells[h+",0"].parents(".row");var k=datagrid.cells[h+",1"].parents(".row");k.css("top",g);e.css("top",g);if(d>0)g=g+datagrid.rows[h].metrics.height+1;if(f[d]!=h)if(f[d]<
h){datagrid.cells[f[d]+",0"].parents(".row").before(e);datagrid.cells[f[d]+",1"].parents(".row").before(k)}else{datagrid.cells[f[d]+",0"].parents(".row").after(e);datagrid.cells[f[d]+",1"].parents(".row").after(k)}c[d]=datagrid.rows[h];for(e=0;e<datagrid.columns.length;e++){b[d+","+e]=datagrid.cells[h+","+e];b[d+","+e].row=d;b[d+","+e].data("datagrid_position",{row:d,column:e});b[d+","+e].data("row",d);c[d]=datagrid.rows[h]}k=-1;for(e=0;e<f.length;e++)if(f[e]==h)k=e;if(d!=k)if(d<k){f.splice(d,0,h);
f.splice(k+1,1)}else{f.splice(d,0,h);f.splice(k,1)}}datagrid.cells=b;datagrid.rows=c},moveColumn:function(a,b){new_order=[];if(!(a==0||b==0||a==b)){for(var c=0;c<datagrid.columns.length;c++)if(c==b)new_order.push(a);else if(c>=b&&c<=a||c<=b&&c>=a)b<a?new_order.push(c-1):new_order.push(c+1);else new_order.push(c);datagrid.reorderColumns(new_order)}},_placeDataCell:function(a,b){if(!(a<1||b<1)){var c=datagrid.cells[a+","+b];if(!(c&&c.placed)){var f=datagrid.dataRows[a];if(f){f.append(c);c.placed=true}}}},
_initializeCell:function(a,b){if(!datagrid.cells[a+","+b]){var c=["cell"];a===0&&c.push("column_header");b===0&&c.push("row_header");b!==0&&a!==0&&c.push("data_cell");c=$(["<div class='",c.join(" "),"' style='visiblity: hidden; height:",datagrid.rows[a].metrics.height,"px; width:",datagrid.columns[b].metrics.width,"px;' data-row='",a,"' data-column='",b,"'/>"].join("")).data({row:a,column:b});c.row=a;c.column=b;datagrid.cells[a+","+b]=c}return datagrid.cells[a+","+b]},_createCell:function(a,b,c){var f=
datagrid._initializeCell(a,b);if(f.transferred)return f;a!=0&&b!=0&&datagrid._templateCellHTML?f.append(datagrid._templateCellHTML(a,b)):f.append(c.children());f.attr("id",c.attr("id"));c.attr("id","original_"+f.attr("id"));f.originalTD=c;f.addClass(c.attr("class"));f.css("visibility","");f.transferred=true;return f},_trigger:function(a,b,c){a=$.Event(a);a.originalEvent=b;a.originalTarget=c;datagrid.table.trigger(a,{cell:c,trueEvent:b&&b.originalEvent})},_cellClick:function(a){var b=datagrid.position($(this));
b=datagrid.cells[b.row+","+b.column];datagrid.columns[b.column].hidden?datagrid.toggleColumn(b.column):datagrid._trigger("entry_click",a,b)},_cellMove:function(){if(!datagrid.disableHighlights){var a=datagrid.position($(this));a=datagrid.cells[a.row+","+a.column];datagrid.table.trigger("entry_move",a);$(this).index(datagrid.currentHover)==-1&&a.trigger("mouseover")}},_cellOver:function(a){if(!datagrid.disableHighlights)if(!(a.originalEvent&&!datagrid.mouseHasMoved)){datagrid.mouseHasMoved=false;var b=
datagrid.position($(this));b=datagrid.cells[b.row+","+b.column];b.addClass("selected");datagrid.currentHover&&b.index(datagrid.currentHover)==-1&&$(datagrid.currentHover).trigger("mouseout");datagrid.currentHover=b;if(b.row==0)for(var c=1;c<datagrid.rows.length;c++)datagrid.cells[c+","+b.column].addClass("related");else if(b.column==0)for(c=1;c<datagrid.columns.length;c++)datagrid.cells[b.row+","+c].addClass("related");else{datagrid.cells[b.row+",0"].addClass("related");datagrid.cells["0,"+b.column].addClass("related")}datagrid._trigger("entry_over",
a,b)}},_cellOut:function(a){if(!datagrid.disableHighlights)if($(a.target).parents("div").index(this)==-1){var b=datagrid.position($(this));b=datagrid.cells[b.row+","+b.column];b.removeClass("selected");if(b.row==0)for(var c=1;c<datagrid.rows.length;c++)datagrid.cells[c+","+b.column].removeClass("related");else if(b.column==0)for(c=1;c<datagrid.columns.length;c++)datagrid.cells[b.row+","+c].removeClass("related");else{datagrid.cells[b.row+",0"].removeClass("related");datagrid.cells["0,"+b.column].removeClass("related")}datagrid._trigger("entry_out",
a,b)}},_placeDataFragment:function(){if(datagrid.dataFragment){datagrid.divs.data.find(".content:first")[0].appendChild(datagrid.dataFragment);datagrid.dataFragment=null}},_placeDataRow:function(a){if(!(a<1)){a=datagrid.dataRows[a]||datagrid._createRow(a);if(!a.placed){datagrid.dataFragment?datagrid.dataFragment.appendChild(a[0]):datagrid.divs.data.find(".content:first").append(a);a.placed=true}}},_createRow:function(a,b){if(datagrid.dataRows[a])return datagrid.dataRows[a];var c=document.createDocumentFragment(),
f=$(document.createElement("div")).addClass("row");c.appendChild(f[0]);f.height(datagrid.rows[a].metrics.height);c=0;for(var e=1;e<a;e++)c+=datagrid.rows[e].metrics.height+1;f.css({top:c,left:0});if(a>0&&!b)datagrid.dataRows[a]=f;return f},toggleColumn:function(a,b,c){var f=!datagrid.columns[a].hidden,e=!!datagrid.columns[a].hidden;if(b)e=true;else if(b===false)e=false;if(f!=e){for(b=0;b<datagrid.rows.length;b++)datagrid.cells[b+","+a].width(e?datagrid.columns[a].metrics.width:10).children().showIf(e).toggleClass("hidden_column",
!e);datagrid.columns[a].hidden=!e;c||datagrid.sizeGrid()}},sizeGrid:function(){for(var a=0,b=1;b<datagrid.columns.length;b++)a+=datagrid.columns[b].hidden?10:datagrid.columns[b].metrics.width;datagrid.divs.filler.width(a-datagrid.columns[0].metrics.width);for(b=1;b<datagrid.rows.length;b++)datagrid.cells[b+",1"].parent(".row").width(a+datagrid.columns.length+3)},focus:function(a,b){var c=datagrid.cells[a+","+b];if(!(datagrid.currentFocus&&c.index(datagrid.currentFocus||[])!=-1)){datagrid.currentFocus&&
datagrid.blur();c.addClass("focus");datagrid.currentFocus=c;datagrid._trigger("entry_focus",null,c)}},blur:function(){if(datagrid.currentFocus){datagrid.currentFocus.removeClass("focus");datagrid._trigger("entry_blur",null,datagrid.currentFocus);datagrid.currentFocus=null}},scrollTo:function(a,b){datagrid.disableHighlights=true;if(a==0)a=1;if(b==0)b=1;var c=datagrid.cells[a+","+b];datagrid.divs.data.scrollToVisible(c).triggerHandler("scroll");datagrid.disableHighlights=false;if(c&&c.filter(":visible").length>
0){c.attr("tabindex",0);return true}},sizeToWindow:function(){$("html,body").css("overflow","hidden");var a=$("#content,#wide_content");if(a.length===0||a.width()<100)a=$(window);var b=1;if($("body").hasClass("ff")||$("body").hasClass("webkit"))b=1;var c=$(window).height()-b-datagrid.divs.top.offset().top;a=a.width()-b;datagrid.divs.left.height(c-datagrid.rows[0].metrics.height-datagrid.borderSize+1);datagrid.divs.data.height(c-datagrid.rows[0].metrics.height-datagrid.borderSize+1);datagrid.divs.top.width(a-
datagrid.columns[0].metrics.width-datagrid.borderSize+1);datagrid.divs.data.width(a-datagrid.columns[0].metrics.width-datagrid.borderSize+1);datagrid.divs.data.metrics={width:a-datagrid.columns[0].metrics.width-datagrid.borderSize+1,height:c-datagrid.rows[0].metrics.height-datagrid.borderSize+1}},_selectFirstCell:function(){var a=datagrid.cells["1,1"];a.trigger("mouseover");datagrid.currentHover=a;datagrid.scrollTo(1,1)},position:function(a){a.hasClass("cell")||(a=a.closest(".cell"));if(a.data("datagrid_position"))return a.data("datagrid_position");
if(a.length==0)return{};var b={row:parseInt(a.attr("data-row"),10),column:parseInt(a.attr("data-column"),10)};a.data("datagrid_position",b);return b},moveLeft:function(){var a=datagrid.currentHover;if(datagrid.currentHover){for(var b=a.column-1,c=datagrid.cells[a.row+","+b];c&&c.hidden;){b--;c=datagrid.cells[a.row+","+b]}if(!c||c.length===0)c=a;c.trigger("mouseover").focus();datagrid.currentHover=c;datagrid.scrollTo(c.row,c.column)}else datagrid._selectFirstCell()},moveRight:function(){var a=datagrid.currentHover;
if(datagrid.currentHover){for(var b=a.column+1,c=datagrid.cells[a.row+","+b];c&&c.hidden;){b++;c=datagrid.cells[a.row+","+b]}if(!c||c.length===0)c=a;c.trigger("mouseover").focus();datagrid.currentHover=c;datagrid.scrollTo(c.row,c.column)}else datagrid._selectFirstCell()},moveUp:function(){var a=datagrid.currentHover;if(datagrid.currentHover){for(var b=a.row-1,c=datagrid.cells[b+","+a.column];c&&c.hidden;){b--;c=datagrid.cells[b+","+a.column]}if(!c||c.length===0)c=a;c.trigger("mouseover").focus();
datagrid.currentHover=c;datagrid.scrollTo(c.row,c.column)}else datagrid._selectFirstCell()},moveDown:function(){var a=datagrid.currentHover;if(datagrid.currentHover){for(var b=a.row+1,c=datagrid.cells[b+","+a.column];c&&c.hidden;){b++;c=datagrid.cells[b+","+a.column]}if(!c||c.length===0)c=a;c.trigger("mouseover").focus();datagrid.currentHover=c;datagrid.scrollTo(c.row,c.column)}else datagrid._selectFirstCell()}}})();
var attendance={saveKeyIndex:0,toggleState:function(a,b,c){if(!a.hasClass("false_submission")){var f=a.attr("id").split("_"),e=f[1],g=f[2];a.addClass("saving");var d="";if(b)if(b=="fail"){a.removeClass("pass").addClass("fail");d="fail"}else if(b=="pass"){a.removeClass("fail").addClass("pass");d="pass"}else{a.removeClass("fail").removeClass("pass");d=""}else if(a.hasClass("pass")){a.removeClass("pass").addClass("fail");d="fail"}else if(a.hasClass("fail")){a.removeClass("fail").removeClass("pass");
d=""}else{a.removeClass("fail").addClass("pass");d="pass"}var h=attendance.saveKeyIndex++;c||setTimeout(function(){if(a.data("save_key")==h){var k=$.replaceTags($.replaceTags($(".grade_submission_url").attr("href"),"user_id",e),"assignment_id",g);$.ajaxJSON(k,"POST",{"submission[assignment_id]":g,"submission[user_id]":e,"submission[grade]":d},function(j){a.removeClass("saving");for(var n in j){var m=j[n].submission,p=$("#submission_"+m.user_id+"_"+m.assignment_id);m=attendance.toggleState(p,m.grade||
"clear",true);attendance.clearSavingState(p,m)}},function(){a.removeClass("saving")})}},1E3);a.data("save_key",h);return h}},clearSavingState:function(a,b){if(a.data("save_key")==b){a.removeClass("saving");a.data("save_key",null)}},toggleColumnState:function(a,b){for(var c=datagrid.cells["0,"+a].attr("id").split("_")[1],f={},e=1;e<datagrid.rows.length;e++){var g=attendance.toggleState(datagrid.cells[e+","+a],b,true);f[e]=g}var d=function(){for(var h=1;h<datagrid.rows.length;h++)attendance.clearSavingState(datagrid.cells[h+
","+a],f[h])};c=$.replaceTags($(".set_default_grade_url").attr("href"),"assignment_id",c);e=b;if(e!="pass"&&e!="fail")e="";$.ajaxJSON(c,"PUT",{"assignment[default_grade]":e,"assignment[overwrite_existing_grades]":"1"},function(){d()},function(){d()})}},attachAddAssignmentGroup;
$(document).ready(function(){$(".blank_attendance:first");$(".pass_attendance:first");$(".fail_attendance:first");var a=0;attachAddAssignmentGroup&&attachAddAssignmentGroup($("#new_assignment_dialog select.assignment_group_select"));$(".add_assignment_link").click(function(g){g.preventDefault();$("#new_assignment_dialog :text:not(.points_possible)").each(function(){$(this).val("")});$("#new_assignment_dialog").dialog("close").dialog({autoOpen:false,title:"New Attendance Column"}).dialog("open")});
$("#new_assignment_dialog .cancel_button").click(function(){$("#new_assignment_dialog").dialog("close")});$("#add_assignment_form").formSubmit({beforeSubmit:function(){$(this).find(".submit_button").text("Adding Assignment...");$(this).find("button").attr("disabled",true)},success:function(g){$(this).find(".submit_button").text("Added Assignment");$(this).find("button").attr("disabled",false);location.href="#assignment_"+g.assignment.id;location.reload()},error:function(g){$(this).formErrors(g);$(this).find(".submit_button").text("Add Assignment Failed");
$(this).find("button").attr("disabled",false)}});$("#new_assignment_dialog .datetime_field").change(function(){var g=$("#new_assignment_dialog .title").val();if(!g||g.match(/^Attendance (\d)+-(\d)+-(\d)+$/)){g=$(this).data("date");var d="";if(g)d=g.toString("M-d-yyyy");d&&$("#new_assignment_dialog .title").val("Attendance "+d)}});$(".datetime_field").datetime_field();$(".help_link").click(function(g){g.preventDefault();$("#attendance_how_to_dialog").dialog("close").dialog({autoOpen:false,width:400,
title:"Attendance Help"}).dialog("open")});$(".submission").addClass("loading");var b=function(g,d,h){$.ajaxJSON(g,"GET",{},function(k){for(var j in d)for(var n in h)$("#submission_"+h[n]+"_"+d[j]).removeClass("loading");for(j in k)if(k[j]&&k[j].submission){var m=k[j].submission.grade;n=$("#submission_"+k[j].submission.user_id+"_"+k[j].submission.assignment_id);n.removeClass("loading");if(m!="pass"&&m!="fail")m="clear";m=attendance.toggleState(n,m,true);attendance.clearSavingState(n,m)}},function(){if(a<
5){a++;b(g)}})},c=Math.round(200/($("#attendance .student").length||1)),f=[],e=$(".gradebook_url").attr("href");setTimeout(function(){var g=[];$("#attendance .assignment").each(function(){var d=($(this).attr("id")||"").split("_").pop();g.push(d)});$("#attendance .student").each(function(){var d=($(this).attr("id")||"").split("_").pop();d&&f.push(d);if(f.length>c){b(e+"?init=1&submissions=1&user_ids="+f.join(",")+"&assignment_ids="+g.join(","),g,f);f=[]}});f.length>0&&b(e+"?init=1&submissions=1&user_ids="+
f.join(",")+"&assignment_ids="+g.join(","),g,f)},500);$("#comment_link").click(function(g){g.preventDefault();g.stopPropagation()});$(".options_dropdown").click(function(g){g.preventDefault()});$("#attendance").bind("entry_over",function(g,d){d.cell.attr("id").split("_")}).bind("entry_out",function(){}).bind("entry_click",function(g,d){d.trueEvent.preventDefault();datagrid.focus(d.cell.row,d.cell.column)}).bind("entry_focus",function(g,d){d.cell.row==0?d.cell.find(".options_dropdown").dropdownList({options:{'<span class="ui-icon ui-icon-pencil">&nbsp;</span> Edit Assignment':function(){location.href=
"/"},'<span class="ui-icon ui-icon-check">&nbsp;</span> Mark Everyone Present':function(){attendance.toggleColumnState(d.cell.column,"pass")},'<span class="ui-icon ui-icon-close">&nbsp;</span> Mark Everyone Absent':function(){attendance.toggleColumnState(d.cell.column,"fail")},'<span class="ui-icon ui-icon-minus">&nbsp;</span> Clear Attendance Marks':function(){attendance.toggleColumnState(d.cell.column,"clear")}}}):attendance.toggleState(d.cell);datagrid.blur()}).bind("entry_blur",function(){});
$(document).keycodes("return p f del",function(g){if(!(datagrid.currentFocus||!datagrid.currentHover))if(!($(g.target).closest(".ui-dialog").length>0)){var d=datagrid.currentHover;g.keyString=="return"&&d.hasClass("submission")&&datagrid.focus(d.row,d.column)}});datagrid.init($("#attendance"),{borderSize:2,onViewable:function(){$("#attendance_loading_message").hide();$(document).fragmentChange(function(g,d){if(d.length>1)d=d.substring(1);d=d.replace(/\//g,"_");if(d.indexOf("student")==0||d.indexOf("assignment")==
0||d.indexOf("submission")==0){var h=$("#"+d),k=datagrid.position(h);datagrid.scrollTo(k.row,k.column);h.trigger("mouseover")}})},onReady:function(){}})});
