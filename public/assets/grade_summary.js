(function(){function p(c,b){if(b.length!==0){var d=b.getTemplateData({textValues:["assignment_group_id","rules","group_weight"]});d=$.extend(d,b.getFormData());var a=c[d.assignment_group_id]||{};if(!a.group_weight)a.group_weight=parseFloat(d.group_weight)/100;a.scores=a.scores||[];a.full_points=a.full_points||[];a.count=a.count||0;a.submissions=a.submissions||[];a.sorted_submissions=a.sorted_submissions||[];if(isNaN(a.score_total))a.score_total=null;if(isNaN(a.full_total))a.full_total=null;if(a.score_total!==
null||a.full_total!==null){a.calculated_score=a.score_total/a.full_total;if(isNaN(a.calculated_score)||!isFinite(a.calculated_score))a.calculated_score=0}else{a.score_total=0;a.full_total=0}if(!a.rules){d.rules=d.rules||"";var e={drop_highest:0,drop_lowest:0,never_drop:[]},l=d.rules.split("\n"),f;for(f in l){var j=l[f].split(":"),k=null;if(j.length>1)k=parseInt(j[1],10);if(k&&!isNaN(k)&&isFinite(k))if(j[0]=="drop_lowest")e.drop_lowest=k;else if(j[0]=="drop_highest")e.drop_highest=k;else j[0]=="never_drop"&&
e.never_drop.push(k)}a.rules=e}return c[d.assignment_group_id]=a}}function n(){var c=$("#only_consider_graded_assignments").attr("checked"),b=$("#grades_summary .student_assignment"),d={};$(".group_total").each(function(){p(d,$(this))});b.removeClass("dropped");b.each(function(){var g=$(this);if(!g.hasClass("hard_coded")){g=g.getTemplateData({textValues:["assignment_group_id","score","points_possible","assignment_id"]});if((!g.score||isNaN(parseFloat(g.score)))&&c)$(this).addClass("dropped");else{var h=
d[g.assignment_group_id];h||(h=p(d,$("#submission_group-"+g.assignment_group_id)));if(h){var i=parseFloat(g.score);if(!i||isNaN(i)||!isFinite(i))i=0;var m=parseFloat(g.points_possible);if(!m||isNaN(m))m=0;var o=i/m;if(isNaN(o)||!isFinite(o))o=0;g.calculated_score=i;g.calculated_possible=m;g.calculated_percent=o;h.submissions.push(g);d[g.assignment_group_id]=h}else $(this).addClass("dropped")}}});for(var a in d){b=d[a];b.sorted_submissions=b.submissions.sort(function(g,h){var i=[g.calculated_percent],
m=[h.calculated_percent];if(i>m)return 1;if(i==m)return 0;return-1});for(var e=0,l=0,f=0;f<b.sorted_submissions.length;f++)b.sorted_submissions[f].calculated_drop=false;for(f=0;f<b.sorted_submissions.length;f++){submission=b.sorted_submissions[f];if(!submission.calculated_drop&&e<b.rules.drop_lowest&&submission.calculated_possible>0&&$.inArray(submission.assignment_id,b.rules.never_drop)==-1){e++;submission.calculated_drop=true}b.sorted_submissions[f]=submission}for(f=b.sorted_submissions.length-
1;f>=0;f--){submission=b.sorted_submissions[f];if(!submission.calculated_drop&&l<b.rules.drop_highest&&submission.calculated_possible>0&&$.inArray(submission.assignment_id,b.rules.never_drop)==-1){l++;submission.calculated_drop=true}b.sorted_submissions[f]=submission}for(f=0;f<b.sorted_submissions.length;f++){submission=b.sorted_submissions[f];if(submission.calculated_drop){$("#submission_"+submission.assignment_id).addClass("dropped");e++}else{$("#submission_"+submission.assignment_id).removeClass("dropped");
b.scores.push(submission.calculated_score);b.full_points.push(submission.calculated_possible);b.count++;b.score_total+=submission.calculated_score;b.full_total+=submission.calculated_possible}}d[a]=b}var j=0;var k=a=0,q=0,r=0;$.each(d,function(g,h){p(d,$("#submission_group-"+g));var i=Math.round(h.calculated_score*1E3)/10;$("#submission_group-"+g).find(".grade").text(i).end().find(".score_teaser").text(h.score_total+" / "+h.full_total);i=h.calculated_score*h.group_weight;if(isNaN(i)||!isFinite(i))i=
0;if(c&&h.count>0)q+=h.group_weight;j+=i;r+=h.score_total;k+=h.full_total});a=parseFloat($("#total_groups_weight").text());if(isNaN(a)||!isFinite(a)||a===0){a=Math.round(1E3*r/k)/10;$(".student_assignment.final_grade .score_teaser").text(r+" / "+k)}else{a=parseFloat($("#total_groups_weight").text())/100;if(isNaN(a)||!isFinite(a)||a===0)a=1;if(c&&q<1)j=(a<1?a:1)*j/q;a=Math.round(j*1E3)/10;$(".student_assignment.final_grade .score_teaser").text("Percent")}if(isNaN(a)||!isFinite(a))a=0;$(".student_assignment.final_grade").find(".grade").text(a);
$(".revert_all_scores").showIf($("#grades_summary .revert_score_link").length>0);(new Date).getTime()}$(document).ready(function(){n();$(".revert_all_scores_link").click(function(c){c.preventDefault();$("#grades_summary .revert_score_link").each(function(){$(this).trigger("click",true)});$("#.show_guess_grades.exists").show();n()});$("tr.student_assignment").mouseover(function(){$(this).hasClass("dropped")?$(this).attr("title","This assignment is not being considered in the total calculation shown to the right"):
$(this).attr("title","")});$(".toggle_comments_link").click(function(c){c.preventDefault();$(this).parents("tr.student_assignment").next("tr.comments").toggle()});$(".student_assignment.editable .assignment_score").click(function(c){if(!($("#grades_summary.editable").length===0||$(this).find("#grade_entry").length>0||$(c.target).closest(".revert_score_link").length>0)){$(this).find(".grade").empty().append($("#grade_entry"));$(this).find(".score_value").hide();c=$(this).parents(".student_assignment").find(".score").text();
$("#grade_entry").val(c).show().focus().select()}});$("#grade_entry").keydown(function(c){if(c.keyCode==13)$(this).blur();else if(c.keyCode==27){c=$(this).parents(".student_assignment").addClass("dont_update").find(".original_score").text();$(this).val(c||"").blur()}});$("#grades_summary .student_assignment").bind("score_change",function(c,b){var d=$(this),a=parseFloat(d.find(".original_score").text());if(isNaN(a))a=null;var e=d.find("#grade_entry").val()||$(this).find(".score").text();e=parseFloat(e);
if(isNaN(e))e=null;if(!e&&e!==0)e=a;var l=a!=e;if(e==parseInt(e,10))e+=".0";d.find(".score").text(e);if(d.hasClass("dont_update")){b=false;d.removeClass("dont_update")}if(b){l||(e=null);var f=d.getTemplateData({textValues:["assignment_id"]}).assignment_id;f=$.replaceTags($(".update_submission_url").attr("href"),"assignment_id",f);$.ajaxJSON(f,"PUT",{"submission[student_entered_score]":e},function(j){j={student_entered_score:j.submission.student_entered_score};d.fillTemplateData({data:j})},function(){});
l||(e=a)}$("#grade_entry").hide().appendTo($("body"));if(l)d.find(".assignment_score").attr("title","").find(".score_teaser").text("This is a What-If score").end().find(".score_holder").append($("#revert_score_template").clone(true).attr("id","").show()).find(".grade").addClass("changed");else{d.find(".assignment_score").attr("title","Click to test a different score").find(".score_teaser").text("Click to test a different score").end().find(".grade").removeClass("changed");d.find(".revert_score_link").remove()}if(e===
0)e="0.0";d.find(".grade").text(e||"-");n()});$("#grade_entry").blur(function(){var c=$(this).parents(".student_assignment");c.find(".score").text($(this).val());c.triggerHandler("score_change",true)});$("#grades_summary").delegate(".revert_score_link","click",function(c,b){c.preventDefault();c.stopPropagation();var d=$(this).parents(".student_assignment").find(".original_score").text(),a=$(this).parents(".student_assignment");a.find(".score").text(d);a.find(".grade").text(d||"-");a.find(".assignment_score").attr("title",
"Click to test a different score").find(".score_teaser").text("Click to test a different score").end().find(".grade").removeClass("changed");a.find(".revert_score_link").remove();a.find(".score_value").text(d);b||n()});$("#grades_summary:not(.editable) .assignment_score").css("cursor","default");$("#grades_summary tr").hover(function(){$(this).find("td.title .context").addClass("context_hover")},function(){$(this).find("td.title .context").removeClass("context_hover")});$(".show_guess_grades_link").click(function(){$("#grades_summary .student_entered_score").each(function(){var c=
parseFloat($(this).text(),10);if(!isNaN(c)&&(c||c===0)){var b=$(this).parents(".student_assignment");b.find(".score").text(c);b.find(".score_value").hide();b.triggerHandler("score_change",false)}});$(".show_guess_grades").hide()});$("#grades_summary .student_entered_score").each(function(){var c=parseFloat($(this).text(),10);!isNaN(c)&&c&&$(".show_guess_grades").show().addClass("exists")});$(".comments .play_comment_link").mediaCommentThumbnail("normal");$(".play_comment_link").live("click",function(c){c.preventDefault();
c=$(this).parents(".comment_media");var b=c.getTemplateData({textValues:["media_comment_id"]}).media_comment_id;if(b){c.children(":not(.media_comment_content)").remove();c.find(".media_comment_content").mediaComment("show_inline",b,"any")}});$("#only_consider_graded_assignments").change(function(){n()}).triggerHandler("change");$.scrollSidebar()})})();
