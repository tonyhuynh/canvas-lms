var wikiSidebar,quiz={};
(function(){function o(d){$(".question_holder:visible");var b=$.extend({},quiz.defaultQuestionData,{question_name:"Question"},d),g=$("#question_template").clone(true);g.attr("id","").find(".question").attr("id","question_new");g.fillTemplateData({data:b,except:["answers"]});g.find(".original_question_text").fillFormData(b);if(b.answers){b.answer_count=b.answers.length;d.answer_type=b.answer_type;b.anwer_type=quiz.answerTypeDetails(b.question_type)}for(var i=0;i<b.answer_count;i++){var a={answer_weight:i==
0?100:0};b.answers&&b.answers[i]&&$.extend(a,b.answers[i]);g.find(".answers").append(z(a))}g.toggleClass("group",!!(d&&d.quiz_group_id));g.show();return g}function q(d,b){return d&&!b?p.text(d).html():d}function z(d,b){d.answer_weight=d.weight||d.answer_weight;d.answer_comment=q(d.comments||d.answer_comment,b);d.answer_text=q(d.text||d.answer_text,b);d.answer_match_left=q(d.left||d.answer_match_left,b);d.answer_match_right=q(d.right||d.answer_match_right,b);d.answer_exact=d.exact||d.answer_exact;
d.answer_error_margin=d.answer_error_margin||d.margin;d.answer_range_start=d.start||d.answer_range_start;d.answer_range_end=d.end||d.answer_range_end;var g=$.extend({},quiz.defaultAnswerData,d),i=$("#answer_template").clone(true).attr("id",""),a=g.answer_type;if(a=="numerical_answer")a="numerical_"+g.numerical_answer_type;i.addClass("answer_for_"+d.blank_id);i.find(".answer_type").hide().filter("."+a).show();delete g.answer_type;g.answer_weight=parseFloat(g.answer_weight);if(isNaN(g.answer_weight))g.answer_weight=
0;a=p.html(g.answer_text).text();i.fillFormData({answer_text:a});i.fillTemplateData({data:g,htmlValues:["answer_text","answer_comment","answer_match_left","answer_match_right"]});if(!g.answer_comment||g.answer_comment==""||g.answer_comment=="Answer comments")i.find(".answer_comment_holder").hide();if(g.answer_weight==100)i.addClass("correct_answer");else if(g.answer_weight>0)i.addClass("correct_answer");else g.answer_weight<0&&i.addClass("negative_answer");i.show();return i}function u(d){d=$.extend({},
quiz.defaultAnswerData,d);var b=$("#form_answer_template").clone(true).attr("id","");b.find(".answer_type").hide().filter("."+d.answer_type).show();d.answer_weight=parseFloat(d.answer_weight);if(isNaN(d.answer_weight))d.answer_weight=0;quiz.updateFormAnswer(b,d,true);b.show();return b}function v(d){var b={questions:[],points_possible:0},g=$("#questions").find(".question");if(d)g=d;g.each(function(i){var a=$(this),c=a.getTemplateData({textValues:["question_name","question_points","question_type","answer_selection_type",
"assessment_question_id","correct_comments","incorrect_comments","neutral_comments","text_before_answers","text_after_answers","matching_answer_incorrect_matches","equation_combinations","equation_formulas"],htmlValues:["question_text"]});c=$.extend(c,a.find(".original_question_text").getFormData());c.assessment_question_bank_id=$(".question_bank_id").text()||"";if(c.text_before_answers)c.question_text=c.text_before_answers;var e=[];a.find(".matching_answer_incorrect_matches_list li").each(function(){e.push($(this).text())});
c.matching_answer_incorrect_matches=e.join("\n");var f=$.extend({},b.defaultQuestionData,c);f.answers=[];var j={},l=false;if(f.question_type=="multiple_dropdowns_question"||f.question_type=="fill_in_multiple_blanks_question"){l=true;a.find(".blank_id_select option").each(function(){j[$(this).text()]=true})}if(f.question_type!="calculated_question")a.find(".answer").each(function(){var k=$(this).getTemplateData({textValues:["answer_exact","answer_error_margin","answer_range_start","answer_range_end",
"answer_weight","numerical_answer_type","blank_id","id","match_id"],htmlValues:["answer_text","answer_match_left","answer_match_right","answer_comment"]});k=$.extend({},b.defaultAnswerData,k);l&&k.blank_id&&!j[k.blank_id]||f.answers.push(k)});else{f.formulas=[];a.find(".formulas_holder .formulas_list").each(function(){f.formulas.push($.trim($(this).text()))});f.variables=[];a.find(".variable_definitions_holder .variable_definitions tbody tr").each(function(){var k=$(this).getTemplateData({textValues:["name",
"min","max","scale"]});f.variables.push(k)});f.answers=[];a.find(".equation_combinations tbody tr").each(function(){var k={};k.variables=[];$(this).find("td:not(.final_answer)").each(function(s){var x={};x.name=f.variables[s].name;x.value=parseFloat($(this).text(),10)||0;k.variables.push(x)});k.answer_text=parseFloat($(this).find(".final_answer").text(),10)||0;f.answers.push(k)});f.formula_decimal_places=parseInt(a.find(".formula_decimal_places").text(),10)||0;f.answer_tolerance=parseFloat(a.find(".answer_tolerance").text(),
10)||0}f.position=i;f.question_points=parseFloat(f.question_points);if(isNaN(f.question_points))f.question_points=0;b.points_possible+=f.question_points;b.questions.push(f)});return b}function h(d){var b={},g;for(g in d)if(g.indexOf("questions[question_0]")==0){var i=g.replace("questions[question_0]","question");b[i]=d[g]}return b}function n(d){var b={},g=g||null;if(g)b["quiz[assignment_id]"]=g;b["quiz[title]"]=d.quiz_name;for(var i in d.questions){g=d.questions[i];var a="questions[question_"+i+"]";
b[a+"[question_name]"]=g.question_name;b[a+"[assessment_question_id]"]=g.assessment_question_id;b[a+"[question_type]"]=g.question_type;b[a+"[points_possible]"]=g.question_points;b[a+"[correct_comments]"]=g.correct_comments;b[a+"[incorrect_comments]"]=g.incorrect_comments;b[a+"[neutral_comments]"]=g.neutral_comments;b[a+"[question_text]"]=g.question_text;b[a+"[position]"]=g.position;b[a+"[text_after_answers]"]=g.text_after_answers;b[a+"[matching_answer_incorrect_matches]"]=g.matching_answer_incorrect_matches;
for(var c in g.formulas){var e=a+"[formulas][formula_"+c+"]";b[e]=g.formulas[c]}for(c in g.variables){e=a+"[variables][variable_"+c+"]";b[e+"[name]"]=g.variables[c].name;b[e+"[min]"]=g.variables[c].min;b[e+"[max]"]=g.variables[c].max;b[e+"[scale]"]=g.variables[c].scale}b[a+"[answer_tolerance]"]=g.answer_tolerance;b[a+"[formula_decimal_places]"]=g.formula_decimal_places;for(c in g.answers){var f=g.answers[c];e=a+"[answers][answer_"+c+"]";b[e+"[answer_text]"]=f.answer_text;b[e+"[answer_comments]"]=
f.answer_comment;b[e+"[answer_weight]"]=f.answer_weight;b[e+"[answer_match_left]"]=f.answer_match_left;b[e+"[answer_match_right]"]=f.answer_match_right;b[e+"[numerical_answer_type]"]=f.numerical_answer_type;b[e+"[answer_exact]"]=f.answer_exact;b[e+"[answer_error_margin]"]=f.answer_error_margin;b[e+"[answer_range_start]"]=f.answer_range_start;b[e+"[answer_range_end]"]=f.answer_range_end;b[e+"[blank_id]"]=f.blank_id;b[e+"[match_id]"]=f.match_id;b[e+"[id]"]=f.id;for(var j in f.variables){var l=e+"[variables][variable_"+
j+"]";b[l+"[name]"]=f.variables[j].name;b[l+"[value]"]=f.variables[j].value}}}return b}quiz={uniqueLocalIDStore:{},generateUniqueLocalID:function(d){var b="object";if(d.attr("class"))b=d.attr("class").indexOf(" ")!=-1?d.attr("class").split(" ")[0]:d.attr("class");d=Math.floor(Math.random()*99999);for(d=b+"_"+d;quiz.uniqueLocalIDStore[d];){d=Math.floor(Math.random()*99999);d=b+"_"+d}quiz.uniqueLocalIDStore[d]=true;return d},updateFormAnswer:function(d,b,g){var i=b.question_type;g=g?{}:d.getFormData();
b=$.extend({},quiz.defaultAnswerData,g,b);d.find(".answer_type").hide().filter("."+b.answer_type).show();b.answer_weight=parseFloat(b.answer_weight);if(isNaN(b.answer_weight))b.answer_weight=0;d.fillFormData(b,{call_change:false});b.answer_comment&&d.find(".answer_comments").removeClass("empty");b.answer_selection_type=b.answer_selection_type||quiz.answerSelectionType(b.question_type);if(b.answer_selection_type=="any_answer")d.addClass("correct_answer");else if(b.answer_selection_type=="matching")d.removeClass("correct_answer");
else if(b.answer_selection_type!="multiple_answer"){g=d.parent().find(".answer");g.find(".answer").filter(".correct_answer").not(":first").removeClass("correct_answer");g.filter(".correct_answer").length===0&&g.filter(":first").addClass("correct_answer")}d.find(".numerical_answer_type").change();g={answer_text:b.answer_text,id:b.id,match_id:b.match_id};g.comments_header="Comments, if the user chooses this answer:";g.short_answer_header="Possible Answer:";d.find(".comment_focus").attr("title","Click to enter comments for the student if they choose this answer");
if(i=="essay_question")g.comments_header="Comments for this question:";else if(i=="matching_question"){g.comments_header="Comments if the user gets this match wrong:";d.find(".comment_focus").attr("title","Click to enter comments for the student if they miss this match")}else if(i=="missing_word_question")g.short_answer_header="Answer text:";else if(i=="multiple_answers_question")g.short_answer_header="Answer text:";else if(i=="fill_in_multiple_blanks_question")g.blank_id=b.blank_id;else if(i=="multiple_dropdowns_question"){g.short_answer_header=
"Answer text:";g.blank_id=b.blank_id}b.blank_id&&b.blank_id!="0"&&d.addClass("answer_for_"+b.blank_id);b.blank_index>=0&&d.addClass("answer_idx_"+b.blank_index);d.fillTemplateData({data:g});if(b.answer_weight==100)d.addClass("correct_answer");else if(b.answer_weight>0)d.addClass("correct_answer");else b.answer_weight<0&&d.addClass("negative_answer");i=="matching_question"&&d.removeClass("correct_answer")},questionContentCounter:0,showFormQuestion:function(d){if(!d.attr("id")){d.find(".question_content").attr("id",
"question_content_"+quiz.questionContentCounter++);d.find(".question_content").editorBox();d.find(".text_after_answers").attr("id","text_after_answers_"+quiz.questionContentCounter++);d.find(".text_after_answers").editorBox()}return d.show()},answerTypeDetails:function(d){var b,g,i="one";if(d=="multiple_choice_question"){b="select_answer";g="multiple_choice_question"}else if(d=="true_false_question"){b="select_answer";g="true_false_question"}else if(d=="short_answer_question"){b="short_answer";g=
"short_answer_question";i="all"}else if(d=="fill_in_multiple_blanks_question"){b="short_answer";g="fill_in_multiple_blanks_question";i="all"}else if(d=="essay_question"){b="comment";g="essay_question";i="none"}else if(d=="matching_question"){b="matching_answer";g="matching_question";i="all"}else if(d=="missing_word_question"){b="select_answer";g="missing_word_question"}else if(d=="multiple_dropdowns_question"){b="select_answer";g="multiple_dropdowns_question";i="multiple"}else if(d=="numerical_question"){b=
"numerical_answer";g="numerical_question";i="all"}else if(d=="multiple_answers_question"){b="select_answer";g="multiple_answers_question";i="multiple"}else if(d=="calculated_question"){b="numerical_answer";g="question_question"}return{question_type:g,answer_type:b,n_correct:i}},answerSelectionType:function(d){var b="single_answer";if(d!="multiple_choice_question")if(d!="true_false_question")if(d=="short_answer_question")b="any_answer";else if(d=="essay_question")b="none";else if(d=="matching_question")b=
"matching";else if(d!="missing_word_question")if(d=="numerical_question")b="any_answer";else if(d=="calculated_question")b="any_answer";else if(d!="multiple_dropdowns_question")if(d=="fill_in_multiple_blanks_question")b="any_answer";else if(d=="multiple_answers_question")b="multiple_answer";else if(d=="text_only_question")b="none";return b},addExistingQuestion:function(d){var b=$("#group_top_"+d.quiz_group_id),g=null;if(b.length>0){for(g=b.next();g.length>0&&!g.hasClass("group_bottom");)g=g.next();
if(g.length==0)g=null}$.extend(d,d.question_data);b=o(d);quiz.updateDisplayQuestion(b.find(".question:first"),d,true);$("#unpublished_changes_message").slideDown();g?g.before(b):$("#questions").append(b)},updateDisplayQuestion:function(d,b,g){d.fillTemplateData({data:b,except:["answers"],htmlValues:["question_text"]});d.find(".original_question_text").fillFormData(b);d.find(".question_correct_comment").toggleClass("empty",!b.correct_comments);d.find(".question_incorrect_comment").toggleClass("empty",
!b.incorrect_comments);d.find(".question_neutral_comment").toggleClass("empty",!b.neutral_comments);d.find(".answers").empty();d.find(".equation_combinations").empty();d.find(".equation_combinations_holder_holder").css("display","none");d.find(".multiple_answer_sets_holder").css("display","none");d.find(".variable_definitions_holder").css("display","none").find("tbody").empty();d.find(".formulas_holder").css("display","none").find(".formulas_list").empty();var i=quiz.answerTypeDetails(b.question_type),
a=i.answer_type,c=i.question_type,e=i.n_correct;if(b.question_type=="fill_in_multiple_blanks_question")d.find(".multiple_answer_sets_holder").css("display","");else b.question_type=="multiple_dropdowns_question"&&d.find(".multiple_answer_sets_holder").css("display","");var f=$(document.createElement("select")).addClass("answer_select"),j=false;if(b.question_type=="calculated_question"){$.each(b.variables,function(y,m){var r=$("<tr/>"),t=$("<td class='name'/>");t.text(m.name);r.append(t);t=$("<td class='min'/>");
t.text(m.min);r.append(t);t=$("<td class='max'/>");t.text(m.max);r.append(t);t=$("<td class='scale'/>");t.text(m.scale);r.append(t);d.find(".variable_definitions_holder").css("display","");d.find(".variable_definitions tbody").append(r)});$.each(b.formulas,function(y,m){var r=$("<div/>");r.text(m.formula);d.find(".formulas_holder").css("display","").find(".formulas_list").append(r)});d.find(".formula_decimal_places").text(b.formula_decimal_places);if(b.answers.length>0){d.find(".equation_combinations").append($("<thead/>"));
d.find(".equation_combinations").append($("<tbody/>"));i=$("<tr/>");for(var l in b.answers[0].variables){var k=$("<th/>");k.text(b.answers[0].variables[l].name);i.append(k)}k=$("<th/>");k.text("Final Answer");i.append(k);d.find(".equation_combinations_holder_holder").css("display","");d.find(".equation_combinations thead").append(i).show();$.each(b.answers,function(y,m){var r=$("<tr/>"),t;for(t in m.variables){var A=$("<td/>");A.text(m.variables[t].value);r.append(A)}A=$("<td class='final_answer'/>");
t=m.answer;if(b.answerDecimalPoints||b.answer_tolerance){var B=parseFloat(b.answer_tolerance);B=B||Math.pow(0.1,b.answerDecimalPoints);t=t+" <span style='font-size: 0.8em;'>+/-</span> "+B;d.find(".answer_tolerance").text(B)}A.html(t);r.append(A);d.find(".equation_combinations tbody").append(r)})}}else{i=$(document.createElement("option"));i.val("").text("[ Choose ]");f.append(i);$.each(b.answers,function(y,m){m.answer_type=a;if(e=="all")m.answer_weight=100;else if(e=="one"&&j)m.answer_weight=0;else if(e==
"none")m.answer_weight=0;if(m.answer_weight>0)j=true;var r=z(m,g);d.find(".answers").append(r);r=$(document.createElement("option"));r.val("option_"+y).text(m.answer_text);f.append(r)})}d.find(".blank_id_select").empty();if(b.question_type=="missing_word_question"){i=d.find(".question_text");i.html("<span class='text_before_answers'>"+b.question_text+"</span> ");i.append(f);i.append(" <span class='text_after_answers'>"+b.text_after_answers+"</span>")}else if(b.question_type=="multiple_dropdowns_question"||
b.question_type=="fill_in_multiple_blanks_question"){var s={};$.each(b.answers,function(y,m){s[m.blank_id]=true});d.find(".blank_id_select").empty();for(l in s)if((k=l)&&s[l]){i=$("<option/>");i.val(k).text(k);d.find(".blank_id_select").append(i)}}d.find(".after_answers").empty();if(b.question_type=="matching_question"){i=d.find(".after_answers");k=[];if(b.matches&&b.answers){var x={};for(l in b.answers)x[b.answers[l].match_id]=true;for(l in b.matches)x[b.matches[l].match_id]||k.push(b.matches[l].text)}else{k=
b.matching_answer_incorrect_matches||"";if(typeof k=="string")k=k.split("\n")}l="";for(var w in k)if(k[w])l=l+"<li>"+k[w]+"</li>";l&&i.append("Other Incorrect Match Options:<ul class='matching_answer_incorrect_matches_list'>"+l+"</ul>")}d.find(".blank_id_select").change();d.attr("class","question display_question").addClass(c);d.fillTemplateData({question_type:c,answer_selection_type:a});d.show();if(d.attr("id")=="question_new")if(c!="text_only_question"){quiz.defaultQuestionData.question_type=c;
quiz.defaultQuestionData.answer_count=Math.min(d.find(".answers .answer").length,4)}$("html,body").scrollTo({top:d.offset().top-10,left:0});d.find(".question_points_holder").showIf(!d.closest(".question_holder").hasClass("group")&&b.question_type!="text_only_question");d.find(".unsupported_question_type_message").remove();quiz.updateDisplayComments();if(b.id){d.fillTemplateData({data:{id:b.id},id:"question_"+b.id,hrefValues:["id"]});d.find(".original_question_text").fillFormData(b);quiz.updateDisplayComments()}},
updateFormQuestion:function(d){var b=d.find(".question"),g=b.find(":input[name='question_type']").val(),i={};i.answer_type="select_answer";i.answer_selection_type=quiz.answerSelectionType(g);i.textValues=["answer_weight","answer_text","answer_comment","blank_id","id","match_id"];i.question_type=g;b.find(".explanation").hide().filter("."+g+"_explanation").show();b.attr("class","question").addClass("selectable");b.find(".missing_word_after_answer").hide().end().find(".matching_answer_incorrect_matches_holder").hide().end().find(".question_comment").css("display",
"").end().find(".question_neutral_comment").css("display","none");$("#questions").hasClass("survey_quiz")&&b.find(".question_comment").css("display","none").end().find(".question_neutral_comment").css("display","");b.find(".question_header").text("Question:");b.addClass(g);b.find(".question_points_holder").showIf(!b.closest(".question_holder").hasClass("group")&&g!="text_only_question");b.find("textarea.comments").each(function(){$(this).val($.trim($(this).val()));$(this).val()?$(this).parents(".question_comment").removeClass("empty"):
$(this).parents(".question_comment").addClass("empty")});var a={addable:true};if(g!="multiple_choice_question")if(g=="true_false_question"){a.addable=false;var c=b.find(".form_answers .answer");if(c.length<2)for(var e=0;e<2-c.length;e++){var f=u({answer_type:"fixed_answer",question_type:"true_false_question"});b.find(".form_answers").append(f)}else if(c.length>2)for(e=2;e<c.length;e++)c.eq(e).remove();c={question_type:"true_false_question",answer_type:"fixed_answer",answer_text:"True"};quiz.updateFormAnswer(b.find(".answer:first"),
c);c.answer_text="False";quiz.updateFormAnswer(b.find(".answer:last"),c);i.answer_type="fixed_answer"}else if(g=="short_answer_question"){b.removeClass("selectable");i.answer_type="short_answer"}else if(g=="essay_question"){b.find(".answer").remove();b.removeClass("selectable");b.find(".answers_header").hide().end().find(".question_comment").css("display","none").end().find(".question_neutral_comment").css("display","").end();a.addable=false;i.answer_type="none";i.textValues=[];i.htmlValues=[]}else if(g==
"matching_question"){b.removeClass("selectable");d.find(".matching_answer_incorrect_matches_holder").show();i.answer_type="matching_answer";i.textValues=["answer_match_left","answer_match_right","answer_comment"]}else if(g=="missing_word_question"){d.find(".missing_word_after_answer").show();d.find(".question_header").text("Text to go before answers:");i.answer_type="select_answer"}else if(g=="numerical_question"){b.removeClass("selectable");i.answer_type="numerical_answer";i.textValues=["numerical_answer_type",
"answer_exact","answer_error_margin","answer_range_start","answer_range_end"];i.html_values=[]}else if(g=="calculated_question"){b.removeClass("selectable");i.answer_type="numerical_answer";i.textValues=["answer_combinations"];i.html_values=[];b.formulaQuestion()}else if(g=="multiple_dropdowns_question"){i.answer_type="select_answer";b.multipleAnswerSetsQuestion()}else if(g=="fill_in_multiple_blanks_question"){i.answer_type="short_answer";b.multipleAnswerSetsQuestion()}else if(g!="multiple_answers_question")if(g==
"text_only_question"){a.addable=false;b.find(".answer").remove();b.removeClass("selectable");b.find(".answers_header").hide().end().find(".question_comment").css("display","none");b.find(".question_header").text("Message Text:");d.find(":input[name='question_points']").val(0);i.answer_type="none";i.textValues=[];i.htmlValues=[]}b.find(".answer.hidden").remove();d.find("input[name='answer_selection_type']").val(i.answer_selection_type).change();d.find(".add_answer_link").showIf(a.addable);c=b.find(".form_answers .answer");
if(c.length===0&&i.answer_type!="none"){b.find(".form_answers").append(u({answer_type:i.answer_type,question_type:g}));b.find(".form_answers").append(u({answer_type:i.answer_type,question_type:g}));c=b.find(".form_answers .answer")}if(i.answer_selection_type=="any_answer")c.addClass("correct_answer");else if(i.answer_selection_type=="matching")c.removeClass("correct_answer");else if(i.answer_selection_type!="multiple_answer"){c.filter(".correct_answer").not(":first").removeClass("correct_answer");
c.filter(".correct_answer").length===0&&c.filter(":first").addClass("correct_answer")}d.find(".answer").each(function(){var j=0;if($(this).hasClass("correct_answer"))j=100;$(this).find(".answer_weight").text(j);quiz.updateFormAnswer($(this),i)});d.find(".answer_type").hide().filter("."+i.answer_type).show();return i},updateDisplayComments:function(){$(".question_holder > .question > .question_comment").each(function(){var b=$.trim($(this).find(".question_comment_text").text());$(this).css("display",
"").toggleClass("empty",!b)});$(".question_holder .answer_comment_holder").each(function(){var b=$.trim($(this).find(".answer_comment").text());$(this).css("display","").toggleClass("empty",!b)});var d=0;$("#questions .question_holder:not(.group) .question:not(#question_new)").each(function(){var b=parseFloat($(this).find(".question_points:visible").text());if(isNaN(b))b=0;d+=b});$("#questions .group_top:not(#group_top_new)").each(function(){var b=parseFloat($(this).find(".question_points").text());
if(isNaN(b))b=0;var g=parseInt($(this).find(".pick_count").text(),10);if(isNaN(g))g=0;d+=b*g});d=Math.round(d*100)/100;$("#quiz_options_form").find(".points_possible").text(d)},findContainerGroup:function(d){for(d=d.prev();d.length>0;){if(d.hasClass("group_top"))return d;else if(d.hasClass("group_bottom"))break;d=d.prev()}return null},parseInput:function(d,b){if(d.val()!="")if(b=="int"){var g=parseInt(d.val(),10);if(isNaN(g))g=0;d.val(g)}else if(b=="float"){g=Math.round(parseFloat(d.val())*100)/100;
if(isNaN(g))g=0;d.val(g)}},defaultQuestionData:{question_type:"multiple_choice_question",question_text:"",question_points:1,question_name:"Question",answer_count:4},defaultAnswerData:{answer_type:"select_answer",answer_text:"Answer Text",answer_comment:"",answer_weight:0,answer_match_left:"Matching left side",answer_match_right:"Matching right side",numerical_answer_type:"exact_answer",answer_exact:"",answer_error_margin:"",answer_range_start:"",answer_range_end:""}};var p=$("<div/>");$(document).ready(function(){quiz.updateDisplayComments();
var d=$("#quiz_options_form");$.scrollSidebar();$(".datetime_field").datetime_field();$("#questions").delegate(".group_top,.question,.answer_select","mouseover",function(){$(this).addClass("hover")}).delegate(".group_top,.question,.answer_select","mouseout",function(){$(this).removeClass("hover")});$("#questions").delegate(".answer","mouseover",function(){$("#questions .answer.hover").removeClass("hover");$(this).addClass("hover")}).delegate(".answer","mouseout",function(){});d.find("#extend_due_at").change(function(){$("#quiz_lock_after").showIf($(this).attr("checked"))}).change();
d.find("#multiple_attempts_option").change(function(){$("#multiple_attempts_suboptions").showIf($(this).attr("checked"));var a=$("#multiple_attempts_suboptions #quiz_allowed_attempts");a.val()=="-1"&&a.val("1")}).triggerHandler("change");$("#limit_attempts_option").change(function(){var a=$("#quiz_allowed_attempts");if($(this).attr("checked")){var c=parseInt(a.data("saved_value")||a.val()||"1",10);if(c==-1||isNaN(c))c=1;a.val(c)}else{a.data("saved_value",$(this).val());a.val("--")}}).triggerHandler("change");
$("#require_access_code").change(function(){$("#access_code_suboptions").showIf($(this).attr("checked"));$(this).attr("checked")||$("#quiz_access_code").val("")}).triggerHandler("change");$("#never_hide_results").change(function(){$(".show_quiz_results_options").showIf($(this).attr("checked"));$(this).attr("checked")||$("#hide_results_only_after_last").attr("checked",false)}).triggerHandler("change");$("#multiple_attempts_option,#limit_attempts_option,#quiz_allowed_attempts").bind("change",function(){var a=
$("#multiple_attempts_option").attr("checked")&&$("#limit_attempts_option").attr("checked"),c=parseInt($("#quiz_allowed_attempts").val(),10);if(a&&c&&c>0)$("#hide_results_only_after_last_holder").show();else{$("#hide_results_only_after_last").attr("checked",false);$("#hide_results_only_after_last_holder").hide()}}).triggerHandler("change");d.find(".save_quiz_button").click(function(){d.data("activator","save")});d.find(".publish_quiz_button").click(function(){d.data("activator","publish")});d.formSubmit({object_name:"quiz",
required:["title"],processData:function(a){$(this).attr("method","PUT");$(this).data("submit_type")=="save_only"&&delete a.activate;a["quiz[description]"]=$("#quiz_description").editorBox("get_code");if(a.multiple_attempts){attempts=parseInt(a.allowed_attempts,10);if(isNaN(attempts)||!a.limit_attempts)attempts=-1;a.allowed_attempts=attempts;a["quiz[allowed_attempts]"]=attempts}return a},beforeSubmit:function(){$(this).find(".button.save_quiz_button").attr("disabled",true);$(this).find(".button.publish_quiz_button").attr("disabled",
true);$(this).data("activator")=="publish"?$(this).find(".button.publish_quiz_button").text("Publishing..."):$(this).find(".button.save_quiz_button").text("Saving...")},success:function(a){var c=$(this);$(this).find(".button.save_quiz_button").attr("disabled",false);$(this).find(".button.publish_quiz_button").attr("disabled",false);$(this).data("activator")=="publish"?$(this).find(".button.publish_quiz_button").text("Published!"):$(this).find(".button.save_quiz_button").text("Saved!");setTimeout(function(){c.find(".button.save_quiz_button").text("Save Settings")},
2500);if(a.quiz.assignment){var e=a.quiz.assignment;if($("#assignment_option_"+e.id).length===0){if(e.assignment_group&&$("#assignment_group_optgroup_"+e.assignment_group_id).length===0){var f=e.assignment_group;$(document.createElement("optgroup")).attr("label",f.name).attr("id","assignment_group_optgroup_"+f.id)}f=$("#assignment_group_optgroup_"+e.assignment_group_id);var j=$(document.createElement("option"));j.attr("id","assignment_option_"+e.id).val(e.id).text(e.title);f.append(j)}}$("#quiz_assignment_id").val(a.quiz.quiz_type||
"practice_quiz").change();if($(this).data("submit_type")=="save_and_publish")location.href=$(this).attr("action");else $.flashMessage("Quiz data saved");quiz.updateDisplayComments()}});d.find(".save_quiz_button").click(function(a){a.preventDefault();a.stopPropagation();d.data("submit_type","save_only").submit()}).end().find(".publish_quiz_button").click(function(a){a.preventDefault();a.stopPropagation();d.data("submit_type","save_and_publish").submit()});$("#show_question_details").change(function(){$("#questions").toggleClass("brief",
!$(this).attr("checked"))}).triggerHandler("change");$(".start_over_link").click(function(a){a.preventDefault();if(confirm("Scrap this quiz and start from scratch?"))location.href+="?fresh=1"});$("#quiz_assignment_id").change(function(){var a=$("#quiz_options").getTemplateData({textValues:["assignment_id","title"]}),c=$("#quiz_assignment_id").val(),e=$("#quiz_title_input").val();if(c){a=$("#quiz_assignment_id")[0];e=$(a.options[a.selectedIndex]).text()}else if(a.assignment_id)e="Quiz";$("#quiz_title").showIf(true);
$("#quiz_options_form .quiz_survey_setting").showIf(c&&c.match(/survey/));$("#quiz_points_possible").showIf(c=="graded_survey");$("#survey_instructions").showIf(c=="survey"||c=="graded_survey");$("#quiz_assignment_group").showIf(c=="assignment"||c=="graded_survey");$("#questions").toggleClass("survey_quiz",c=="survey"||c=="graded_survey");$("#quiz_display_points_possible").showIf(c!="survey"&&c!="graded_survey");$("#quiz_options_holder").toggleClass("survey_quiz",c=="survey"||c=="graded_survey");
$("#quiz_urls .update_quiz_url").attr("href");$("#quiz_title_input").val(e);$("#quiz_title_text").text(e)}).change();$(".question_form :input").keycodes("esc",function(){$(this).parents("form").find("input[value='Cancel']").click()});$(document).delegate(".blank_id_select","change",function(){var a=$(this).val(),c=$(this)[0].selectedIndex;$(this).closest(".question").find(".answer").css("display","none");if(a){a!="0"&&$(this).closest(".question").find(".answer.answer_idx_"+c).filter(":not(.answer_for_"+
a+")").each(function(){$(this).attr("class",$(this).attr("class").replace(/answer_for_[A-Za-z0-9]+/g,""));$(this).addClass("answer_for_"+a)});$(this).closest(".question").find(".answer.answer_for_"+a).css("display","")}else{$(this).closest(".question").find(".answer").css("display","");$(this).closest(".question").find(".answer.answer_idx_"+c).css("display","")}});$(".blank_id_select").change();$(document).delegate(".delete_question_link","click",function(a){a.preventDefault();$(this).parents(".question_holder").confirmDelete({url:$(this).parents(".question_holder").find(".update_question_url").attr("href"),
message:"Are you sure you want to delete this question?",success:function(){$(this).remove();quiz.updateDisplayComments()}})});$(document).delegate(".edit_question_link","click",function(a){a.preventDefault();a=$(this).parents(".question");var c=a.getTemplateData({textValues:["question_type","correct_comments","incorrect_comments","neutral_comments","question_name","question_points","answer_selection_type","blank_id"],htmlValues:["question_text"]});c.question_text=a.find("textarea[name='question_text']").val();
var e=[];a.find(".matching_answer_incorrect_matches_list li").each(function(){e.push($(this).text())});c.matching_answer_incorrect_matches=e.join("\n");c.question_points=parseFloat(c.question_points,10);if(isNaN(c.question_points))c.question_points=0;var f=$("#question_form_template").clone(true).attr("id",""),j=f.find(".question");f.fillFormData(c);j.addClass("selectable");f.find(".answer_selection_type").change().show();if(a.hasClass("missing_word_question")||c.question_type=="missing_word_question"){c=
a.getTemplateData({textValues:["text_before_answers","text_after_answers"]});answer_data=a.find(".original_question_text").getFormData();c.text_before_answers=answer_data.question_text;c.text_after_answers=answer_data.text_after_answers;c.question_text=c.text_before_answers;f.fillFormData(c)}var l=quiz.updateFormQuestion(f);f.find(".form_answers").empty();if(l.question_type=="calculated_question"){c=v(a).questions[0];f.find(".combinations_holder .combinations thead tr").empty();for(var k in c.variables){var s=
$(f.find(".variables .variable."+c.variables[k].name));if(c.variables[k].name=="variable")s=$(f.find(".variables .variable").get(k));if(s&&s.length>0){s.find(".min").val(c.variables[k].min);s.find(".max").val(c.variables[k].max);s.find(".round").val(c.variables[k].scale)}s=$("<th/>");s.text(c.variables[k].name);f.find(".combinations_holder .combinations thead tr").append(s)}s=$("<th class='final_answer'/>");s.text("Final Answer");f.find(".combinations_holder .combinations thead tr").append(s);for(k in c.formulas){f.find(".supercalc").val(c.formulas[k]);
f.find(".decimal_places .round").val(c.formula_decimal_places);f.find(".save_formula_button").click()}c.answer_tolerance&&f.find(".combination_answer_tolerance").val(c.answer_tolerance);f.find(".combination_count").val(c.answers.length);for(k in c.answers){s=$("<tr/>");for(var x in c.answers[k].variables){var w=$("<td/>");w.text(c.answers[k].variables[x].value);s.append(w)}var y=c.answers[k].answer_text;if(c.answer_tolerance)y=y+" <span style='font-size: 0.8em;'>+/-</span> "+c.answer_tolerance;w=
$("<td class='final_answer'/>");w.html(y);s.append(w);f.find(".combinations tbody").append(s);f.find(".combinations_holder").show()}f.triggerHandler("settings_change",false);j.triggerHandler("recompute_variables",true)}else a.find(".answers .answer").each(function(){var m=$(this).getTemplateData({textValues:l.textValues,htmlValues:l.htmlValues});m.answer_type=l.answer_type;m.question_type=l.question_type;m=u(m);f.find(".form_answers").append(m)});a.hasClass("essay_question")&&j.find(".comments_header").text("Comments for this question:");
a.hide().after(f);quiz.showFormQuestion(f);f.attr("action",a.find(".update_question_url").attr("href")).attr("method","POST").find(".submit_button").html("Update Question");f.find(":input:visible:first").focus().select();$("html,body").scrollTo({top:f.offset().top-10,left:0});setTimeout(function(){j.find(".question_content").triggerHandler("change");j.addClass("ready")},100)});$(".question_form :input[name='question_type']").change(function(){quiz.updateFormQuestion($(this).parents(".question_form"))});
$("#question_form_template .cancel_link").click(function(a){a.preventDefault();a=$(this).parents("form").prev();var c=a.attr("id")=="question_new";c||$(this).parents("form").remove();a.show();$("html,body").scrollTo({top:a.offset().top-10,left:0});if(c){a.remove();quiz.updateDisplayComments()}quiz.updateDisplayComments()});$(document).delegate("a.comment_focus","focus click",function(a){a.preventDefault();$(this).parents(".question_comment,.answer_comments").removeClass("empty").find("textarea.comments").focus().select()});
$(document).delegate("textarea.comments","focus",function(){$(this).parents(".question_comment,.answer_comments").removeClass("empty")}).delegate("textarea.comments","blur",function(){$(this).val($.trim($(this).val()));$(this).val()==""&&$(this).parents(".question_comment,.answer_comments").addClass("empty")});$(document).delegate(".numerical_answer_type","change",function(){var a=$(this).val(),c=$(this).parents(".numerical_answer");c.find(".numerical_answer_text").hide();c.find("."+a).show()}).change();
$(document).delegate(".select_answer_link","click",function(a){a.preventDefault();a=$(this).parents(".question");if(a.hasClass("selectable")){if(a.find(":input[name='question_type']").val()!="multiple_answers_question"){a.find(".answer:visible").removeClass("correct_answer");$(this).parents(".answer").addClass("correct_answer")}else $(this).parents(".answer").toggleClass("correct_answer");$(this).blur()}});$(".question_form :input").change(function(){$(this).parents(".answer").length>0&&$(this).parents(".answer").find(":input[name='"+
$(this).attr("name")+"']").val($(this).val())});$(".question_form select.answer_selection_type").change(function(){$(this).val()=="single_answer"?$(this).parents(".question").removeClass("multiple_answers"):$(this).parents(".question").addClass("multiple_answers")}).change();$(".delete_answer_link").click(function(a){a.preventDefault();$(this).parents(".answer").remove()});$(".add_question_group_link").click(function(a){a.preventDefault();$(".question_form .submit_button:visible,.quiz_group_form .submit_button:visible").each(function(){$(this).parents("form").submit()});
a=$("#group_top_template").clone(true).attr("id","group_top_new");var c=$("#group_bottom_template").clone(true).attr("id","group_bottom_new");$("#questions").append(a.show()).append(c.show());a.find(".edit_group_link").click();a.find(".quiz_group_form").attr("action",$("#quiz_urls .add_group_url").attr("href")).attr("method","POST");a.find(".submit_button").html("Create Group")});$(".add_question_link").click(function(a){a.preventDefault();$(".question_form:visible,.group_top.editing .quiz_group_form:visible").submit();
a=o();if($(this).parents(".group_top").length>0){for(var c=$(this).parents(".group_top").next();c.length>0&&!c.hasClass("group_bottom");)c=c.next();c.before(a.addClass("group"))}else $("#questions").append(a);a.find(".edit_question_link:first").click();a.parents(".question_holder").children("form").attr("action",$("#quiz_urls .add_question_url,#bank_urls .add_question_url").attr("href")).attr("method","POST").find(".submit_button").html("Create Question");a.find(".question_type").change();$("html,body").scrollTo({top:a.offset().top-
10,left:0});a.find(":input:first").focus().select()});var b=$("#find_question_dialog");$(".find_question_link").click(function(a){a.preventDefault();if(!b.hasClass("loaded")){b.data("banks",{});b.find(".side_tabs_table").hide();b.find(".message").show().text("Loading Question Banks...");a=b.find(".find_question_banks_url").attr("href");$.ajaxJSON(a,"GET",{},function(c){b.find(".message").hide();b.find(".side_tabs_table").show();b.addClass("loaded");for(idx in c){var e=c[idx].assessment_question_bank;
e.title=$.truncateText(e.title);var f=b.find(".bank.blank:first").clone(true).removeClass("blank");f.fillTemplateData({data:e});b.find(".bank_list").append(f);f.data("bank_data",e);f.show()}b.find(".bank:not(.blank):first").click()},function(){b.find(".message").text("Question Banks failed to load, please try again")})}b.data("add_source","");b.dialog("close").dialog({autoOpen:false,title:"Find Quiz Question",open:function(){b.find(".selected_side_tab").length==0&&b.find(".bank:not(.blank):first").click()},
width:600,height:400}).dialog("open")});var g=function(a){b.find(".quiz_group_select").find("option.group").remove();b.find(".quiz_group_select_holder").show();$("#questions .group_top:visible").each(function(){var c={};c.id=$(this).attr("id").substring(10);c.name=$(this).getTemplateData({textValues:["name"]}).name;var e=$("<option/>");e.text($.truncateText(c.name));e.val(c.id);e.addClass("group");b.find(".quiz_group_select option.bottom").before(e)});a&&$("#quiz_group_select").val(a);$("#quiz_group_select").val()==
"new"&&$("#quiz_group_select").val("none");$("#quiz_group_select").change()};$("#quiz_group_select").change(function(){if($(this).val()=="new"){var a=$("#add_question_group_dialog"),c=[];b.find(".question_list :checkbox:checked").each(function(){c.push($(this).parents(".found_question").data("question_data").id)});a.find(".questions_count").text(c.length);a.find("button").attr("disabled",false).filter(".submit_button").text("Create Group");a.dialog("close").dialog({width:400,autoOpen:false}).dialog("open")}});
$("#add_question_group_dialog .submit_button").click(function(){var a=$("#add_question_group_dialog");a.find("button").attr("disabled",true).filter(".submit_button").text("Creating Group...");var c=a.getFormData(),e=a.find(".add_question_group_url").attr("href");$.ajaxJSON(e,"POST",c,function(f){a.find("button").attr("disabled",false).filter(".submit_button").text("Create Group");var j=$("#group_top_template").clone(true).attr("id","group_top_new"),l=$("#group_bottom_template").clone(true).attr("id",
"group_bottom_new");$("#questions").append(j.show()).append(l.show());var k=f.quiz_group;j.fillTemplateData({data:k,id:"group_top_"+k.id,hrefValues:["id"]});j.fillFormData(f,{object_name:"quiz_group"});$("#unpublished_changes_message").slideDown();l.attr("id","group_bottom_"+k.id);quiz.updateDisplayComments();g(f.quiz_group.id);a.dialog("close")},function(){a.find("button").attr("disabled",false).filter(".submit_button").text("Create Group Failed, Please Try Again")})});$("#add_question_group_dialog .cancel_button").click(function(){$("#add_question_group_dialog").dialog("close");
$("#quiz_group_select").val("none")});var i=function(a){a=a.questions;var c=b.find(".bank.selected_side_tab"),e=c.data("bank_data");e=b.data("banks")[e.id];if(c.hasClass("selected_side_tab")){var f={};$(".display_question:visible").each(function(){var k=parseInt($(this).getTemplateData({textValues:["assessment_question_id"]}).assessment_question_id,10);if(k)f[k]=true});b.find(".page_link").showIf(e.pages&&e.last_page&&e.pages>e.last_page);g();c=$("<div/>");for(var j in a){e=a[j].assessment_question;
c.html(e.question_data.question_text);e.question_text=$.truncateText(c.text(),75);e.question_name=e.question_data.question_name;var l=b.find(".found_question.blank").clone(true).removeClass("blank");l.toggleClass("already_added",!!f[e.id]);l.fillTemplateData({data:e});l.find(":checkbox").attr("id","find_bank_question_"+e.id);l.find("label").attr("for","find_bank_question_"+e.id);l.data("question_data",e);b.find(".question_list").append(l);l.show()}}};$("#find_question_dialog").delegate(".bank","click",
function(a){a.preventDefault();a=$(this).getTemplateData({textValues:["id"]}).id;a=b.data("banks")[a];b.find(".bank").removeClass("selected");b.find(".selected_side_tab").removeClass("selected_side_tab");$(this).addClass("selected_side_tab");b.find(".page_link").data("page",0);a&&a.last_page&&b.find(".page_link").data("page",a.last_page);if(a){b.find(".found_question:visible").remove();i(a)}else{b.find(".found_question:visible").remove();b.find(".page_link").click();b.find(".question_list_holder").hide();
b.find(".question_message").show().text("Loading Questions...")}}).delegate(".page_link","click",function(a){a.preventDefault();var c=$(this);if(!c.hasClass("loading")){c.addClass("loading");b.find(".page_link").text("loading more questions...");var e=b.find(".bank.selected_side_tab").data("bank_data");a=b.find(".question_bank_questions_url").attr("href");a=$.replaceTags($.replaceTags($.replaceTags(a,"question_bank_id",e.id),"context_id",e.context_id),"context_type_plural",$.pluralize($.underscore(e.context_type)));
var f=(b.find(".page_link").data("page")||0)+1;a+="?page="+f;$.ajaxJSON(a,"GET",{},function(j){c.removeClass("loading");b.find(".page_link").data("page",f);b.find(".page_link").text("more questions");var l=b.data("banks")||{},k=l[e.id]||{};k.pages=j.pages;k.questions=(k.questions||[]).concat(j.questions);k.last_page=f;l[e.id]=k;b.data("banks",l);b.find(".question_message").hide();b.find(".question_list_holder").show();i(j)},function(){c.removeClass("loading");b.find(".question_message").text("Questions failed to load, please try again");
b.find(".page_link").text("loading more questions failed")})}}).delegate(".select_all_link","click",function(a){a.preventDefault();b.find(".question_list .found_question:not(.blank) :checkbox").attr("checked",true)}).delegate(".clear_all_link","click",function(a){a.preventDefault();b.find(".question_list .found_question:not(.blank) :checkbox").attr("checked",false)}).delegate(".cancel_button","click",function(){b.dialog("close")}).delegate(".group_button","click",function(){var a=$("#add_found_questions_as_group_dialog"),
c=[];b.find(".question_list :checkbox:checked").each(function(){c.push($(this).parents(".found_question").data("question_data").id)});a.find(".questions_count").text(c.length);a.dialog("close").dialog({autoOpen:false,title:"Add Questions as a Group"}).dialog("open")}).delegate(".submit_button","click",function(){var a=[];b.find(".question_list :checkbox:checked").each(function(){a.push($(this).parents(".found_question").data("question_data").id)});var c={};c.quiz_group_id=b.find(".quiz_group_select").val();
c.assessment_question_bank_id=b.find(".bank.selected_side_tab:first").data("bank_data").id;c.assessment_questions_ids=a.join(",");c.existing_questions="1";var e=b.find(".add_questions_url").attr("href");b.find("button").attr("disabled",true).filter(".submit_button").text("Adding Questions...");$.ajaxJSON(e,"POST",c,function(f){b.find("button").attr("disabled",false).filter(".submit_button").text("Add Selected Questions");b.find(".selected_side_tab").removeClass("selected_side_tab");for(idx in f)quiz.addExistingQuestion(f[idx].quiz_question);
b.dialog("close")},function(){b.find("button").attr("disabled",false).filter(".submit_button").text("Adding Questions Failed, please try again")})});$(".add_answer_link").bind("click",function(a,c){a.preventDefault();var e=$(this).parents(".question"),f=[],j=null,l=null,k="single_answer";if(e.hasClass("multiple_choice_question")){f=[{answer_text:"Answer Text",comments:"Response if the student chooses this answer"}];j="select_answer";l="multiple_choice_question"}else if(e.hasClass("true_false_question"))return;
else if(e.hasClass("short_answer_question")){f=[{answer_text:"Answer Text",comments:"Response if the student chooses this answer"}];j="short_answer";l="short_answer_question";k="any_answer"}else if(e.hasClass("essay_question")){f=[{comments:"Response to show student after they submit an answer"}];j="comment";l="essay_question"}else if(e.hasClass("matching_question")){f=[{answer_match_left:"Answer Text",answer_match_right:"Matching Text",comments:"Response if the user misses this match"}];j="matching_answer";
l="matching_question";k="matching"}else if(e.hasClass("missing_word_question")){f=[{answer_text:"Answer Text",comments:"Response if the student chooses this answer"}];j="short_answer";l="missing_word_question"}else if(e.hasClass("numerical_question")){f=[{numerical_answer_type:"exact_answer",answer_exact:"#",answer_error_margin:"#",comments:"Response if the student matches this answer"}];j="numerical_answer";l="numerical_question";k="any_answer"}else if(e.hasClass("multiple_answers_question")){f=
[{answer_text:"Answer Text",comments:"Response if the student chooses this answer"}];j="select_answer";l="multiple_answers_question";k="multiple_answers"}else if(e.hasClass("multiple_dropdowns_question")){f=[{answer_text:"Answer Text",comments:"Response if the student chooses this answer"}];j="select_answer";l="multiple_dropdowns_question"}else if(e.hasClass("fill_in_multiple_blanks_question")){f=[{answer_text:"Answer Text",comments:"Response if the student chooses this answer"}];j="short_answer";
l="fill_in_multiple_blanks_question";k="any_answer"}for(var s=0;s<f.length;s++){var x=f[s];x.answer_type=j;x.question_type=l;x.blank_id=e.find(".blank_id_select").val();x.blank_index=e.find(".blank_id_select")[0].selectedIndex;$answer=u(x);if(k=="any_answer")$answer.addClass("correct_answer");else k=="matching"&&$answer.removeClass("correct_answer");e.find(".form_answers").append($answer.show());if(!c){$("html,body").scrollTo($answer);$answer.find(":text:visible:first").focus().select()}}});$(document).delegate(".answer_comment_holder",
"click",function(){$(this).find(".answer_comment").slideToggle()});$("#question_form_template").submit(function(a){a.preventDefault();a.stopPropagation();var c=$(this).prev();a=$(this);var e=a.find(".answer"),f=$(this).find(".question"),j=f.getFormData({values:["question_type","question_name","question_points","correct_comments","incorrect_comments","neutral_comments","question_text","answer_selection_type","text_after_answers","matching_answer_incorrect_matches"]});j.assessment_question_bank_id=
$(".question_bank_id").text()||"";var l=null;if(j.question_type=="calculated_question"){if(a.find(".combinations_holder .combinations tbody tr").length===0)l="Please generate at least one possible solution"}else if(e.length===0||e.filter(".correct_answer").length===0)if(e.length===0&&j.question_type!="essay_question"&&j.question_type!="text_only_question")l="Please add at least one answer";else if(e.filter(".correct_answer").length===0&&(j.question_type=="multiple_choice_question"||j.question_type==
"true_false_question"||j.question_tyep=="missing_word_question"))l="Please choose a correct answer";if(l)a.find(".answers_header").errorBox(l,true);else{var k=$.extend({},j);k.points_possible=parseFloat(k.question_points);k.answers=[];c.find(".blank_id_select").empty();var s={},x=false;if(k.question_type=="multiple_dropdowns_question"||k.question_type=="fill_in_multiple_blanks_question"){x=true;f.find(".blank_id_select option").each(function(){s[$(this).text()]=true})}f.find(".blank_id_select option").each(function(){c.find(".blank_id_select").append($(this).clone())});
e=f.find(".answer").each(function(m){var r=$(this);r.show();var t=r.getFormData();t.blank_id=r.find(".blank_id").text();t.answer_text=r.find("input[name='answer_text']:visible").val();if(j.question_type=="true_false_question")t.answer_text=m==0?"True":"False";t.answer_weight=r.hasClass("correct_answer")?100:0;x&&t.blank_id&&!s[t.blank_id]||k.answers.push(t)});if(f.hasClass("calculated_question")){k.answers=[];k.variables=[];var w={};f.find(".variables .variable").each(function(m){var r={};r.scale=
"0";r.name=$(this).find(".name").text();r.scale=parseFloat($(this).find(".round").val(),10)||0;r.min=parseFloat($(this).find(".min").val(),10)||0;r.max=parseFloat($(this).find(".max").val(),10)||0;w[r.name]=m;k.variables.push(r)});k.formulas=[];f.find(".formulas .formula").each(function(){var m={};m.formula=$.trim($(this).text());k.formulas.push(m)});k.formula_decimal_places=parseInt(f.find(".decimal_places .round").val(),10)||0;k.answer_tolerance=parseFloat(f.find(".combination_answer_tolerance").val(),
10)||0;k.answerDecimalPoints=parseFloat(f.find(".combination_error_margin").val(),10)||0;var y=f.find(".combinations thead th");f.find(".combinations tbody tr").each(function(){var m={};m.variables=[];m.answer=parseFloat($(this).find("td.final_answer").text(),10)||0;$(this).find("td:not(.final_answer)").each(function(r){var t={};t.name=$.trim(y.eq(r).text());t.value=parseFloat($(this).text(),10)||0;m.variables.push(t)});m.variables=m.variables.sort(function(r,t){return w[r.name]-w[t.name]});k.answers.push(m)})}quiz.updateDisplayQuestion(c,
k);quiz.answerTypeDetails(k.question_type);a.remove();$("html,body").scrollTo({top:c.offset().top-10,left:0});a=$("#quiz_urls .add_question_url,#bank_urls .add_question_url").attr("href");e="POST";if(c.attr("id")!="question_new"){a=c.find(".update_question_url").attr("href");e="PUT"}j=v(c);f=n(j);j=h(f);if(c.parent(".question_holder").hasClass("group"))if(f=quiz.findContainerGroup(c.parent(".question_holder")))j["question[quiz_group_id]"]=f.attr("id").substring(10);if($("#assessment_question_bank_id").length>
0)j["assessment_question[assessment_question_bank_id]"]=$("#assessment_question_bank_id").text();c.loadingImage();quiz.updateDisplayComments();$.ajaxJSON(a,e,j,function(m){c.loadingImage("remove");m=m.quiz_question||m.assessment_question;var r=$.extend({},m,m.question_data);r.assessment_question_id=r.assessment_question_id||m.assessment_question_id||m.id;quiz.updateDisplayQuestion(c,r,true);$("#unpublished_changes_message").slideDown()},function(m){c.formErrors(m)})}});$("#sort_questions").sortable({revert:false,
update:function(){var a=$(this).sortable("toArray"),c;for(c in a){var e=a[c];e&&e!="sort_question_blank"&&$("#"+e.substring(5)).appendTo($("#questions"))}}});$(document).delegate("input.float_value","keydown",function(a){a.keyCode>57&&a.keyCode<91&&a.preventDefault()}).delegate("input.float_value","change",function(){quiz.parseInput($(this),"float")}).delegate("input.float_value","blur",function(){quiz.parseInput($(this),"float")}).delegate("input.float_value","focus",function(){quiz.parseInput($(this),
"float")});$(".question_form textarea, .question_form :text, .answer textarea, .answer :text").focus(function(){$(this).select()});$(".keep_editing_link").click(function(a){a.preventDefault();$(".question_generated,.question_preview").hide();$(".question_editing").show();$("html,body").scrollTo($("#questions"))});$(".quiz_group_form").formSubmit({object_name:"quiz_group",beforeSubmit:function(a){var c=$(this);c.parents(".group_top").fillTemplateData({data:a}).removeClass("editing");c.loadingImage()},
success:function(a){var c=$(this),e=c.parents(".group_top"),f=a.quiz_group;c.loadingImage("remove");e=c.parents(".group_top");e.removeClass("editing");e.fillTemplateData({data:f,id:"group_top_"+f.id,hrefValues:["id"]});e.fillFormData(a,{object_name:"quiz_group"});for(a=e.next();a.length>0&&!a.hasClass("group_bottom");)a=a.next();$("#unpublished_changes_message").slideDown();a.attr("id","group_bottom_"+f.id);quiz.updateDisplayComments()}});$("#questions").sortable({handle:".move_icon",helper:function(a,
c){return c.clone().removeClass("group")},items:".group_top,.group_bottom,.question_holder",tolerance:"pointer",start:function(a,c){c.placeholder.css("visibility","visible");if(c.item.hasClass("group_top")){c.helper.addClass("dragging");for(var e=c.item,f=[];e.length>0&&!e.hasClass("group_bottom");){e=e.next();if(!e.hasClass("ui-sortable-placeholder")){f.push(e);e.hide()}}c.item.data("take_with",f);c.placeholder.show()}else{quiz.findContainerGroup(c.placeholder)?c.placeholder.addClass("group"):c.placeholder.removeClass("group");
c.placeholder.append("<div class='question_placeholder' style='height: "+(c.helper.height()-10)+"px;'>&nbsp;</div>")}},change:function(a,c){var e=quiz.findContainerGroup(c.placeholder);if(c.item.hasClass("group_top")){if(e){e.before(c.placeholder);$("html,body").scrollTo(c.placeholder)}}else{if(e)if(e.attr("id")=="group_top_new"){e.before(c.placeholder);$("html,body").scrollTo(c.placeholder)}else e.hasClass("question_bank_top")?e.before(c.placeholder).addClass("group"):c.placeholder.addClass("group");
else c.placeholder.removeClass("group");c.placeholder.height(c.helper.height()).find(".question_placeholder").height(c.helper.height()-10)}},update:function(a,c){var e=$("#quiz_urls .reorder_questions_url, #bank_urls .reorder_questions_url").attr("href"),f={},j=$("#questions"),l=[];if(quiz.findContainerGroup(c.item)){j=quiz.findContainerGroup(c.item);$list=[];e=j.find(".reorder_group_questions_url").attr("href");for(f=j.next();f.length>0&&!f.hasClass("group_bottom");){l.push(f);f=f.next()}}else j.children(".question_holder:not(.group),.group_top").each(function(){l.push($(this))});
j.loadingImage();var k=[],s=$("#questions.question_bank").length>0;$.each(l,function(x,w){var y=s?w.find(".assessment_question_id").text():w.hasClass("question_holder")?"question_"+w.find(".question").attr("id").substring(9):"group_"+w.attr("id").substring(10);k.push(y)});f={order:k.join(",")};$.ajaxJSON(e,"POST",f,function(){j.loadingImage("remove")})},stop:function(a,c){if(c.item.hasClass("group_top")){var e=c.item.data("take_with");if(e){var f=c.item,j;for(j in e){var l=e[j];f.after(l.show());
f=l}}}else if(quiz.findContainerGroup(c.item)){c.item.addClass("group");for(f=c.item.prev();f.length>0&&!f.hasClass("group_top");)f=f.prev();f.find(".expand_link").click()}else c.item.removeClass("group")}});$(document).delegate(".edit_group_link","click",function(a){if($(this).closest(".group_top").length!=0){a.preventDefault();a=$(this).parents(".group_top");var c=a.getTemplateData({textValues:["name","pick_count","question_points"]});a.fillFormData(c,{object_name:"quiz_group"});a.addClass("editing");
a.find(":text:visible:first").focus().select();a.find(".quiz_group_form").attr("action",a.find(".update_group_url").attr("href")).attr("method","PUT");a.find(".submit_button").html("Update Group")}}).delegate(".delete_group_link","click",function(a){if($(this).closest(".group_top").length!=0){a.preventDefault();a=$(this).parents(".group_top");for(var c=$("nothing").add(a),e=a.next();e.length>0&&!e.hasClass("group_bottom");){c=c.add(e);e=e.next()}c=c.add(e);a.confirmDelete({url:a.find(".update_group_url").attr("href"),
confirmed:function(){c.dim()},success:function(){c.fadeOut(function(){$(this).remove();quiz.updateDisplayComments()})}})}}).delegate(".cancel_button","click",function(){if($(this).closest(".group_top").length!=0){var a=$(this).parents(".group_top");a.removeClass("editing");if(a.attr("id")=="group_top_new"){for(var c=a.next();c.length>0&&!c.hasClass("group_bottom");){c.removeClass("group");c=c.next()}c.remove();a.remove()}quiz.updateDisplayComments()}}).delegate(".collapse_link","click",function(a){if($(this).closest(".group_top").length!=
0){a.preventDefault();$(this).parents(".group_top").find(".collapse_link").addClass("hidden").end().find(".expand_link").removeClass("hidden");for(a=$(this).parents(".group_top").next();a.length>0&&a.hasClass("question_holder");){a.hide();a=a.next()}}}).delegate(".expand_link","click",function(a){if($(this).closest(".group_top").length!=0){a.preventDefault();$(this).parents(".group_top").find(".collapse_link").removeClass("hidden").end().find(".expand_link").addClass("hidden");for(a=$(this).parents(".group_top").next();a.length>
0&&a.hasClass("question_holder");){a.show();a=a.next()}}});if(wikiSidebar){wikiSidebar.init();wikiSidebar.attachToEditor($("#quiz_description"))}setTimeout(function(){$("#quiz_description").editorBox()},2E3);$(".toggle_description_views_link").click(function(a){a.preventDefault();$("#quiz_description").editorBox("toggle")});$(".toggle_question_content_views_link").click(function(a){a.preventDefault();$(this).parents(".question_form").find(".question_content").editorBox("toggle")});$(".toggle_text_after_answers_link").click(function(a){a.preventDefault();
$(this).parents(".question_form").find(".text_after_answers").editorBox("toggle")});$(document).bind("editor_box_focus",function(a,c){wikiSidebar.attachToEditor(c)});$(".quiz_options_link,.link_to_content_link").click(function(a){a.preventDefault();$("#quiz_content_links,#quiz_options_holder").toggle();if($("#quiz_content_links:visible").length>0)wikiSidebar&&wikiSidebar.show();else wikiSidebar&&wikiSidebar.hide()});$("#calc_helper_methods").change(function(){var a=$(this).val();$("#calc_helper_method_description").text(calcCmd.functionDescription(a));
a="<pre>"+calcCmd.functionExamples(a).join("</pre><pre>")+"</pre>";$("#calc_helper_method_examples").html(a)});$("#equations_dialog_tabs").tabs()});$.fn.multipleAnswerSetsQuestion=function(){var d=$(this),b=d.find(".question_content"),g=d.find(".blank_id_select"),i=d.find(".question_type");if(!d.data("multiple_sets_question_bindings")){d.data("multiple_sets_question_bindings",true);b.bind("keypress",function(a){setTimeout(function(){$(a.target).triggerHandler("change")},50)});b.bind("change",function(){var a=
i.val();if(!(a!="multiple_dropdowns_question"&&a!="fill_in_multiple_blanks_question")){a=$(this).editorBox("get_code").match(/\[[A-Za-z][A-Za-z0-9]*\]/g);g.find("option.shown_when_no_other_options_available").remove();g.find("option").addClass("to_be_removed");var c={};if(a)for(var e=0;e<a.length;e++)if(a[e]){var f=a[e].substring(1,a[e].length-1);if(!c[f]){var j=g.find("option").eq(e);j.length||(j=$("<option/>").appendTo(g));j.removeClass("to_be_removed").addClass(f).val(f).text(f);c[f]=true}}g.find("option:not(.shown_when_no_other_options_available)").length||
g.append("<option class='shown_when_no_other_options_available' value='0'>[ Enter Answer Variables Above ]</option>");g.find("option.to_be_removed").remove();g.change()}}).change();g.change(function(){var a=i.val();if(!(a!="multiple_dropdowns_question"&&a!="fill_in_multiple_blanks_question")){d.find(".form_answers .answer").hide().addClass("hidden");g.find("option").each(function(f){$(this);d.find(".form_answers .answer_for_"+$(this).val()).each(function(){$(this).attr("class",$(this).attr("class").replace(/answer_idx_\d+/g,
""))}).addClass("answer_idx_"+f)});if(g.val()!=="0"){var c=g.val(),e=g[0].selectedIndex;e>=0&&d.find(".form_answers .answer").each(function(){var f=$(this);if(!f.attr("class").match(/answer_idx_/))if(f.attr("class").match(/answer_for_/)){var j=null,l=f.attr("class").match(/answer_for_[^\s]+/);if(l&&l[0])l=l[0].substring(11);g.find("option").each(function(k){if($(this).text()==l)j=k});if(j===null)j=e;f.addClass("answer_idx_"+j)}else f.addClass("answer_idx_"+e)});g.find("option").each(function(f){var j=
$(this).text();d.find(".form_answers .answer.answer_idx_"+f).find(".blank_id").each(function(){$(this).text(j)})});a=d.find(".form_answers .answer.answer_idx_"+e).show().removeClass("hidden");if(!a.length&&c&&c!=="0"){for(a=0;a<2;a++)d.find(".add_answer_link").triggerHandler("click",true);a=d.find(".form_answers .answer.answer_idx_"+e).show().removeClass("hidden")}a.filter(".correct_answer").length||a.filter(":first").addClass("correct_answer");a.each(function(){$(this).find(".blank_id").text(c)})}}}).change()}};
$.fn.formulaQuestion=function(){var d=$(this);if(!d.data("formula_question_bindings")){d.data("formula_question_bindings",true);d.find(".supercalc").superCalc({pre_process:function(){var b=[];d.find(".variables .variable").each(function(){var g={name:$(this).attr("data-name"),value:$(this).attr("data-value")};b.push(g.name+" = "+g.value)});return b},formula_added:function(){d.triggerHandler("settings_change",true)}});d.find(".compute_combinations").click(function(){var b=$(this);b.text("Generating...").attr("disabled",
true);if(d.find(".question_type").val()=="calculated_question"){var g=d.find(".combinations");g.find("thead tr").empty();d.find(".variables .variable").each(function(){var w=$("<th/>");w.text($(this).find(".name").text());g.find("thead tr").append(w)});var i=$("<th/>");i.text("Final Answer");i.addClass("final_answer");g.find("thead tr").append(i);g.find("tbody").empty();var a=parseInt(d.find(".combination_count").val(),10)||10,c=0,e=0,f=0,j=d.find(".formulas .formula_row:last .status"),l=d.find(".variables .variable"),
k=g.find("tbody");d.find(".supercalc").superCalc("cache_finds");var s=parseFloat(d.find(".combination_answer_tolerance").val(),10),x=function(){b.html("Generating... ("+c+"/"+a+")");for(var w=document.createDocumentFragment(),y=0;y<5&&c<a&&f<25;y++){l.each(function(){$(this).find(".variable_setting:first").trigger("change",{cache:true})});d.find(".supercalc").superCalc("recalculate",true);var m=j.attr("data-res"),r=[];l.each(function(){r.push($(this).attr("data-value"))});var t=parseFloat(m.substring(1),
10);if(m.match(/^=/)&&m!="= NaN"&&m!="= Infinity"&&t){var A=$("<tr/>");l.each(function(){var C=$("<td/>");C.html($(this).attr("data-value"));A.append(C)});t=$("<td/>");t.addClass("final_answer");m=$.trim(m.substring(1));var B=s;if(B)m+=" <span style='font-size: 0.8em;'>+/-</span> "+B;t.html(m);A.append(t);c++;f=0;w.appendChild(A[0])}else f++}k[0].appendChild(w);b.html("Generating... ("+c+"/"+a+")");if(e>=a||c>=a||f>=25){d.find(".supercalc").superCalc("clear_cached_finds");b.text("Generate").attr("disabled",
false);if(c==0)alert("The system could not generate any valid combinations for the parameters given");else c<a&&alert("The system could only generate "+c+" valid combinations for the parameters given");d.triggerHandler("settings_change",false)}else{e++;setTimeout(function(){x()},500)}};setTimeout(x,100)}});d.find(".recompute_variables").click(function(){d.find(".question_type").val()=="calculated_question"&&d.triggerHandler("recompute_variables",true)});d.bind("recompute_variables",function(b,g){d.find(".variables .variable").each(function(){$(this).find(".variable_setting:first").trigger("change",
g?null:{recompute:true})})});d.bind("settings_change",function(b,g){if(d.find(".question_type").val()=="calculated_question"){var i=d.find(".variables tbody tr.variable").length>0,a=d.find(".formulas .formula").length>0;d.find(".combinations_option").attr("disabled",!i||!a);d.find(".variables_specified").showIf(i);d.find(".formulas_specified").showIf(a);d.hasClass("ready")&&g&&d.find(".combinations_holder .combinations tbody tr").remove();d.find(".combinations_holder").showIf(d.find(".combinations tbody tr").length>
0)}});d.find(".variables").delegate(".variable_setting","change",function(b,g){if(d.find(".question_type").val()=="calculated_question"){var i=$(b.target).parents(".variable"),a=i.data("cached_data");if(!a||!g||!g.cache){a=i.getFormData();a.min=parseFloat(a.min)||0;a.max=Math.max(a.min,parseFloat(a.max)||0);a.round=parseInt(a.round,10)||0;a.range=a.max-a.min;a.rounder=Math.pow(10,a.round)||1}g&&g.cache&&i.data("cached_data",a);var c=Math.random()*a.range+a.min;c=Math.round(c*a.rounder)/a.rounder;
i.attr("data-value",c);if(!g||g.template)i.find(".value").html(c);if(!g||g.recompute){d.find(".supercalc").superCalc("recalculate");d.triggerHandler("settings_change",true)}}});d.find(".help_with_equations_link").click(function(b){b.preventDefault();$("#calc_helper_methods").empty();b=calcCmd.functionList();for(var g in b){var i=b[g][0],a=$("<option/>");a.val(i).text(i);$("#calc_helper_methods").append(a)}$("#calc_helper_methods").change();$("#help_with_equations_dialog").dialog("close").dialog({autoOpen:false,
title:"Help with Quiz Question Formulas",width:500}).dialog("open")});d.find(".combinations_option").attr("disabled",true);d.find(".question_content").bind("keypress",function(b){setTimeout(function(){$(b.target).triggerHandler("change")},50)});d.find(".question_content").bind("change",function(){var b=$(this).editorBox("get_code").match(/\[[A-Za-z][A-Za-z0-9]*\]/g);d.find(".variables").find("tr.variable").addClass("to_be_removed");d.find(".variables").showIf(b&&b.length>0);var g={};if(b)for(var i=
0;i<b.length;i++)if(b[i]){var a=b[i].substring(1,b[i].length-1);if(!g[a]){var c=d.find(".variables tr.variable").eq(i);if(c.length===0){c=$("<tr class='variable'><td class='name'></td><td><input type='text' name='min' class='min variable_setting' style='width: 30px;' value='1'/></td><td><input type='text' name='max' class='max variable_setting' style='width: 30px;' value='10'/></td><td><select name='round' class='round variable_setting'><option>0</option><option>1</option><option>2</option><option>3</option></td><td class='value'></td></tr>");
d.find(".variables tbody").append(c);c.find(".variable_setting:first").triggerHandler("change")}c.removeClass("to_be_removed");c.addClass(a);c.attr("data-name",a);c.find("td.name").text(a);g[a]=true}}d.find(".variables").find("tr.to_be_removed").remove();d.find(".supercalc").superCalc("recalculate",true);d.triggerHandler("settings_change",false)}).change()}}})();var calcCmd;
(function(){var o=function(q){var z={};z.formula_rows=q.find(".formula_row");z.formula_rows.each(function(){this.formula=$(this).find(".formula");this.status=$(this).find(".status");$(this).data("formula",$(this).find(".formula"));$(this).data("status",$(this).find(".status"))});z.round=q.find(".round");z.status=q.find(".status");z.last_row_details=q.find(".last_row_details");return z};$.fn.superCalc=function(q,z){if(q=="recalculate")$(this).triggerHandler("calculate",z);else if(q=="clear")calcCmd.clearMemory();
else if(q=="cache_finds")$(this).data("cached_finds",o($(this).data("table")));else if(q=="clear_cached_finds")$(this).data("cached_finds",null);else{q=q||{};q.c1=true;var u=$(this),v=$("<table class='formulas'><thead><tr><th>Formula</th><th>Result</th><th>&nbsp;</th></tr></thead><tfoot><tr><td colspan='3' class='last_row_details' style='display: none;'>the last formula row will be used to compute the final answer</td></tr><tr><td></td><td class='decimal_places'><select class='round'><option>0</option><option>1</option><option>2</option><option>3</option></select> Decimal Places</td></tr></tfoot><tbody></tbody></table>");
$(this).data("table",v);u.before(v);v.find("tfoot tr:last td:first").append(u);var h=u.clone(true).removeAttr("id");v.find("tfoot tr:last td:first").append(h);var n=$("<button type='button' class='save_formula_button'>Save</button>");v.find("tfoot tr:last td:first").append(n);u.hide();n=$("<input type='text' readonly='true'/>");v.find("tfoot tr:last td:first").append(n.hide());u.data("supercalc_options",q);u.data("supercalc_answer",n);v.delegate(".save_formula_button","click",function(){h.triggerHandler("keypress",
true)});v.delegate(".delete_formula_row_link","click",function(p){p.preventDefault();$(p.target).parents("tr").remove();u.triggerHandler("calculate")});v.find("tbody").sortable({items:".formula_row",update:function(){u.triggerHandler("calculate")}});v.delegate(".round","change",function(){u.triggerHandler("calculate")});u.bind("calculate",function(p,d){calcCmd.clearMemory();var b=$(this).data("cached_finds")||o(v);if(q.pre_process&&$.isFunction(q.pre_process)){var g=q.pre_process(),i;for(i in g){d||
u.val(g[i]||"");try{calcCmd.compute(g[i])}catch(a){}}}b.formula_rows.each(function(){var c=this.formula.html();u.val(c);var e=null;try{e="= "+calcCmd.computeValue(c)}catch(f){e=f.toString()}if(e&&e.match(/=/)){c=parseFloat(e.substring(e.indexOf("=")+1),10);e=Math.pow(10,parseInt(b.round.val(),10)||0)||1;e="= "+Math.round(c*e)/e}this.status.attr("data-res",e);d||this.status.html(e)});if(!d){b.formula_rows.length>1&&b.formula_rows.removeClass("last_row").filter(":last").addClass("last_row");b.last_row_details.showIf(b.formula_rows.length>
1);b.status.removeAttr("title").filter(":last").attr("title","This value is an example final answer for this question type");u.val("")}});h.bind("keypress",function(p,d){u.val(h.val());if(p.keyCode==13||d&&h.val()){p.preventDefault();p.stopPropagation();var b=$("<tr class='formula_row'><td class='formula' title='Drag to reorder'></td><td class='status'></td><td><a href='#' class='delete_formula_row_link no-hover'><img src='/images/delete_circle.png'/></a></td></tr>");b.find("td:first").text(u.val());
u.val("");h.val("");v.find("tbody").append(b);u.triggerHandler("calculate");h.focus();q&&q.formula_added&&$.isFunction(q.formula_added)&&q.formula_added.call(u)}})}}})();calcCmd={};
(function(){var o={},q={},z={},u,v=[{regex:/\s+/,token:"whitespace"},{regex:/[a-zA-Z][a-zA-Z0-9_\.]*/,token:"variable"},{regex:/[0-9]*\.?[0-9]+/,token:"number"},{regex:/\+/,token:"add"},{regex:/\-/,token:"subtract"},{regex:/\*/,token:"multiply"},{regex:/\//,token:"divide"},{regex:/\(/,token:"open_paren"},{regex:/\)/,token:"close_paren"},{regex:/\,/,token:"comma"},{regex:/\^/,token:"power"},{regex:/\=/,token:"equals"}],h=0,n=function(a){var c=null;switch(a[h].token){case "number":c=a[h];break;case "subtract":if(a[h+
1]&&a[h+1].token=="number"){a[h+1].value="-"+a[h+1].value;h++;c=a[h]}else throw"expecting a number at "+a[h].newIndex;break;case "variable":if(a[h+1]&&a[h+1].token=="open_paren"){c=a[h];c.token="method";c.arguments=[];var e="comma";h+=2;if(a[h].token=="close_paren"){e="close_paren";h++}for(;e=="comma";){c.arguments.push(d(a,["comma","close_paren"]));e=a[h].token;h++}h--;if(e!="close_paren")throw"expecting close parenthesis at "+a[h].newIndex;}else c=a[h];break;case "open_paren":c=a[h];c.token="parenthesized_expression";
h++;c.expression=d(a,["close_paren"])}if(!c)throw"expecting a value at "+(a&&a[h]&&a[h].newIndex||0)+", got a "+(a&&a[h]&&a[h].token||"nothing");h++;return c},p=function(a){switch(a[h].token){case "add":return a[h++];case "subtract":return a[h++];case "multiply":return a[h++];case "divide":return a[h++];case "power":return a[h++]}throw"unexpected "+(a&&a[h]&&a[h].token||"value")+" at "+(a&&a[h]&&a[h].newIndex||0);},d=function(a,c){var e={token:"expression",newIndex:a[h].newIndex};e.expressionItems=
[];e.expressionItems.push(n(a));if(h>a.length)return e;for(var f=false;h<a.length&&!f;){for(var j in c)if(a[h].token==c[j])f=true;if(!f){e.expressionItems.push(p(a));e.expressionItems.push(n(a))}}return e},b=function(a){return{token:"number",value:a,calculatedValue:a}},g=function(a){switch(a.token){case "number":return parseFloat(a.value);case "expression":var c=a.expressionItems,e=[c[0]];for(a=1;a<c.length;a+=2){var f=c[a];if(f.token=="power"){f=e.pop();var j=c[a+1];e.push(b(Math.pow(g(f),g(j))))}else{e.push(c[a]);
e.push(c[a+1])}}c=[e[0]];for(a=1;a<e.length;a+=2){f=e[a];if(f.token=="multiply"){f=c.pop();j=e[a+1];c.push(b(g(f)*g(j)))}else if(f.token=="divide"){f=c.pop();j=e[a+1];c.push(b(g(f)/g(j)))}else{c.push(e[a]);c.push(e[a+1])}}e=[c[0]];for(a=1;a<c.length;a+=2){f=c[a];if(f.token=="add"){f=e.pop();j=c[a+1];e.push(b(g(f)+g(j)))}else if(f.token=="subtract"){f=e.pop();j=c[a+1];e.push(b(g(f)-g(j)))}else{e.push(c[a]);e.push(c[a+1])}}if(e.length===0)throw"expressions should have at least one value";else if(e.length>
1)throw"unexpected modifier: "+e[1].token;else a=g(e[0]);return a;case "parenthesized_expression":return g(a.expression);case "variable_assignment":if(a.variable.value=="_")throw"the variable '_' is reserved";z[a.variable.value]=g(a.assignmentExpression);return z[a.variable.value];case "variable":if(a.value=="_")return u||0;e=(e=q&&q[a.value])||z&&z[a.value];if(!e)throw"undefined variable "+a.value;return e;case "method":f=[];for(j in a.arguments){e=g(a.arguments[j]);a.arguments[j].computedValue=
e;f.push(e)}if(o[a.value])return o[a.value].apply(null,f);else throw"unrecognized method "+a.value;}throw"Unexpected token type: "+a.token;};calcCmd.clearMemory=function(){z={};u=null};var i={};calcCmd.compute=function(a){var c={};a=a.toString();c.command=a;if(tree=i[a]){c.syntax=tree.syntax;c.tree=tree.tree}else{for(var e=a,f=0,j=[];f<e.length;){var l;a:{l=f;var k=e.substring(l),s={},x=void 0;for(x in v){var w=v[x],y=k.match(w.regex);if(y&&y[0]&&k.indexOf(y[0])==0){s.token=w.token;s.value=y[0];s.newIndex=
l+y[0].length;l=s;break a}}l=null}if(!l)throw"unrecognized token at "+f;f=l.newIndex;j.push(l)}c.syntax=j;e=c.syntax;f=[];for(var m in e)e[m].token!="whitespace"&&f.push(e[m]);e=f;m=null;h=0;if(e[h].token=="variable"&&e.length>1&&e[h+1].token=="equals"){m={token:"variable_assignment",newIndex:e[h].newIndex};m.variable=e[h];if(e.length>2){h=2;m.assignmentExpression=d(e)}else throw"Expecting value at "+e[h+1].newIndex;}else m=d(e);c.tree=m;i[a]=c}c.computedValue=g(c.tree);u=c.computedValue;return c};
calcCmd.computeValue=function(a){return calcCmd.compute(a).computedValue};calcCmd.addFunction=function(a,c,e,f){if(typeof a=="string"){c.description=e;if(typeof f=="string")f=[f];c.examples=f;o[a]=c;return true}return false};calcCmd.addPredefinedVariable=function(a,c){c=parseFloat(c);if(typeof a=="string"&&(c||c==0))q[a]=c};calcCmd.functionDescription=function(a){return o[a]?o[a].description||"No description found for the function, "+a:a+" is not a recognized function"};calcCmd.functionExamples=function(a){return o[a]?
o[a].examples||[]:[]};calcCmd.functionList=function(){var a=[],c;for(c in o)a.push([c,o[c].description||"No description given"]);a.sort(function(e,f){return e[0]>f[0]?1:e[0]<f[0]?-1:0});return a}})();
(function(){var o=function(h,n,p,d){calcCmd.addFunction(h,n,p,d)};calcCmd.addPredefinedVariable("pi",Math.PI,void 0);calcCmd.addPredefinedVariable("e",Math.exp(1),void 0);o("abs",function(h){return Math.abs(h)},"Returns the absolute value of the given value","abs(x)");o("asin",function(h){return Math.asin(h)},"Returns the arcsin of the given value","asin(x)");o("acos",function(h){return Math.acos(h)},"Returns the arccos of the given value","acos(x)");o("atan",function(h){return Math.atan(h)},"Returns the arctan of the given value",
"atan(x)");o("log",function(h,n){return Math.log(h)/Math.log(n||10)},"Returns the log of the given value with an optional base","log(x, [base])");o("ln",function(h){return Math.log(h)},"Returns the natural log of the given value","ln(x)");o("rad_to_deg",function(h){return h*180/Math.PI},"Returns the given value converted from radians to degrees","rad_to_deg(radians)");o("deg_to_rad",function(h){return h*Math.PI/180},"Returns the given value converted from degrees to radians","deg_to_rad(degrees)");
o("sin",function(h){return Math.sin(h)},"Returns the sine of the given value","sin(radians)");o("cos",function(h){return Math.cos(h)},"Returns the cosine of the given value","cos(radians)");o("tan",function(h){return Math.tan(h)},"Returns the tangent of the given value","tan(radians)");o("pi",function(){return Math.PI},"Returns the computed value of pi","pi()");o("if",function(h,n,p){return h?n:p},"Evaluates the first argument, returns the second argument if it evaluates to a non-zero value, otherwise returns the third value",
"if(bool,success,fail)");var q=function(h){return h.length==1&&h[0]instanceof Array?h[0]:h};o("max",function(){for(var h=q(arguments),n=h[0],p=0;p<h.length;p++)n=Math.max(n,h[p]);return n},"Returns the highest value in the list",["max(a,b,c...)","max(list)"]);o("min",function(){for(var h=q(arguments),n=h[0],p=0;p<h.length;p++)n=Math.min(n,h[p]);return n},"Returns the lowest value in the list",["min(a,b,c...)","min(list)"]);o("sqrt",function(h){return Math.sqrt(h)},"Returns the square root of the given value",
"sqrt(x)");o("sort",function(){for(var h=q(arguments),n=[],p=0;p<h.length;p++)n.push(h[p]);return n.sort()},"Returns the list of values, sorted from lowest to highest",["sort(a,b,c...)","sort(list)"]);o("reverse",function(){for(var h=q(arguments),n=[],p=0;p<h.length;p++)n.unshift(h[p]);return n},"Reverses the order of the list of values",["reverse(a,b,c...)","reverse(list)"]);o("first",function(){return q(arguments)[0]},"Returns the first value in the list",["first(a,b,c...)","first(list)"]);o("last",
function(){var h=q(arguments);return h[h.length-1]},"Returns the last value in the list",["last(a,b,c...)","last(list)"]);o("at",function(h,n){return h[n]},"Returns the indexed value in the given list","at(list,index)");o("rand",function(h){return Math.random()*(h||1)},"Returns a random number between zero and the range specified, or one if no number is given","rand(x)");o("length",function(){return q(arguments).length},"Returns the number of arguments in the given list",["length(a,b,c...)","length(list)"]);
var z=function(h){for(var n=0,p=0;p<h.length;p++)if(h[p])n+=h[p];return n};o("mean",function(){var h=q(arguments);return z(h)/h.length},"Returns the average mean of the values in the list",["mean(a,b,c...)","mean(list)"]);o("median",function(){for(var h=q(arguments),n=[],p=0;p<h.length;p++)n.push(h[p]);n=n.sort();return n.length%2==1?n[Math.floor(n.length/2)]:(n[Math.round(n.length/2)]+n[Math.round(n.length/2)-1])/2},"Returns the media for the list of values",["median(a,b,c...)","media(list)"]);o("range",
function(){for(var h=q(arguments),n=[],p=0;p<h.length;p++)n.push(h[p]);n=n.sort();return n[n.length-1]-n[0]},"Returns the range for the list of values",["range(a,b,c...)","range(list)"]);o("count",function(){return q(arguments).length},"Returns the number of items in the list",["count(a,b,c...)","count(list)"]);o("sum",function(){return z(q(arguments))},"Returns the sum of the list of values",["sum(a,b,c...)","sum(list)"]);var u={},v=function(h){h=Math.max(parseInt(h),0);return h==0||h==1?1:h>170?
Infinity:u[h]?u[h]:h*v(h-1)};o("fact",function(h){return v(h)},"Returns the factorial of the given number","fact(n)");o("perm",function(h,n){return v(h)/v(h-n)},"Returns the permutation result for the given values","perm(n, k)");o("comb",function(h,n){return v(h)/(v(n)*v(h-n))},"Returns the combination result for the given values","comb(n, k)");o("ceil",function(h){return Math.ceil(h)},"Returns the ceiling for the given value","ceil(x)");o("floor",function(h){return Math.floor(h)},"Returns the floor for the given value",
"floor(x)");o("round",function(h){return Math.round(h)},"Returns the given value rounded to the nearest whole number","round(x)");o("e",function(h){return Math.exp(h||1)},"Returns the value for e","e()")})();
